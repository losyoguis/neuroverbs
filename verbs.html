<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VERBS ‚Ä¢ Conjugaciones (EN/ES) ‚Ä¢ Activa / Pasiva</title>

  <style>
    :root{
      --bg:#070a12;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);

      --orange:#f28b16;   /* C1 */
      --blue:#3b82f6;     /* C2 */
      --red:#ef4444;      /* C3 */
      --green:#22c55e;

      --shadow: 0 20px 45px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(242,139,22,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(900px 600px at 70% 110%, rgba(239,68,68,.20), transparent 55%),
        linear-gradient(180deg, #070a12 0%, #0b1220 65%, #070a12 100%);
      color:var(--text);
      min-height:100vh;
      padding: 16px;
    }

    .wrap{
      width:min(1100px, 96vw);
      margin: 0 auto;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding: 14px 14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(242,139,22,.18);
      border: 1px solid rgba(242,139,22,.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      font-size: 1.35rem;
    }
    .title h1{
      margin:0;
      font-size: clamp(18px, 3.2vw, 26px);
      letter-spacing:.3px;
      font-weight: 950;
      line-height: 1.05;
    }
    .title p{
      margin: 2px 0 0;
      color: var(--muted);
      font-weight: 650;
      font-size: .92rem;
    }

    .actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }

    .btn{
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      color: var(--text);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      transition: transform .08s ease, background .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ background: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: rgba(242,139,22,.18);
      border-color: rgba(242,139,22,.35);
    }
    .btn.primary:hover{ background: rgba(242,139,22,.26); }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
    }
    @media (max-width: 940px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .panel h2{
      margin:0 0 10px;
      font-size: 1.05rem;
      font-weight: 950;
      letter-spacing:.2px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-weight: 800;
      min-height: 46px;
    }
    input::placeholder{ color: rgba(255,255,255,.6); }

    .pillRow{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    .pill{
      flex: 1 1 170px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill.active{
      border-color: rgba(242,139,22,.38);
      background: rgba(242,139,22,.16);
    }

    .metaCard{
      margin-top:12px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(0,0,0,.18);
    }
    .metaTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .verbForms{
      font-weight: 950;
      font-size: 1.05rem;
      letter-spacing:.3px;
    }
    .verbForms .c1{ color: var(--orange); }
    .verbForms .c2{ color: var(--blue); }
    .verbForms .c3{ color: var(--red); }
    .verbMeaning{
      margin-top:4px;
      color: var(--muted);
      font-weight: 750;
    }

    .smallNote{
      margin-top:10px;
      color: rgba(255,255,255,.72);
      font-size: .9rem;
      line-height: 1.35;
    }

    .controls{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 700px){
      .controls{ grid-template-columns: 1fr; }
    }

    .toggle3{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tbtn{
      flex: 1 1 140px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 950;
      cursor:pointer;
      user-select:none;
    }
    .tbtn.active{
      border-color: rgba(59,130,246,.42);
      background: rgba(59,130,246,.18);
    }

    .tbtn.ok.active{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.18);
    }

    .tbtn.warn.active{
      border-color: rgba(242,139,22,.40);
      background: rgba(242,139,22,.16);
    }

    .audioRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.16);
    }
    .speedBox{
      flex: 1 1 260px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .speedLabel{
      font-weight: 900;
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .speedValue{
      font-weight: 950;
      color: var(--orange);
      min-width: 58px;
      text-align:right;
    }
    input[type="range"]{ width: 100%; }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      vertical-align: top;
    }
    th{
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: .72rem;
      color: rgba(255,255,255,.72);
      font-weight: 950;
      text-align:left;
    }
    tr:last-child td{ border-bottom:none; }

    td.pron{
      width: 90px;
      font-weight: 950;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    td.en .line{
      font-weight: 950;
      line-height: 1.25;
      padding-right: 44px;
      position: relative;
      min-height: 22px;
    }
    td.en .es{
      margin-top: 2px;
      font-style: italic;
      color: rgba(255,255,255,.78);
      font-weight: 700;
      font-size: .9rem;
    }

    .say{
      position:absolute;
      right:0; top:0;
      border:none;
      cursor:pointer;
      width:36px; height:28px;
      border-radius: 12px;
      color: var(--text);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 900;
    }
    .say:hover{ background: rgba(255,255,255,.18); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight: 900;
      color: rgba(255,255,255,.9);
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .chip b{ color: var(--orange); }

    .warnBox{
      margin-top: 10px;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(242,139,22,.30);
      background: rgba(242,139,22,.10);
      color: rgba(255,255,255,.92);
      font-weight: 750;
      line-height:1.35;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .85rem;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      padding: 2px 6px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üß†</div>
        <div class="title">
          <h1>VERBS ‚Ä¢ Conjugador EN/ES</h1>
          <p>Voz activa y pasiva ‚Ä¢ Presente simple, pasado simple y presente perfecto</p>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="index.html" title="Volver a la app principal">‚¨ÖÔ∏è Volver</a>
        <button class="btn primary" type="button" onclick="focusSearch()">üîé Buscar verbo</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: selector -->
      <section class="panel">
        <h2>1) Selecciona un verbo</h2>
        <div class="row" style="gap:12px;">
          <div style="flex: 1 1 360px;">
            <input id="search" list="verbsList" placeholder="Escribe: cut, go, eat‚Ä¶ (o en espa√±ol: cortar‚Ä¶)" />
            <datalist id="verbsList"></datalist>
          </div>
          <div style="flex: 0 0 220px; min-width:min(240px, 100%);">
            <button class="btn primary" style="width:100%; justify-content:center;" onclick="loadFromSearch()" type="button">Cargar ‚úÖ</button>
          </div>
        </div>

        <div class="metaCard" id="metaCard" style="display:none;">
          <div class="metaTop">
            <div>
              <div class="verbForms" id="verbForms"></div>
              <div class="verbMeaning" id="verbMeaning"></div>
            </div>
            <div class="chip" title="Modo y compatibilidad">
              <span>Modo:</span> <b id="voiceChip">Activa</b>
              <span style="opacity:.85;">‚Ä¢</span>
              <span id="passiveHint" style="opacity:.9;">Pasiva disponible ‚úÖ</span>
            </div>
          </div>

          <div class="pillRow">
            <div class="pill active" id="pillActive" onclick="setVoice('active')">VOZ ACTIVA</div>
            <div class="pill" id="pillPassive" onclick="setVoice('passive')">VOZ PASIVA</div>
          </div>

          <div class="controls">
            <div>
              <div style="font-weight:950; margin:2px 0 8px;">2) Tiempo</div>
              <div class="toggle3">
                <div class="tbtn warn active" id="tenseP" onclick="setTense('P')">PRESENTE</div>
                <div class="tbtn active" id="tenseS" onclick="setTense('S')">PASADO</div>
                <div class="tbtn active" id="tensePP" onclick="setTense('PP')">P. PERFECTO</div>
              </div>
            </div>

            <div>
              <div style="font-weight:950; margin:2px 0 8px;">3) Modo</div>
              <div class="toggle3">
                <div class="tbtn ok active" id="modeA" onclick="setMode('A')">Afirmativa</div>
                <div class="tbtn active" id="modeN" onclick="setMode('N')">Negativa</div>
                <div class="tbtn active" id="modeQ" onclick="setMode('Q')">Interrogativa</div>
              </div>
            </div>

            <div>
              <div style="font-weight:950; margin:2px 0 8px;">4) Opciones</div>
              <label class="chip" style="cursor:pointer; user-select:none;">
                <input id="agentToggle" type="checkbox" style="width:18px; height:18px; margin:0;" />
                <span>A√±adir agente: <span class="kbd">by someone</span> / <span class="kbd">por alguien</span></span>
              </label>
            </div>
          </div>

          <div class="audioRow">
            <div class="speedBox">
              <div class="speedLabel">üéß Velocidad:</div>
              <input id="rate" type="range" min="0.6" max="1.0" step="0.05" value="0.75" oninput="updateRateLabel()" />
              <div class="speedValue" id="rateLabel">0.75√ó</div>
            </div>
            <button class="btn" type="button" onclick="stopSpeak()">‚èπÔ∏è Stop</button>
          </div>

          <div class="smallNote" id="noteBox">
            Tip: En <b>voz pasiva</b>, el patr√≥n base es <b>BE + V3</b> (en espa√±ol: <b>ser + participio</b>).
          </div>

          <div class="warnBox" id="passiveGenerated" style="display:none;">
            ‚ö†Ô∏è Nota: la pasiva mostrada aqu√≠ se <b>genera autom√°ticamente</b> con reglas gramaticales (√∫til para estudiar).
            Si quieres una pasiva con contexto m√°s natural, luego la dejamos ‚Äú100% a tu estilo‚Äù cuando me env√≠es la versi√≥n final del verbo.
          </div>
        </div>

        <div class="smallNote" style="margin-top: 12px;">
          C√≥mo alimentar la base de datos:
          <br/>1) Abre este archivo y busca <span class="kbd">VERBS_DB</span>.
          <br/>2) Copia el bloque del verbo (como el de <b>CUT</b>) y agrega el siguiente.
        </div>
      </section>

      <!-- RIGHT: results -->
      <section class="panel">
        <h2 id="resultTitle">Conjugaciones</h2>
        <div id="result"></div>
      </section>
    </div>
  </div>

<script>
/* =========================================================
   ‚úÖ BASE DE DATOS (se alimenta con los bloques que env√≠as)
   - active: se carga EXACTAMENTE como lo env√≠as (EN/ES)
   - passive: por ahora se genera con reglas (BE + V3)
   ========================================================= */

const VERBS_DB = [
  {
    key: "cut",
    c1: "CUT",
    c2: "CUT",
    c3: "CUT",
    es: "Cortar",
    // ‚úÖ Conjugaciones ACTIVAS (exactas como las enviaste)
    active: {
      P: { // Present Simple
        A: [
          ["I", "I cut", "Yo corto"],
          ["YOU_S", "You cut", "T√∫ cortas"],
          ["HE", "He cuts", "√âl corta"],
          ["SHE", "She cuts", "Ella corta"],
          ["IT", "It cuts", "Eso corta"],
          ["WE", "We cut", "Nosotros cortamos"],
          ["YOU_P", "You cut", "Ustedes cortan"],
          ["THEY", "They cut", "Ellos cortan"]
        ],
        N: [
          ["I", "I don‚Äôt cut", "Yo no corto"],
          ["YOU_S", "You don‚Äôt cut", "T√∫ no cortas"],
          ["HE", "He doesn‚Äôt cut", "√âl no corta"],
          ["SHE", "She doesn‚Äôt cut", "Ella no corta"],
          ["IT", "It doesn‚Äôt cut", "Eso no corta"],
          ["WE", "We don‚Äôt cut", "Nosotros no cortamos"],
          ["YOU_P", "You don‚Äôt cut", "Ustedes no cortan"],
          ["THEY", "They don‚Äôt cut", "Ellos no cortan"]
        ],
        Q: [
          ["Do I cut?", "¬øYo corto?"],
          ["Do you cut?", "¬øT√∫ cortas?"],
          ["Does he cut?", "¬ø√âl corta?"],
          ["Does she cut?", "¬øElla corta?"],
          ["Does it cut?", "¬øEso corta?"],
          ["Do we cut?", "¬øNosotros cortamos?"],
          ["Do you cut?", "¬øUstedes cortan?"],
          ["Do they cut?", "¬øEllos cortan?"]
        ]
      },
      S: { // Past Simple
        A: [
          ["I", "I cut", "Yo cort√©"],
          ["YOU_S", "You cut", "T√∫ cortaste"],
          ["HE", "He cut", "√âl cort√≥"],
          ["SHE", "She cut", "Ella cort√≥"],
          ["IT", "It cut", "Eso cort√≥"],
          ["WE", "We cut", "Nosotros cortamos"],
          ["YOU_P", "You cut", "Ustedes cortaron"],
          ["THEY", "They cut", "Ellos cortaron"]
        ],
        N: [
          ["I", "I didn‚Äôt cut", "Yo no cort√©"],
          ["YOU_S", "You didn‚Äôt cut", "T√∫ no cortaste"],
          ["HE", "He didn‚Äôt cut", "√âl no cort√≥"],
          ["SHE", "She didn‚Äôt cut", "Ella no cort√≥"],
          ["IT", "It didn‚Äôt cut", "Eso no cort√≥"],
          ["WE", "We didn‚Äôt cut", "Nosotros no cortamos"],
          ["YOU_P", "You didn‚Äôt cut", "Ustedes no cortaron"],
          ["THEY", "They didn‚Äôt cut", "Ellos no cortaron"]
        ],
        Q: [
          ["Did I cut?", "¬øYo cort√©?"],
          ["Did you cut?", "¬øT√∫ cortaste?"],
          ["Did he cut?", "¬ø√âl cort√≥?"],
          ["Did she cut?", "¬øElla cort√≥?"],
          ["Did it cut?", "¬øEso cort√≥?"],
          ["Did we cut?", "¬øNosotros cortamos?"],
          ["Did you cut?", "¬øUstedes cortaron?"],
          ["Did they cut?", "¬øEllos cortaron?"]
        ]
      },
      PP: { // Present Perfect
        A: [
          ["I", "I have cut", "Yo he cortado"],
          ["YOU_S", "You have cut", "T√∫ has cortado"],
          ["HE", "He has cut", "√âl ha cortado"],
          ["SHE", "She has cut", "Ella ha cortado"],
          ["IT", "It has cut", "Eso ha cortado"],
          ["WE", "We have cut", "Nosotros hemos cortado"],
          ["YOU_P", "You have cut", "Ustedes han cortado"],
          ["THEY", "They have cut", "Ellos han cortado"]
        ],
        N: [
          ["I", "I haven‚Äôt cut", "Yo no he cortado"],
          ["YOU_S", "You haven‚Äôt cut", "T√∫ no has cortado"],
          ["HE", "He hasn‚Äôt cut", "√âl no ha cortado"],
          ["SHE", "She hasn‚Äôt cut", "Ella no ha cortado"],
          ["IT", "It hasn‚Äôt cut", "Eso no ha cortado"],
          ["WE", "We haven‚Äôt cut", "Nosotros no hemos cortado"],
          ["YOU_P", "You haven‚Äôt cut", "Ustedes no han cortado"],
          ["THEY", "They haven‚Äôt cut", "Ellos no han cortado"]
        ],
        Q: [
          ["Have I cut?", "¬øHe cortado?"],
          ["Have you cut?", "¬øHas cortado?"],
          ["Has he cut?", "¬ø√âl ha cortado?"],
          ["Has she cut?", "¬øElla ha cortado?"],
          ["Has it cut?", "¬øEso ha cortado?"],
          ["Have we cut?", "¬øHemos cortado?"],
          ["Have you cut?", "¬øHan cortado?"],
          ["Have they cut?", "¬øHan cortado?"]
        ]
      }
    }
  }
];

/* =========================
   ‚úÖ PRONOMBRES (para tabla)
   ========================= */
const PRON = [
  { key:"I",     label:"I",     esSubj:"Yo",      beP:"am",  beS:"was",  have:"have" },
  { key:"YOU_S", label:"You",   esSubj:"T√∫",      beP:"are", beS:"were", have:"have" },
  { key:"HE",    label:"He",    esSubj:"√âl",      beP:"is",  beS:"was",  have:"has"  },
  { key:"SHE",   label:"She",   esSubj:"Ella",    beP:"is",  beS:"was",  have:"has"  },
  { key:"IT",    label:"It",    esSubj:"Eso",     beP:"is",  beS:"was",  have:"has"  },
  { key:"WE",    label:"We",    esSubj:"Nosotros",beP:"are", beS:"were", have:"have" },
  { key:"YOU_P", label:"You",   esSubj:"Ustedes", beP:"are", beS:"were", have:"have" },
  { key:"THEY",  label:"They",  esSubj:"Ellos",   beP:"are", beS:"were", have:"have" }
];

const state = {
  verbKey: "cut",
  voice: "active", // active | passive
  tense: "P",      // P | S | PP
  mode: "A",       // A | N | Q
  rate: 0.75
};

let currentVerb = null;

/* =========================
   ‚úÖ INIT
   ========================= */
init();

function init(){
  // datalist
  const dl = document.getElementById("verbsList");
  dl.innerHTML = VERBS_DB.map(v => {
    const opts = [
      v.key,
      `${v.c1} ‚Äì ${v.c2} ‚Äì ${v.c3}`,
      v.es,
      `${v.key} (${v.es})`,
      `${v.c1} (${v.es})`
    ];
    // Datalist: 1 opci√≥n por verbo (pero ‚Äúvalue‚Äù amigable)
    return `<option value="${v.key}">${opts.join(" ‚Ä¢ ")}</option>`;
  }).join("");

  document.getElementById("search").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); loadFromSearch(); }
  });

  updateRateLabel();
  loadVerb(state.verbKey);
}

/* =========================
   ‚úÖ UI HELPERS
   ========================= */
function focusSearch(){
  const s = document.getElementById("search");
  s.focus();
  s.select?.();
}

function updateRateLabel(){
  const r = document.getElementById("rate");
  state.rate = Number(r.value || 0.75);
  document.getElementById("rateLabel").textContent = state.rate.toFixed(2) + "√ó";
}

function loadFromSearch(){
  const raw = (document.getElementById("search").value || "").trim();
  if(!raw) return;
  const key = normalizeKey(raw);

  // intenta encontrar por key (ingl√©s)
  let v = VERBS_DB.find(x => x.key === key);

  // intenta encontrar por infinitivo espa√±ol
  if(!v){
    const rawLow = raw.toLowerCase();
    v = VERBS_DB.find(x => (x.es || "").toLowerCase() === rawLow);
  }

  // intenta por C1
  if(!v){
    const up = raw.toUpperCase();
    v = VERBS_DB.find(x => (x.c1 || "").toUpperCase() === up);
  }

  if(!v){
    renderEmpty(`No encontr√© el verbo <b>${escapeHTML(raw)}</b> en la base de datos. (Por ahora solo est√° <b>cut</b>.)`);
    return;
  }

  loadVerb(v.key);
}

function normalizeKey(s){
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[‚Äì‚Äî-]/g, " ")
    .split(/\s+/)[0];
}

function escapeHTML(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   ‚úÖ STATE SETTERS
   ========================= */
function setVoice(v){
  state.voice = (v === "passive") ? "passive" : "active";
  document.getElementById("pillActive").classList.toggle("active", state.voice==="active");
  document.getElementById("pillPassive").classList.toggle("active", state.voice==="passive");
  document.getElementById("voiceChip").textContent = state.voice==="active" ? "Activa" : "Pasiva";
  render();
}

function setTense(t){
  state.tense = (t==="S"||t==="PP") ? t : "P";
  document.getElementById("tenseP").classList.toggle("active", state.tense==="P");
  document.getElementById("tenseS").classList.toggle("active", state.tense==="S");
  document.getElementById("tensePP").classList.toggle("active", state.tense==="PP");
  render();
}

function setMode(m){
  state.mode = (m==="N"||m==="Q") ? m : "A";
  document.getElementById("modeA").classList.toggle("active", state.mode==="A");
  document.getElementById("modeN").classList.toggle("active", state.mode==="N");
  document.getElementById("modeQ").classList.toggle("active", state.mode==="Q");
  render();
}

/* =========================
   ‚úÖ LOAD VERB
   ========================= */
function loadVerb(key){
  const v = VERBS_DB.find(x => x.key === key);
  if(!v){
    renderEmpty("No se encontr√≥ el verbo.");
    return;
  }
  currentVerb = v;
  state.verbKey = v.key;

  // show meta card
  document.getElementById("metaCard").style.display = "block";

  document.getElementById("verbForms").innerHTML =
    `<span class="c1">${escapeHTML(v.c1)}</span> ‚Äì <span class="c2">${escapeHTML(v.c2)}</span> ‚Äì <span class="c3">${escapeHTML(v.c3)}</span>`;
  document.getElementById("verbMeaning").textContent = `(${v.es})`;

  // Passive hint
  document.getElementById("passiveHint").textContent = "Pasiva disponible ‚úÖ";
  document.getElementById("passiveGenerated").style.display = "none"; // se muestra si entra a pasiva

  // reset search box to key
  document.getElementById("search").value = v.key;

  // defaults
  setVoice(state.voice);
  setTense(state.tense);
  setMode(state.mode);
  render();
}

/* =========================
   ‚úÖ RENDER
   ========================= */
function render(){
  if(!currentVerb){
    renderEmpty("Selecciona un verbo.");
    return;
  }

  const tenseTitle = (state.tense==="P") ? "PRESENTE SIMPLE"
                   : (state.tense==="S") ? "PASADO SIMPLE"
                   : "PRESENTE PERFECTO";

  const modeTitle = (state.mode==="A") ? "Afirmativa"
                  : (state.mode==="N") ? "Negativa"
                  : "Interrogativa";

  const voiceTitle = (state.voice==="active") ? "VOZ ACTIVA"
                   : "VOZ PASIVA";

  document.getElementById("resultTitle").textContent = `${voiceTitle} ‚Ä¢ ${tenseTitle} ‚Ä¢ ${modeTitle}`;

  const agent = document.getElementById("agentToggle").checked;

  if(state.voice==="active"){
    document.getElementById("passiveGenerated").style.display = "none";
    renderActive(currentVerb, state.tense, state.mode);
  }else{
    // por ahora: generador pasivo
    document.getElementById("passiveGenerated").style.display = "block";
    renderPassive(currentVerb, state.tense, state.mode, agent);
  }
}

function renderEmpty(html){
  document.getElementById("resultTitle").textContent = "Conjugaciones";
  document.getElementById("result").innerHTML =
    `<div class="warnBox">${html}</div>`;
}

/* =========================
   ‚úÖ ACTIVE (desde BD)
   ========================= */
function renderActive(v, tense, mode){
  const box = document.getElementById("result");

  const data = v.active?.[tense]?.[mode];
  if(!data){
    renderEmpty("No hay datos para este modo/tiempo.");
    return;
  }

  if(mode==="Q"){
    // Interrogatives (2 cols)
    const rows = data.map(([en, es]) => rowQ(en, es)).join("");
    box.innerHTML = `
      <table>
        <thead><tr><th>Ingl√©s</th><th>Espa√±ol</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    attachSayHandlers();
    return;
  }

  // A / N: Pronoun + EN + ES
  const rows = data.map(([pKey, en, es])=>{
    const p = PRON.find(x=>x.key===pKey);
    return rowPN(p?.label || "", en, es);
  }).join("");

  box.innerHTML = `
    <table>
      <thead><tr><th>Pronombre</th><th>Oraci√≥n</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
  attachSayHandlers();
}

/* =========================
   ‚úÖ PASSIVE (generador) ‚Äî AHORA CON OBJETO REAL (seg√∫n el verbo)
   - EN:  Object + BE + V3 (+ by agente)
   - ES:  Objeto + (es/fue/ha sido) + participio (+ por agente)
   ========================= */

/* Complementos (objeto del activo ‚Üí sujeto en pasiva) */
const COMPLEMENTS = {
  cut:   {en:"the paper", es:"el papel"},
  put:   {en:"the book", es:"el libro"},
  read:  {en:"the story", es:"la historia"},
  eat:   {en:"an apple", es:"una manzana"},
  drink: {en:"water", es:"agua"},
  write: {en:"a message", es:"un mensaje"},
  speak: {en:"English", es:"ingl√©s"},
  make:  {en:"a plan", es:"un plan"},
  take:  {en:"a photo", es:"una foto"},
  give:  {en:"a gift", es:"un regalo"},
  buy:   {en:"a notebook", es:"un cuaderno"},
  bring: {en:"the keys", es:"las llaves"},
  do:    {en:"the homework", es:"la tarea"},
  have:  {en:"a meeting", es:"una reuni√≥n"},
  open:  {en:"the door", es:"la puerta"},
  close: {en:"the door", es:"la puerta"}
};

const GENERIC_COMPLEMENTS = [
  {en:"the project", es:"el proyecto"},
  {en:"the lesson", es:"la lecci√≥n"},
  {en:"the plan", es:"el plan"},
  {en:"the message", es:"el mensaje"},
  {en:"the report", es:"el informe"},
  {en:"the document", es:"el documento"},
  {en:"the photo", es:"la foto"},
  {en:"the email", es:"el correo"},
  {en:"the door", es:"la puerta"},
  {en:"the keys", es:"las llaves"},
  {en:"the paper", es:"el papel"},
  {en:"the problem", es:"el problema"},
  {en:"the answer", es:"la respuesta"},
  {en:"the invitation", es:"la invitaci√≥n"},
  {en:"the gift", es:"el regalo"}
];

function hash32(str){
  let h = 2166136261;
  str = String(str||"");
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0);
}
function stablePick(list, seed){
  const arr = Array.isArray(list) ? list : [];
  if(!arr.length) return {en:"the project", es:"el proyecto"};
  return arr[hash32(seed) % arr.length];
}
function getComplementForVerb(v){
  const key = String(v?.key || v?.c1 || "").toLowerCase().trim();
  if(COMPLEMENTS[key]) return COMPLEMENTS[key];

  // Heur√≠sticas r√°pidas
  if(["write","send","text","email","reply"].includes(key)) return {en:"a message", es:"un mensaje"};
  if(["read","study"].includes(key)) return {en:"the story", es:"la historia"};
  if(["speak","say","tell","ask"].includes(key)) return {en:"the truth", es:"la verdad"};
  if(["make","build","create","do","prepare","plan"].includes(key)) return {en:"the project", es:"el proyecto"};
  if(["open","close","shut","lock","unlock"].includes(key)) return {en:"the door", es:"la puerta"};
  if(["take","bring","carry","fetch"].includes(key)) return {en:"the keys", es:"las llaves"};
  if(["give","offer","lend"].includes(key)) return {en:"a gift", es:"un regalo"};
  if(["buy","sell","pay"].includes(key)) return {en:"a ticket", es:"una entrada"};
  if(["eat","cook","bake"].includes(key)) return {en:"the food", es:"la comida"};
  if(["drink"].includes(key)) return {en:"water", es:"agua"};
  if(["cut","tear","fold"].includes(key)) return {en:"the paper", es:"el papel"};

  return stablePick(GENERIC_COMPLEMENTS, `${key}|${String(v?.es||"")}`);
}

/* Helpers */
function capFirst(s){
  const x = String(s||"").trim();
  if(!x) return x;
  return x.charAt(0).toUpperCase() + x.slice(1);
}
function lowerFirstIfArticle(np){
  const s = String(np||"").trim();
  if(/^The\b/.test(s)) return "the" + s.slice(3);
  if(/^A\b/.test(s)) return "a" + s.slice(1);
  if(/^An\b/.test(s)) return "an" + s.slice(2);
  return s;
}
function isProbablyPluralEN(np){
  const s = String(np||"").trim().toLowerCase();
  const last = s.split(/\s+/).pop() || "";
  if(["you","we","they"].includes(s)) return true;
  if(last.endsWith("ss")) return false;
  if(last.endsWith("s") && !last.endsWith("us") && !last.endsWith("is")) return true;
  return false;
}

/* Agentes: EN y ES */
const AGENT_EN = { I:"me", YOU_S:"you", HE:"him", SHE:"her", IT:"it", WE:"us", YOU_P:"you", THEY:"them" };
const AGENT_ES = { I:"m√≠", YOU_S:"ti", HE:"√©l", SHE:"ella", IT:"ello", WE:"nosotros", YOU_P:"ustedes", THEY:"ellos" };

/* Participios espa√±oles (irregulares comunes + fallback regular) */
const ES_IRREG_PART = {
  "abrir":"abierto",
  "cubrir":"cubierto",
  "decir":"dicho",
  "escribir":"escrito",
  "hacer":"hecho",
  "morir":"muerto",
  "poner":"puesto",
  "romper":"roto",
  "ver":"visto",
  "volver":"vuelto",
  "resolver":"resuelto",
  "imprimir":"impreso",
  "fre√≠r":"frito",
  "satisfacer":"satisfecho"
};
function esParticipleFromInf(inf){
  inf = String(inf||"").toLowerCase().trim();
  if(ES_IRREG_PART[inf]) return ES_IRREG_PART[inf];
  if(inf.endsWith("ar")) return inf.slice(0,-2) + "ado";
  if(inf.endsWith("er") || inf.endsWith("ir")) return inf.slice(0,-2) + "ido";
  return "hecho";
}
function parseObjES(objES){
  const s = String(objES||"").trim().toLowerCase();
  const first = (s.split(/\s+/)[0] || "");
  const fem = new Set(["la","las","una","unas","esta","estas","esa","esas","aquella","aquellas","mi","mis","tu","tus","su","sus","nuestra","nuestras"]);
  const masc = new Set(["el","los","un","unos","este","estos","ese","esos","aquel","aquellos","nuestro","nuestros"]);
  let gender = fem.has(first) ? "f" : masc.has(first) ? "m" : "m";
  let number = (["las","los","unas","unos","estas","estos","esas","esos","aquellas","aquellos","mis","tus","sus","nuestras","nuestros"].includes(first)) ? "pl" : "sg";
  if(number==="sg"){
    if(first.endsWith("s") || (s.endsWith("s") && !s.endsWith("√©s") && !s.endsWith("√∫s"))) number = "pl";
  }
  return {gender, number};
}
function agreePartES(part, gender, number){
  let p = String(part||"").trim().toLowerCase();
  if(!p) p = "hecho";
  if(gender==="f" && /o$/.test(p)) p = p.slice(0,-1) + "a";
  if(number==="pl" && !/s$/.test(p)) p = p + "s";
  return p;
}
function auxPassiveES(tense, number){
  const pl = (number==="pl");
  if(tense==="P") return pl ? "son" : "es";
  if(tense==="S") return pl ? "fueron" : "fue";
  return pl ? "han sido" : "ha sido";
}

/* Construcci√≥n de pasiva EN/ES */
function passiveEN(tense, mode, subjEN, v3, agentP, includeAgent){
  const plural = isProbablyPluralEN(subjEN);
  const beP = plural ? "are" : "is";
  const beS = plural ? "were" : "was";
  const have = plural ? "have" : "has";
  const by = includeAgent ? ` by ${AGENT_EN[agentP.key] || "them"}` : "";

  if(tense==="P"){
    if(mode==="A") return `${subjEN} ${beP} ${v3}${by}`;
    if(mode==="N") return `${subjEN} ${(beP==="is") ? "isn't" : "aren't"} ${v3}${by}`;
    return `${capFirst(beP)} ${lowerFirstIfArticle(subjEN)} ${v3}${by}?`;
  }
  if(tense==="S"){
    if(mode==="A") return `${subjEN} ${beS} ${v3}${by}`;
    if(mode==="N") return `${subjEN} ${(beS==="was") ? "wasn't" : "weren't"} ${v3}${by}`;
    return `${capFirst(beS)} ${lowerFirstIfArticle(subjEN)} ${v3}${by}?`;
  }
  // PP
  if(mode==="A") return `${subjEN} ${have} been ${v3}${by}`;
  if(mode==="N") return `${subjEN} ${(have==="has") ? "hasn't" : "haven't"} been ${v3}${by}`;
  return `${capFirst(have)} ${lowerFirstIfArticle(subjEN)} been ${v3}${by}?`;
}

function passiveES(tense, mode, objES, partES, agentP, includeAgent){
  const obj = String(objES||"la tarea").trim();
  const meta = parseObjES(obj);
  const aux = auxPassiveES(tense, meta.number);
  const by = includeAgent ? ` por ${AGENT_ES[agentP.key] || "ellos"}` : "";
  const lineCore = (mode==="A")
    ? `${obj} ${aux} ${partES}${by}`
    : (mode==="N")
      ? `${obj} no ${aux} ${partES}${by}`
      : `¬ø${obj} ${aux} ${partES}${by}?`;
  return lineCore.replace(/\s+/g," ").trim();
}

function renderPassive(v, tense, mode, includeAgent){
  const box = document.getElementById("result");
  const V3 = (v.c3 || "").trim();
  if(!V3){
    renderEmpty("Falta C3 para generar pasiva.");
    return;
  }

  const comp = getComplementForVerb(v);
  const subjEN = capFirst(comp.en);
  const objES = comp.es;

  // participio ES del infinitivo (v.es), con concordancia seg√∫n el objeto
  const basePart = esParticipleFromInf(v.es);
  const meta = parseObjES(objES);
  const partES = agreePartES(basePart, meta.gender, meta.number);

  const rows = PRON.map(agentP => {
    const en = passiveEN(tense, mode, subjEN, V3, agentP, includeAgent);
    const es = passiveES(tense, mode, objES, partES, agentP, includeAgent);
    return rowPN(agentP.label, en, es);
  }).join("");

  box.innerHTML = `
    <table>
      <thead><tr><th>Agente</th><th>Oraci√≥n</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
  attachSayHandlers();
}

document.getElementById("agentToggle").addEventListener("change", render);
</script>
</body>
</html>
