<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neuroaprendizaje de los Verbos Irregulares - Voz Activa / Voz Pasiva</title>
  <style>
    :root{
      --purple:#65116B;
      --orange:#F28B16;
      --blue:#2563eb; /* azul para C2 */
      --red:#ff3b30;  /* rojo para C3 */

      --c1: var(--orange);
      --c2: var(--blue);
      --c3: var(--red);

      --primary: var(--purple);
      --secondary: var(--orange);
      --accent: var(--orange);

      --bg: linear-gradient(135deg,#0b1220 0%, var(--purple) 100%);
      --success:#10b981;
      --error:#ef4444;
      --muted:#64748b;

      --secondaryHover:#d97706;
      --purpleDark:#4b0c50;

      /* ‚úÖ Espacio seguro superior para que los modales NO queden debajo del men√∫ de puntuaci√≥n */
      --hudSafe: 160px; /* se actualiza din√°micamente seg√∫n la altura real de la barra de puntuaci√≥n */
      --topSafe: 160px; /* legacy fallback */
      }

    html, body { height: 100%; }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
      background: var(--bg);
      margin:0; padding:20px; color:#0f172a;
      display:flex; flex-direction:column; align-items:center;
      position: relative;
    }

    body.has-floating-stats{
      padding-top: calc(var(--hudSafe, 160px) + 12px);
    }

    .app{
      max-width:1120px; width:100%;
      background:#fff; padding:26px;
      border-radius:26px;
      box-shadow:0 25px 50px rgba(0,0,0,.45);
    }

    .brand{
      background:#0b1220;
      border:2px solid var(--secondary);
      border-radius:20px;
      padding:18px 16px;
      margin-bottom:16px;
      color:#fff;
      text-align:center;
    }
    .brand h1{
      margin:0;
      font-size:1.35rem;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.25;
    }
    .brand .subtitle{
      margin-top:6px;
      font-size:1rem;
      font-weight:900;
      color:var(--accent);
    }
    .brand .by{
      margin-top:6px;
      font-size:.85rem;
      font-weight:850;
      color:#cbd5e1;
    }

    /* ‚úÖ‚úÖ‚úÖ BARRA DE PUNTOS: SIEMPRE VISIBLE (FIJA) */
    .stats{
      display:flex; justify-content:space-around;
      background:var(--secondary);
      color:#0b1220;
      padding:14px;
      border-radius:18px;
      margin:0;

      position: fixed !important;
      top: 12px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;

      width: min(1120px, calc(100% - 40px)) !important;

      /* ‚úÖ IMPORTANTE: que la barra NO tape los modales */
      z-index: 200 !important;
      box-shadow:0 18px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);

      pointer-events: auto;
      gap:10px;
      flex-wrap:wrap;
    }
    .stat-value{
      display:block;
      font-size:1.4rem;
      font-weight:900;
      color:#0b1220;
    }
    .stat-label{
      font-size:.7rem;
      text-transform:uppercase;
      color:rgba(11,18,32,.75);
      font-weight:950;
      letter-spacing:.2px;
    }

    /* ‚úÖ ROUND BUTTONS */
    .roundbar{
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin:0 0 12px;
    }
    .roundrow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      width:100%;
    }
    .roundbtn{
      border:none;
      cursor:pointer;
      font-weight:950;
      padding:12px 16px;
      border-radius:14px;
      background:#0b1220;
      color:#fff;
      border:2px solid rgba(255,255,255,.12);
      transition:.15s;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .roundbtn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.25);}
    /* ‚úÖ Ayudas por bot√≥n (tooltip) */
    .roundbtn[data-help]{ position:relative; }
    .roundbtn[data-help]::after{
      content: attr(data-help);
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(100% + 10px);
      background: rgba(15,23,42,.95);
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
      text-transform:none;
      letter-spacing:0;
      line-height:1.2;
      width:max-content;
      max-width:260px;
      box-shadow:0 12px 26px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition:.12s;
      z-index: 99999999;
      white-space: normal;
    }
    .roundbtn[data-help]::before{
      content:"";
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(100% + 4px);
      border:6px solid transparent;
      border-top-color: rgba(15,23,42,.95);
      opacity:0;
      pointer-events:none;
      transition:.12s;
      z-index: 99999999;
    }
    .roundbtn[data-help]:hover::after,
    .roundbtn[data-help]:hover::before,
    .roundbtn[data-help]:focus-visible::after,
    .roundbtn[data-help]:focus-visible::before{
      opacity:1;
    }
    .roundbtn.active{
      background:var(--secondary);
      color:#0b1220;
      border-color:var(--secondary);
    }
    .roundbtn.ebook{
      background:var(--secondary);
      color:#0b1220;
      border-color:var(--secondary);
    }
    .roundbtn.ebook:hover{transform:translateY(-1px); filter:brightness(1.02);}
    .roundbtn.web{
      background:#0b1220;
      color:#fff;
      border:2px solid rgba(255,255,255,.12);
    }
    .roundbtn.web:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.25);}
    .roundhint{
      font-weight:900;
      color:#cbd5e1;
      font-size:.85rem;
      letter-spacing:.2px;
    }

    /* ‚úÖ BOT√ìN FLOTANTE SIEMPRE VISIBLE (ABAJO) */
    .ebook-float{
      position: fixed;
      right: 14px;
      bottom: 14px;
      /* ‚úÖ Debe quedar por debajo de overlays/modales */
      z-index: 200;
      background: var(--secondary);
      color:#0b1220;
      border:2px solid rgba(0,0,0,.12);
      padding:12px 14px;
      border-radius:14px;
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:.2px;
      text-decoration:none;
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .ebook-float:hover{
      background: var(--secondaryHover);
      transform: translateY(-1px);
    }

    /* ‚úÖ Ajuste m√≥vil: baja el bot√≥n para que no tape las flechas */
    @media (max-width: 520px){
      .ebook-float{
        bottom: 4px;
        right: 10px;
        padding: 10px 12px;
        font-size: .78rem;
        border-radius: 12px;
      }
    }

    /* ‚úÖ Canva/Video embebido: m√°s bajo (no tan alto) */
    .canva-embed{
      position: relative;
      width: 100%;
      height: 56vh;           /* üëà ajusta aqu√≠ si lo quieres m√°s peque√±o */
      max-height: 520px;
      min-height: 320px;
      margin-top: 1rem;
      margin-bottom: .9rem;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16);
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
    }
    .canva-embed iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
    }

    .btn-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
    }

    .top{
      display:grid; grid-template-columns:1.7fr 1fr auto;
      gap:12px; margin-bottom:14px;
      background:#f1f5f9; padding:16px; border-radius:18px;
      align-items:end;
    }
    label{font-weight:800; font-size:.85rem; color:#0f172a;}
    select{
      padding:12px; border-radius:12px;
      border:2px solid #cbd5e1;
      font-weight:800; background:#fff; width:100%;
      cursor:pointer;
    }
    .btn-mini{
      background:var(--accent); color:#0b1220;
      border:none; padding:10px 14px;
      border-radius:12px; cursor:pointer; font-weight:950;
      white-space:nowrap;
    }

    .hint{
      background:#0b1220;
      border:2px solid var(--accent);
      color:#fff;
      padding:12px 14px;
      border-radius:16px;
      margin:0 0 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .hint-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .hint-badge{
      background:var(--accent);
      color:#0b1220;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      font-size:.8rem;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .hint-days{
      color:#cbd5e1;
      font-weight:850;
      font-size:.85rem;
      white-space:nowrap;
    }
    .hint ul{
      margin:0;
      padding-left:18px;
      color:#e5e7eb;
      font-weight:750;
      line-height:1.25rem;
    }
    .hint em{color:#fde68a; font-style:normal; font-weight:950;}

    .voiceChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-weight:950;
      color:#0b1220;
      background:var(--secondary);
      padding:8px 10px;
      border-radius:999px;
      align-self:flex-start;
      border:2px solid rgba(255,255,255,.12);
    }
    .voiceChip small{
      font-weight:950;
      background:#0b1220;
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      letter-spacing:.2px;
    }

    .exNote{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      background:#111827;
      border:2px dashed #fca5a5;
      color:#fee2e2;
      font-weight:900;
      display:none;
    }
    .exNote span{color:#fca5a5;}

    .target{
      text-align:center; font-size:3rem;
      font-weight:950; margin:6px 0 10px;
      color:var(--primary); text-transform:uppercase;
    }

    .inputs{
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:12px; margin-bottom:14px;
    }
    input{
      width:100%; padding:16px;
      border:3px solid #e2e8f0; border-radius:16px;
      text-align:center; font-size:1.2rem; font-weight:900;
      box-sizing:border-box;
    }
    input:focus{border-color:var(--secondary); outline:none; background:#f8fafc;}

    
    /* Fondo clarito por caj√≥n C1/C2/C3 */
    #c1{ background: rgba(255,149,0,.14); border-color: rgba(255,149,0,.40); }
    #c2{ background: rgba(0,122,255,.14); border-color: rgba(0,122,255,.40); }
    #c3{ background: rgba(255,59,48,.14); border-color: rgba(255,59,48,.40); }

    /* Color de fuente (igual que conjugaciones) */
    #c1{ color: rgb(255,149,0); }
    #c2{ color: rgb(0,122,255); }
    #c3{ color: rgb(255,59,48); }

    #c1::placeholder{ color: rgba(255,149,0,.85); }
    #c2::placeholder{ color: rgba(0,122,255,.85); }
    #c3::placeholder{ color: rgba(255,59,48,.85); }

    #c1:focus{ background: rgba(255,149,0,.20); border-color: rgba(255,149,0,.75); }
    #c2:focus{ background: rgba(0,122,255,.20); border-color: rgba(0,122,255,.75); }
    #c3:focus{ background: rgba(255,59,48,.20); border-color: rgba(255,59,48,.75); }

    .btn-main{
      background:var(--secondary); color:#0b1220;
      padding:16px; border-radius:16px;
      font-size:1.05rem; font-weight:950;
      border:none; width:100%;
      cursor:pointer; text-transform:uppercase;
      transition:.2s;
    }
    .btn-main:hover{background:var(--secondaryHover); transform:translateY(-1px);}

    .audio{
      display:flex; gap:10px; margin:14px 0 10px;
    }
    .btn-audio{
      flex:1; padding:14px; border-radius:14px;
      border:none; cursor:pointer; font-weight:950;
      color:#fff; transition:.15s;
    }
    .btn-a{background:var(--c1); color:#fff;}
    .btn-b{background:var(--c2); color:#fff;}
    .btn-c{background:var(--c3); color:#fff;}
.btn-audio:hover{transform:translateY(-1px); opacity:.95;}

    .nav{
      display:flex; justify-content:center; align-items:center;
      gap:18px; margin-top:6px;
    }
    .nav button{
      cursor:pointer; border:none; background:none; font-size:2rem;
    }
    #progreso{font-weight:900; color:var(--muted);}

    #msg{ text-align:center; margin-top:10px; font-weight:950; min-height:24px;}

    #master{margin-top:22px; display:none; border-top:4px solid var(--success); padding-top:16px;}
    .time-head{
      background:var(--primary); color:#fff;
      padding:10px; border-radius:12px;
      margin:18px 0 10px; text-align:center; font-weight:950;
    }
    .grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(min(340px, 100%), 1fr));
      gap:12px;
    }
    .card{
      background:#f8fafc; border:1px solid #e2e8f0;
      border-radius:16px; padding:14px;
    }
    .card strong{display:block; margin-bottom:8px;}
    table{width:100%; border-collapse:collapse;}
    td{
      padding:10px 6px; border-bottom:1px solid #e2e8f0;
      vertical-align:top;
    }
    th{
      text-align:left;
      padding:8px 6px;
      border-bottom:1px solid #cbd5e1;
      font-size:.72rem;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    td.pron-col{
      width:74px;
      font-weight:950;
      color:#0f172a;
    }
    td.en-col .en{
      display:block;
      margin:0;
      padding-right:46px; /* espacio para el bot√≥n üîä */
      line-height:1.25;
    }
    td.tr-col{
      color:var(--muted);
      font-style:italic;
      font-size:.88rem;
    }

    .en{font-weight:950;}
    .es{
      display:block; font-size:.86rem; color:var(--muted);
      font-style:italic; margin-top:2px;
    }
    /* ‚úÖ Colores por forma verbal */
    .v-c1{ color: var(--secondary); font-weight:950; } /* C1 Base (naranja) */
    .v-c2{ color: var(--blue); font-weight:950; }      /* C2 Past (azul) */
    .v-c3{ color: var(--error); font-weight:950; }     /* C3 Participle (rojo) */

    .btn-listen{
      background:#e2e8f0; border:none; border-radius:999px;
      padding:6px 10px; cursor:pointer; float:right;
      font-weight:900;
    }
    /* ‚úÖ Reading/Practice: bot√≥n üîä sin romper el flujo en m√≥vil */
    #readingArea .btn-listen, #practiceArea .btn-listen{
      float:none;
      position:absolute;
      right:10px;
      top:10px;
    }
    #readingArea td, #practiceArea td{
      position:relative;
      padding-right:54px;
    }

    .btn-listen:hover{background:var(--secondary); color:#0b1220;}
    .legend{font-size:.8rem; color:var(--muted); margin-top:8px;}

    .warn{
      background:#fff7ed;
      border:1px dashed #fed7aa;
      color:#9a3412;
      padding:12px 14px;
      border-radius:16px;
      font-weight:950;
      margin:10px 0 0;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      display:none;
      justify-content:center;
      align-items:flex-start;
      padding: 18px;
      padding-top: 24px;
      overflow:auto;
      z-index: 9999999 !important;
    }
    .modal{
      background:#fff;
      padding:22px;
      border-radius:18px;
      max-width:860px;
      width:92%;
      max-height: 88vh;
      overflow:auto;
      border:2px solid var(--secondary);
      box-shadow:0 25px 50px rgba(0,0,0,.45);
    }
    .modal h2{margin:0 0 10px; color:var(--primary); font-weight:950;}

    /* ‚úÖ Modales arriba (visibles sin subir) */
    #overlay, #reviewOverlay, #instOverlay, #ebookOverlay{
      align-items:flex-start !important;
      padding: 18px !important;
      padding-top: 24px !important;
    }
    #overlay .modal, #reviewOverlay .modal, #instOverlay .modal{
      margin-top: 0 !important;
      max-height: 88vh !important;
    }



    /* ‚úÖ Cuando un modal est√° abierto, bajamos la prioridad del HUD (barra de puntuaci√≥n y bot√≥n flotante)
       para que NUNCA tape el contenido del modal (especialmente en Google Sites). */
    body.modal-open .stats,
    body.modal-open .ebook-float{
      pointer-events: none !important;
      opacity: .18 !important;
      filter: blur(.6px);
    }

    .motivation-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      z-index: 9999998 !important;
      display:none;
    }
    .motivation{
      position:fixed;
      inset:0;
      z-index: 10000000 !important;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      overflow:auto;
    }
    .motivation-card{
      max-width:760px;
      width:100%;
      background:#0b1220;
      border:2px solid var(--secondary);
      border-radius:18px;
      box-shadow:0 25px 50px rgba(0,0,0,.55);
      color:#fff;
      padding:18px 18px 16px;
      animation: pop .18s ease-out;
      position:relative;
      max-height: 88vh;
      overflow:auto;
    }
    @keyframes pop{
      from{transform:scale(.96); opacity:0;}
      to{transform:scale(1); opacity:1;}
    }
    .motivation-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .motivation-badge{
      background:var(--secondary);
      color:#0b1220;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .motivation-x{
      position:absolute;
      top:10px;
      right:10px;
      width:38px;
      height:38px;
      border-radius:12px;
      border:2px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-size:18px;
      font-weight:950;
      cursor:pointer;
      line-height:34px;
      text-align:center;
    }
    .motivation-x:hover{
      background:rgba(255,255,255,.12);
      border-color:rgba(255,255,255,.28);
    }
    .motivation-lines{
      display:grid;
      gap:8px;
      margin-top:8px;
    }
    .motivation-en{
      font-weight:950;
      color:#e5e7eb;
      font-size:1.05rem;
      line-height:1.35rem;
    }
    .motivation-es{
      font-weight:900;
      color:#cbd5e1;
      font-size:1rem;
      line-height:1.35rem;
    }
    .motivation-verb{
      color:var(--secondary);
      font-weight:950;
    }
    .motivation-action{
      display:flex;
      justify-content:flex-end;
      margin-top:14px;
    }
    .btn-conjugar{
      background:var(--secondary);
      color:#0b1220;
      border:none;
      padding:12px 16px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .btn-conjugar:hover{filter:brightness(1.05);}

    .practice-head{
      background:#0b1220;
      color:#fff;
      padding:12px 14px;
      border-radius:16px;
      border:2px solid var(--secondary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin:18px 0 10px;
    }
    .practice-title{
      font-weight:950;
      letter-spacing:.2px;
    }
    .practice-badge{
      background:var(--secondary);
      color:#0b1220;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .practice-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(min(320px, 100%), 1fr));
      gap:12px;
    }
    .p-card{
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:16px;
      padding:14px;
    }
    .p-q{
      font-weight:950;
      margin-bottom:10px;
      color:#0f172a;
      line-height:1.25rem;
    }
    .p-sub{
      color:var(--muted);
      font-weight:850;
      font-size:.86rem;
      margin-top:6px;
    }
    .p-actions{
      display:flex;
      gap:10px;
      margin-top:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .p-btn{
      background:var(--secondary);
      color:#0b1220;
      border:none;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
    }
    .p-btn:hover{background:var(--secondaryHover);}
    .p-msg{
      font-weight:950;
      min-height:22px;
    }
    .p-input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:2px solid #cbd5e1;
      font-weight:900;
      text-align:center;
      box-sizing:border-box;
      background:#fff;
    }
    .p-select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:2px solid #cbd5e1;
      font-weight:900;
      background:#fff;
      cursor:pointer;
      box-sizing:border-box;
    }
    .p-divider{
      margin:14px 0 6px;
      padding:10px 12px;
      border-radius:14px;
      background:#fff7ed;
      border:1px dashed #fed7aa;
      color:#9a3412;
      font-weight:950;
    }
    /* ===========================
       üéÆ GAMIFICACI√ìN PRO (Yoguis)
       =========================== */
    .statBox{
      min-width: 112px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:6px 8px;
      border-radius:14px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(11,18,32,.15);
    }
    .statBox .stat-value{font-size:1.15rem;}
    .statBox .stat-label{font-size:.68rem;}

    .heartsText{
      font-size:1.05rem;
      letter-spacing:1px;
      white-space:nowrap;
      line-height:1.05rem;
    }
    .goalBox{
      flex: 1 1 320px;
      min-width: 260px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(11,18,32,.15);
      padding:10px 12px;
      border-radius:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .goalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:950;
    }
    .goalLabel{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.25px;
      color:rgba(11,18,32,.75);
    }
    .goalValue{
      font-size:.8rem;
      font-weight:950;
      color:#0b1220;
      background:rgba(255,255,255,.35);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .goalBar{
      height:12px;
      border-radius:999px;
      background:rgba(11,18,32,.18);
      overflow:hidden;
      border:1px solid rgba(11,18,32,.18);
    }
    .goalFill{
      height:100%;
      width:0%;
      background:#0b1220;
      border-radius:999px;
      transition: width .25s ease;
    }

    .masteryRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin:-2px 0 12px;
      flex-wrap:wrap;
    }
    .masteryLabel{
      font-weight:950;
      color:#0b1220;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      padding:6px 10px;
      border-radius:999px;
      font-size:.8rem;
    }
    .masteryStars{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:#0b1220;
      border:2px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:950;
      letter-spacing:.3px;
      font-size:.85rem;
    }

    /* Toast de logros */
    .achieve{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      z-index:2147483647;
      display:none;
      max-width:min(820px, calc(100% - 40px));
      width:fit-content;
    }
    .achieve-card{
      background:#0b1220;
      color:#fff;
      border:2px solid var(--secondary);
      border-radius:18px;
      box-shadow:0 25px 50px rgba(0,0,0,.55);
      padding:14px 14px 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      animation: pop .18s ease-out;
    }
    .achieve-ico{
      width:42px;
      height:42px;
      border-radius:14px;
      background:var(--secondary);
      color:#0b1220;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:950;
      flex:0 0 auto;
    }
    .achieve-title{
      font-weight:950;
      letter-spacing:.2px;
      margin:0;
      line-height:1.1rem;
    }
    .achieve-desc{
      margin:4px 0 0;
      color:#cbd5e1;
      font-weight:850;
      line-height:1.2rem;
      font-size:.92rem;
    }

    /* Modal Review */
    .review-list{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .review-item{
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .review-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .review-verb{
      font-weight:950;
      color:#0b1220;
      letter-spacing:.2px;
    }
    .review-meta{
      font-weight:850;
      color:var(--muted);
      font-size:.86rem;
    }
    .review-btn{
      background:var(--secondary);
      color:#0b1220;
      border:none;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
      white-space:nowrap;
    }
    .review-btn:hover{background:var(--secondaryHover);}

  

    /* =========================
       üêù SPELLING BEE (DELETREO C1/C2/C3)
       ========================= */
    .spellWrap{
      background: radial-gradient(800px 400px at 20% 0%, rgba(242,139,22,.22), transparent 60%),
                  radial-gradient(700px 380px at 100% 10%, rgba(101,17,107,.22), transparent 60%),
                  linear-gradient(180deg, rgba(17,28,51,.98), rgba(2,6,23,.98));
      border:2px solid rgba(242,139,22,.55);
      border-radius:22px;
      padding:18px 18px 16px;
      box-shadow:0 24px 55px rgba(0,0,0,.45);
      margin: 16px 0 14px;
    }
    .spellHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .spellTitle{
      font-size:22px;
      font-weight:1000;
      letter-spacing:-.02em;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
      color:#fff;
      text-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .spellSub{
      color: rgba(226,232,240,.85);
      font-weight:850;
      margin-top:6px;
      line-height:1.35rem;
    }
    .spellTopRow{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      margin: 12px 0 16px;
    }
    .spellESP{
      flex: 0 0 220px;
      min-width: 180px;
      font-size:44px;
      font-weight:1000;
      letter-spacing:.02em;
      color:var(--primary);
      text-transform:uppercase;
    }

    .spellESPBlock{
      flex: 0 0 240px;
      min-width: 200px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-start;
    }
    .spellWork{
      flex: 1 1 360px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(242,139,22,.22);
      border-radius:18px;
      padding:14px 16px;
      font-weight:950;
      color:#e2e8f0;
    }
    .spellWork b{ color:#fff; }
    .spellGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(min(220px, 100%), 1fr));
      gap:14px;
    }
    @media (max-width: 900px){
      .spellGrid{ grid-template-columns: 1fr; }
      .spellESP{ font-size:34px; }
    }
    .spellCard{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(242,139,22,.22);
      border-radius:18px;
      padding:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .spellLabel{
      font-weight:1000;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#cbd5e1;
      margin-bottom:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .spellPicker{
      display:grid;
      grid-template-columns: 56px 1fr 56px;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }
    .spellArrow{
      border:none;
      cursor:pointer;
      border-radius:16px;
      height:56px;
      width:56px;
      background: rgba(242,139,22,.28);
      border: 1px solid rgba(242,139,22,.40);
      color:#fff;
      font-size:24px;
      font-weight:1000;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
    }
    .spellVal{
      height:56px;
      border-radius:18px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:30px;
      font-weight:1000;
      color:#fff;
      text-transform:lowercase;
    }
    .spellSpeak{
      width:100%;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      font-weight:950;
      border-radius:999px;
      padding:12px 14px;
      cursor:pointer;
    }
    .spellSpeak:hover{ filter:brightness(1.05); }
    .spellActions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .spellFeedback{
      font-weight:950;
      color:#e2e8f0;
      opacity:.95;
      min-height:24px;
    }
    .spellValidate{
      flex: 1 1 340px;
      background: var(--primary);
      color:#0b1220;
      font-weight:1000;
      border:none;
      border-radius:18px;
      padding:16px 18px;
      cursor:pointer;
      box-shadow:0 16px 34px rgba(0,0,0,.35);
      text-transform:uppercase;
      letter-spacing:.5px;
      min-width:260px;
    }
    .spellValidate:hover{ filter:brightness(1.03); transform: translateY(-1px); }


    /* ‚úÖ Colores neuro para C1/C2/C3 (Spelling Bee) */
    .spellGrid .spellCard:nth-child(1) .spellLabel{ color: var(--c1); }
    .spellGrid .spellCard:nth-child(2) .spellLabel{ color: var(--c2); }
    .spellGrid .spellCard:nth-child(3) .spellLabel{ color: var(--c3); }

    .spellGrid .spellCard:nth-child(1){ border-color: rgba(242,139,22,.32); }
    .spellGrid .spellCard:nth-child(2){ border-color: rgba(37,99,235,.30); }
    .spellGrid .spellCard:nth-child(3){ border-color: rgba(255,59,48,.30); }

    .spellGrid .spellCard:nth-child(1) .spellArrow{ background: rgba(242,139,22,.26); border:1px solid rgba(242,139,22,.42); }
    .spellGrid .spellCard:nth-child(2) .spellArrow{ background: rgba(37,99,235,.22); border:1px solid rgba(37,99,235,.40); }
    .spellGrid .spellCard:nth-child(3) .spellArrow{ background: rgba(255,59,48,.18); border:1px solid rgba(255,59,48,.38); }

    .spellGrid .spellCard:nth-child(1) .spellVal{ border-color: rgba(242,139,22,.30); color: var(--c1); }
    .spellGrid .spellCard:nth-child(2) .spellVal{ border-color: rgba(37,99,235,.28); color: var(--c2); }
    .spellGrid .spellCard:nth-child(3) .spellVal{ border-color: rgba(255,59,48,.26); color: var(--c3); }

  
    /* =========================
       Tooltips (HUD)
       ========================= */
    .statBox[data-tip], .goalBox[data-tip]{
      position: relative;
      cursor: help;
      transition: transform .12s ease, filter .12s ease;
    }
    .statBox[data-tip]:hover, .goalBox[data-tip]:hover{
      transform: translateY(-1px);
      filter: brightness(1.02);
    }
    .statBox[data-tip]::after,
    .goalBox[data-tip]::after{
      content: attr(data-tip);
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top: calc(100% + 10px);
      background: rgba(15,23,42,.96);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      font-weight:900;
      line-height:1.25rem;
      white-space: normal;
      max-width: min(360px, 80vw);
      box-shadow: 0 16px 34px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      opacity:0;
      pointer-events:none;
      z-index: 2147483646; /* encima de todo el HUD */
    }
    .statBox[data-tip]::before,
    .goalBox[data-tip]::before{
      content:"";
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top: calc(100% + 2px);
      width: 10px;
      height: 10px;
      background: rgba(15,23,42,.96);
      border-left:1px solid rgba(255,255,255,.12);
      border-top:1px solid rgba(255,255,255,.12);
      transform: translateX(-50%) rotate(45deg);
      opacity:0;
      pointer-events:none;
      z-index: 2147483646;
    }
    .statBox[data-tip]:hover::after,
    .goalBox[data-tip]:hover::after,
    .statBox[data-tip]:hover::before,
    .goalBox[data-tip]:hover::before{
      opacity:1;
    }
    @media (hover: none){
      .statBox[data-tip]::after,
      .goalBox[data-tip]::after,
      .statBox[data-tip]::before,
      .goalBox[data-tip]::before{
        display:none; /* evita tooltips pegajosos en m√≥vil */
      }
      .statBox[data-tip], .goalBox[data-tip]{ cursor: default; }
    }

  
    /* ===== HUD palette upgrade (override) ===== */

    /* ===== HUD palette upgrade (override) ===== */
    .stats{
      background: linear-gradient(135deg,
        rgba(245,158,11,.96) 0%,
        rgba(249,115,22,.92) 45%,
        rgba(124,58,237,.55) 100%) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
    }
    .statBox{
      background: rgba(255,255,255,.22) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.22) !important;
    }
    .stat-label{
      color: rgba(11,18,32,.78) !important;
    }
    .stat-value{
      color: #0b1220 !important;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .goalBox{
      background: rgba(255,255,255,.22) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
    }
    .goalBar{
      background: rgba(11,18,32,.18) !important;
      border: 1px solid rgba(255,255,255,.16) !important;
    }
    .goalFill{
      background: linear-gradient(90deg, rgba(11,18,32,.98), rgba(124,58,237,.90)) !important;
    }
    .goalValue{
      background: rgba(255,255,255,.32) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
    }
  
  
    /* ‚úÖ Imagen del verbo (debajo del t√≠tulo) */
    .verbIllustrationWrap{
      display:flex;
      justify-content:center;
      margin: 10px 0 6px;
    }
    .verbIllustration{
      width: min(420px, 92%);
      border-radius: 18px;
      overflow:hidden;
      border: 2px solid rgba(242,139,22,.35);
      box-shadow: 0 16px 34px rgba(0,0,0,.35);
      background: linear-gradient(135deg, rgba(101,17,107,.18), rgba(242,139,22,.12));
    }
    .verbIllustration svg{ display:block; width:100%; height:auto; }
    /* ‚úÖ Foto/imagen impactante por verbo */
    .verbIllustration img{
      display:block;
      width:100%;
      height:240px;
      object-fit:cover;
      filter: saturate(1.08) contrast(1.05);
      transform: scale(1.01);
    }
    .verbCaption{
      position:absolute;
      left:12px;
      bottom:10px;
      right:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-end;
      pointer-events:none;
    }
    .verbTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(11,18,32,.68);
      border:1px solid rgba(255,255,255,.16);
      color:#fff;
      font-weight:950;
      letter-spacing:.2px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .verbTag small{ font-weight:900; opacity:.85; }
    .verbIllustrationInner{
      position:relative;
      width:100%;
      height:240px;
    }


    /* ‚úÖ‚úÖ‚úÖ RESPONSIVE M√ìVIL (estilo "app") */
    @media (max-width: 640px){
      /* ‚úÖ Ajustes extra responsive (Reading/Practice) */
      #readingArea table, #practiceArea table{ width:100%; }
      #readingArea td, #practiceArea td{ word-break:break-word; }
      #readingArea .btn-listen, #practiceArea .btn-listen{
        width:38px; height:38px; font-size:18px;
      }
      #readingArea .en{ font-size:1.06rem; line-height:1.35; }
      #readingArea .es{ font-size:.92rem; margin-top:6px; }

      /* Contenedor principal */
      .app{
        padding: 14px;
        border-radius: 18px;
      }

      /* Barra de puntos: compacta + desplazable horizontal */
      .stats{
        top: calc(env(safe-area-inset-top, 0px) + 8px) !important;
        width: calc(100% - 18px) !important;
        padding: 10px 10px;
        gap: 8px;
        border-radius: 16px;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }
      .stats::-webkit-scrollbar{ display:none; }
      .statBox{
        min-width: 96px;
        padding: 6px 8px;
        scroll-snap-align: start;
      }
      .stat-label{ font-size:.72rem; }
      .stat-value{ font-size:1.05rem; }

      /* Men√∫ de botones: 3 filas centradas */
      .roundbar{
        overflow: visible;
        justify-content: center;
        padding-bottom: 0;
        gap: 10px;
      }
      .roundbtn{
        padding: 10px 12px;
        border-radius: 13px;
        font-size: .8rem;
        white-space: nowrap;
        scroll-snap-align: start;
      }

      /* Selecci√≥n de grupo/d√≠a */
      .top{
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .btn-mini{
        width: 100%;
      }

      /* Texto principal */
      .target{
        font-size: 2.15rem;
      }

      /* Inputs: evitar zoom iOS + m√°s c√≥modos */
      input{
        font-size: 16px;
        padding: 14px;
      }
      .inputs{
        grid-template-columns: 1fr;
      }

      /* Botones de audio: 2 por fila */
      .audio{
        flex-wrap: wrap;
      }
      .btn-audio{
        flex: 1 1 calc(50% - 10px);
        min-height: 48px;
      }

      /* Modales: m√°s ancho √∫til */
      .modal{
        width: 96%;
        padding: 16px;
        border-radius: 16px;
      }

      /* Bot√≥n flotante: m√°s peque√±o */
      .ebook-float{
        right: 12px;
        bottom: 12px;
        padding: 10px 12px;
        border-radius: 13px;
        font-size: .78rem;
      }
    }

    @media (max-width: 420px){
      .target{ font-size: 1.95rem; }
      .statBox{ min-width: 88px; }
      .roundbtn{ font-size: .78rem; padding: 10px 11px; }
    }

    /* Mejoras t√°ctiles */
    @media (hover: none){
      .roundbtn, .btn-main, .btn-audio, .btn-mini, .ebook-float{
        -webkit-tap-highlight-color: transparent;
      }
    }

  </style>
</head>

<body class="has-floating-stats">

  <!-- ‚úÖ‚úÖ‚úÖ BARRA DE PUNTOS FUERA DE .app -->
  
  <div class="stats" id="statsBar">
    <div class="statBox" data-tip="üî• D√≠as seguidos practicando. Si fallas o faltas, puede bajar (Freeze te protege)."><span class="stat-label">Racha</span><span class="stat-value" id="streak">0</span></div>
    <div class="statBox" data-tip="‚≠ê Puntos acumulados por respuestas correctas en la app."><span class="stat-label">Total XP</span><span class="stat-value" id="xp">0</span></div>
    <div class="statBox" data-tip="üéØ Porcentaje de aciertos: correctas √∑ intentos."><span class="stat-label">Precisi√≥n</span><span class="stat-value" id="acc">100%</span></div>

    <div class="statBox" data-tip="üß¨ Subes de nivel cada 250 XP (aprox.)."><span class="stat-label">Nivel</span><span class="stat-value" id="level">1</span></div>
    <div class="statBox" data-tip="‚ù§Ô∏è Intentos disponibles. Un error consume 1. Se recuperan con el tiempo."><span class="stat-label">Vidas</span><span class="stat-value heartsText" id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    <div class="statBox" data-tip="üßä Protege tu racha cuando fallas o faltas. Se gana por hitos de racha."><span class="stat-label">Freeze</span><span class="stat-value" id="freeze">0</span></div>

    <div class="goalBox" data-tip="üìÖ Objetivo de XP del d√≠a. Completa la meta para crear h√°bito y mantener el ritmo." aria-label="Meta diaria">
      <div class="goalTop">
        <span class="goalLabel">Meta diaria</span>
        <span class="goalValue" id="dailyGoalText">0/200</span>
      </div>
      <div class="goalBar"><div class="goalFill" id="dailyGoalFill"></div></div>
    </div>
  </div>


  <!-- ‚úÖ‚úÖ‚úÖ BOT√ìN INFERIOR SIEMPRE VISIBLE: ASISTENTE IA -->
  <a class="ebook-float" href="https://chatgpt.com/g/g-688f92ef15e88191a178208283c76eb6-neuro-aprendizaje-de-los-verbos-irregulares" target="_blank" rel="noopener">ASISTENTE IA ü§ñ</a>


  <div class="motivation-backdrop" id="motivationBackdrop"></div>

  <div class="motivation" id="motivationToast" role="dialog" aria-live="polite" aria-modal="true">
    <div class="motivation-card">
      <button class="motivation-x" type="button" onclick="hideMotivation()">‚úï</button>
      <div class="motivation-top">
        <span class="motivation-badge">üî• ¬°Conexi√≥n exitosa!</span>
        <span style="color:#cbd5e1;font-weight:900;">Siguiente paso: <b>CONJUGAR</b></span>
      </div>
      <div class="motivation-lines">
        <div class="motivation-en" id="motivationEN"></div>
        <div class="motivation-es" id="motivationES"></div>
      </div>
      <div class="motivation-action">
        <button class="btn-conjugar" type="button" onclick="conjugarDesdeModal()">CONJUGAR ‚úÖ</button>
      </div>
    </div>
  </div>

  <div class="app">

    <div class="brand">
      <h1>Neuroaprendizaje de los Verbos Irregulares</h1>
      <div class="subtitle">‚ÄúAprende 180 verbos en 80 d√≠as‚Äù</div>
      <div class="by">Dise√±ado por <b>Spelling Yoguis Bee</b></div>
    </div>

    <div class="roundbar">

      <!-- ‚úÖ FILA 1: INSTRUCCIONES + E-BOOK + WEB -->
      <div class="roundrow">
        <button class="roundbtn" type="button" onclick="abrirInstrucciones()"
          data-help="Gu√≠a r√°pida: c√≥mo usar la app paso a paso."
          title="Gu√≠a r√°pida: c√≥mo usar la app paso a paso.">INSTRUCCIONES üìå</button>

        <button class="roundbtn ebook" type="button" onclick="abrirEbook()"
          data-help="Abre el e-book (Canva) dentro de la app."
          title="Abre el e-book (Canva) dentro de la app.">E-BOOK üìö</button>
</div>

      <!-- ‚úÖ FILA 2: ROUND 1 + ROUND 2 + VOZ ACTIVA + VOZ PASIVA -->
      <div class="roundrow">
        <button id="btnRound1" class="roundbtn active" type="button" onclick="setRound(1)" data-help="Round 1: Pronombre + Verbo (sin complemento). Cambia el modo de pr√°ctica." title="Round 1: Pronombre + Verbo (sin complemento).">Round 1</button>
        <button id="btnRound2" class="roundbtn" type="button" onclick="setRound(2)" data-help="Round 2: Pronombre + Verbo + Complemento. Cambia el modo de pr√°ctica." title="Round 2: Pronombre + Verbo + Complemento.">Round 2</button>
</div>

      <!-- ‚úÖ FILA 3: REVIEW (CENTRADO) -->
      <div class="roundrow">
        <button class="roundbtn" type="button" onclick="abrirReview()" data-help="Review: repasa y gana XP extra con retos." title="Review: repasa y gana XP extra con retos.">REVIEW üß©</button>
      </div>

      <!-- Hint -->
      <div class="roundrow">
        <span class="roundhint" id="roundHint">Round 1: oraciones b√°sicas</span>
      </div>

    </div>

    <div class="top">
      <div>
        <label>Grupo</label>
        <select id="sel-grupo" onchange="actualizarDias()"></select>
      </div>
      <div>
        <label>D√≠a</label>
        <select id="sel-dia" onchange="cargarDia()"></select>
      </div>
      <button class="btn-mini" onclick="abrirAyuda()">RED NEURONAL üß†</button>
    </div>

    <div class="hint" id="pistaBox">
      <div class="hint-top">
        <span class="hint-badge" id="pistaTitulo">üß† Pista Neuronal</span>
        <span class="hint-days" id="pistaDias"></span>
      </div>

      <div class="voiceChip" id="voiceChip">
        <span>Modo:</span> <small id="voiceModeLabel">Voz Activa</small>
        <span style="opacity:.85;font-weight:950" id="voiceModeMiniHint">Sujeto ‚Üí Verbo ‚Üí Complemento</span>
      </div>

      <ul id="pistaLista"></ul>
      <div class="exNote" id="exNote"><span>‚ö† EXCEPCI√ìN:</span> <span id="exText"></span></div>
    </div>

    <div class="target" id="verbo-esp">...</div>

    <!-- ‚úÖ Imagen asociada al verbo (cambia con el verbo actual) -->
    <div class="verbIllustrationWrap">
      <div class="verbIllustration" id="verbIllustration" aria-label="Imagen del verbo"></div>
    </div>




    <div class="inputs">
      <input id="c1" placeholder="BASE (C1)" autocomplete="off" />
      <input id="c2" placeholder="PASADO (C2)" autocomplete="off" />
      <input id="c3" placeholder="PARTICIPIO (C3)" autocomplete="off" />
    </div>

    <div class="audio" aria-label="Ayudas de pronunciaci√≥n">
      <button class="btn-audio btn-a" type="button" onclick="hablarC1()"
        data-help="Escucha la pronunciaci√≥n del verbo en C1 (Base)."
        title="Escucha la pronunciaci√≥n del verbo en C1 (Base).">üîä LISTENING C1</button>
      <button class="btn-audio btn-b" type="button" onclick="hablarC2()"
        data-help="Escucha la pronunciaci√≥n del verbo en C2 (Pasado)."
        title="Escucha la pronunciaci√≥n del verbo en C2 (Pasado).">üîä LISTENING C2</button>
      <button class="btn-audio btn-c" type="button" onclick="hablarC3()"
        data-help="Escucha la pronunciaci√≥n del verbo en C3 (Participio)."
        title="Escucha la pronunciaci√≥n del verbo en C3 (Participio).">üîä LISTENING C3</button>
</div>
<button class="btn-main" onclick="validar()">CONECTAR NEURONAS</button>
    <div id="msg"></div>

    <div class="nav" id="readingNav" style="margin-top:18px; display:none;">
      <button onclick="cambiar(-1)">‚¨ÖÔ∏è</button>
      <span id="progreso2" style="font-weight:900; color:var(--muted);">0 de 0</span>
      <button onclick="cambiar(1)">‚û°Ô∏è</button>
    </div>


    <div id="master">
      

    <!-- ‚úÖ Voz Activa / Voz Pasiva (al inicio de la secci√≥n de conjugaciones) -->
    <div class="roundrow voiceRowInTables" style="margin: 8px 0 14px 0;">
      <button id="btnActive" class="roundbtn active" type="button" onclick="setVoice('active')"
        data-help="Voz activa: el sujeto realiza la acci√≥n."
        title="Voz activa: el sujeto realiza la acci√≥n.">VOZ ACTIVA</button>
      <button id="btnPassive" class="roundbtn" type="button" onclick="setVoice('passive')"
        data-help="Voz pasiva: el sujeto recibe la acci√≥n."
        title="Voz pasiva: el sujeto recibe la acci√≥n.">VOZ PASIVA</button>
    </div>

    
      <div id="tablas"></div>
      <div id="spellingArea"></div>
      <div id="practiceArea"></div>
      <div id="readingArea"></div>
    </div>

    

    <footer style="margin-top:18px; padding-top:14px; border-top:1px dashed #cbd5e1; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:center;">

      <div class="nav" id="readingNavFooter" style="margin-top:0; display:none;">
        <button onclick="cambiar(-1)" aria-label="Anterior">‚¨ÖÔ∏è</button>
        <span id="progreso2Footer" style="font-weight:900; color:var(--muted);">0 de 0</span>
        <button onclick="cambiar(1)" aria-label="Siguiente">‚û°Ô∏è</button>
      </div>

      <div style="flex-basis:100%; height:0;"></div>

<button class="roundbtn web" type="button" onclick="abrirWeb()"
        title="Abre el sitio web SmartEbook (Google Sites) en una pesta√±a nueva.">Neuroaprendizaje del Ingl√©s üåê</button>
    </footer>

  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2>üß† Red neuronal del d√≠a</h2>
      <div id="ayuda"></div>
      <button class="btn-main" style="margin-top:14px" onclick="cerrarAyuda()">ASOCIAR ‚úÖ</button>
    </div>
  </div>

    <!-- ‚úÖ MODAL: INSTRUCCIONES -->
  <div class="overlay" id="instOverlay" style="display:none;">
    <div class="modal modal-top">
      <h2 style="margin-bottom:10px;">üìå Instrucciones</h2>

      <div style="color:#0f172a; font-weight:850; line-height:1.45rem;">
        <ol style="margin:0; padding-left:18px;">
          <li style="margin-bottom:12px;"><b>Primero:</b> lee el <b>E-book</b> antes de empezar para entender el m√©todo de neuroaprendizaje. 
            <a href="https://www.canva.com/design/DAGiaYgaOxs/RMCSehA1T8Sm35n6gK9lnQ/view" target="_blank" rel="noopener" style="font-weight:950;color:var(--primary);text-decoration:underline;">Abrir e-book en Canva ‚ÜóÔ∏è</a></li>
          <li style="margin-bottom:12px;"><b>Elige Round:</b> Round 1 (b√°sico) o Round 2 (con complemento).</li>
          <li style="margin-bottom:12px;"><b>Selecciona Grupo y D√≠a</b> para cargar la lista del reto.</li>
          <li style="margin-bottom:12px;"><b>Conjuga:</b> escribe C1/C2/C3 y pulsa <b>Conectar Neuronas</b>.</li>
          <li style="margin-bottom:12px;"><b>Al acertar:</b> abre <b>Tablas</b> + <b>Practice</b> + <b>Reading</b> y suma XP.</li>
          <li style="margin-bottom:0;"><b>Audio:</b> usa üîä para escuchar y mejorar pronunciaci√≥n.</li>
        </ol>

        <div style="margin-top:16px; background:#fff7ed; border:1px dashed #fdba74; border-radius:16px; padding:14px 16px;">
          <div style="font-weight:950; color:#7c2d12; font-size:1.05rem;">üü† Tip: practica 3 verbos diarios en Round 2 para fijarlos con contexto.</div>
        </div>

        <button class="btn-main" style="margin-top:16px; width:100%;" onclick="cerrarInstrucciones()">ENTENDIDO ‚úÖ</button>
      </div>
    </div>
  </div>


  <!-- ‚úÖ MODAL: E-BOOK (Canva) -->
  <div class="overlay" id="ebookOverlay" style="display:none;">
    <div class="modal modal-top">
      <h2 style="margin-bottom:10px;">üìö E-book (Canva)</h2>

      <a class="btn-main btn-link" href="https://www.canva.com/design/DAGiaYgaOxs/RMCSehA1T8Sm35n6gK9lnQ/view" target="_blank" rel="noopener" style="width:100%; margin-top:8px; background:#0b1220; color:#fff; border:2px solid rgba(0,0,0,.12);">ABRIR EN CANVA ‚ÜóÔ∏è</a>

<div class="canva-embed">
        <iframe loading="lazy"
          src="https://www.canva.com/design/DAGiaYgaOxs/RMCSehA1T8Sm35n6gK9lnQ/view?embed"
          allowfullscreen="allowfullscreen" allow="fullscreen">
        </iframe>
      </div>

      <button class="btn-main" style="margin-top:14px; width:100%;" onclick="cerrarEbook()">CERRAR ‚úñÔ∏è</button>
    </div>
  </div>

  <!-- ‚úÖ MODAL: REVIEW (errores recientes) -->
  <div class="overlay" id="reviewOverlay">
    <div class="modal">
      <h2>üß© Review ‚Äî Errores recientes</h2>
      <div style="color:#334155;font-weight:850;line-height:1.35rem;">
        Aqu√≠ ves tus √∫ltimos errores para volverlos a intentar (Duolingo-style). 
        <br/>Tip: corrige primero los que m√°s se repiten.
      </div>

      <div class="review-list" id="reviewList"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;justify-content:flex-end;">
        <button class="btn-main" style="width:auto;padding:12px 14px;" type="button" onclick="limpiarReview()">LIMPIAR üßπ</button>
        <button class="btn-main" style="width:auto;padding:12px 14px;" type="button" onclick="cerrarReview()">CERRAR ‚úÖ</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   ‚úÖ HINTS (se mantienen)
   =========================== */
const GROUP_HINTS = {
  1: {
    title: "üß† Round 1 - Group 1",
    days: "Day 1 to 8",
    bullets: [
      "El patr√≥n que se repite es que el verbo es de <em>una s√≠laba</em> y termina en <em>t</em> o <em>d</em>.",
      "Familia verbal: el infinitivo, el pasado y el participio <em>son los mismos</em> (C1=C2=C3)."
    ]
  },
  2: {
    title: "üß† Round 1 - Group 2",
    days: "Day 9 to 25",
    bullets: [
      "Familia verbal: el pasado y el participio <em>son los mismos</em> (C2=C3)."
    ]
  },
  3: {
    title: "üß† Round 1 - Group 3",
    days: "Day 26 to 40",
    bullets: [
      "Familia verbal: el infinitivo, el pasado y el participio <em>son diferentes</em> (C1‚â†C2‚â†C3)."
    ]
  }
};

function renderGroupHint(groupId){
  const titulo = document.getElementById("pistaTitulo");
  const dias = document.getElementById("pistaDias");
  const lista = document.getElementById("pistaLista");

  const h = GROUP_HINTS[groupId] || null;

  if(!h){
    titulo.textContent = "üß† Pista Neuronal";
    dias.textContent = "";
    lista.innerHTML = "";
    return;
  }

  const roundTitle = (currentRound===2)
    ? h.title.replace("Round 1","Round 2")
    : h.title;

  const roundDays = (currentRound===2)
    ? h.days.replace(/Day\s+(\d+)\s+to\s+(\d+)/i, (_,a,b)=>`Day ${Number(a)+40} to ${Number(b)+40}`)
    : h.days;

  titulo.textContent = roundTitle;
  dias.textContent = roundDays;
  lista.innerHTML = h.bullets.map(b=>`<li>${b}</li>`).join("");
}

/* ‚úÖ‚úÖ‚úÖ Refuerzo: barra fija */

/* ‚úÖ‚úÖ‚úÖ Altura segura para modales (se ajusta al alto real de la barra fija) */
function updateHudSafe(){
  const bar = document.getElementById("statsBar");
  if(!bar) return;
  const r = bar.getBoundingClientRect();
  const safe = Math.max(0, Math.ceil(r.bottom + 12)); // deja un peque√±o margen debajo
  document.documentElement.style.setProperty("--hudSafe", safe + "px");
}
function pinStatsBar(){
  const bar = document.getElementById("statsBar");
  if(!bar) return;

  if(bar.parentElement !== document.body){
    document.body.prepend(bar);
  }

  bar.style.position = "fixed";
  bar.style.top = "12px";
  bar.style.left = "50%";
  bar.style.transform = "translateX(-50%)";
  bar.style.zIndex = "900";
  bar.style.width = "min(1120px, calc(100% - 40px))";
  updateHudSafe();
}

/* ===========================
   ‚úÖ SONIDOS
   =========================== */
let __audioCtx = null;

function getAudioCtx(){
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx) return null;
  if(!__audioCtx) __audioCtx = new Ctx();
  if(__audioCtx.state === "suspended"){
    __audioCtx.resume().catch(()=>{});
  }
  return __audioCtx;
}

function playTone(freq, ms, type="sine", vol=0.10, when=0){
  const ctx = getAudioCtx();
  if(!ctx) return;

  const now = ctx.currentTime + when;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = type;
  osc.frequency.setValueAtTime(freq, now);

  gain.gain.setValueAtTime(0.0001, now);
  gain.gain.exponentialRampToValueAtTime(vol, now + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + ms/1000);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start(now);
  osc.stop(now + ms/1000 + 0.02);
}

function playCorrectSound(){
  playTone(660, 90, "triangle", 0.11, 0.00);
  playTone(880, 120, "triangle", 0.12, 0.09);
}

function playWrongSound(){
  playTone(220, 120, "sawtooth", 0.06, 0.00);
  playTone(160, 180, "sawtooth", 0.06, 0.10);
}

/* ===========================
   ‚úÖ DATA (igual, Round 1)
   =========================== */
const verbosDB = [
  {g:1, d:1, esp:"Cortar", c1:"cut", c2:"cut", c3:"cut"},
  {g:1, d:1, esp:"Poner", c1:"put", c2:"put", c3:"put"},
  {g:1, d:2, esp:"Golpear", c1:"beat", c2:"beat", c3:"beat", alt3:["beaten"], ex:"El participio tambi√©n puede ser 'beaten'."},
  {g:1, d:2, esp:"Sudar", c1:"sweat", c2:"sweat", c3:"sweat"},
  {g:1, d:3, esp:"Sentarse", c1:"sit", c2:"sat", c3:"sat", ex:"*Excepci√≥n: no cumple C1=C2=C3 (sit‚Äìsat‚Äìsat)."},
  {g:1, d:3, esp:"Comer", c1:"eat", c2:"ate", c3:"eaten", ex:"*Excepci√≥n: no cumple C1=C2=C3 (eat‚Äìate‚Äìeaten)."},
  {g:1, d:4, esp:"Apostar", c1:"bet", c2:"bet", c3:"bet"},
  {g:1, d:4, esp:"Dejar", c1:"let", c2:"let", c3:"let"},
  {g:1, d:4, esp:"Fijar", c1:"set", c2:"set", c3:"set"},
  {g:1, d:4, esp:"Mojar", c1:"wet", c2:"wet", c3:"wet"},
  {g:1, d:5, esp:"Herir", c1:"hurt", c2:"hurt", c3:"hurt"},
  {g:1, d:5, esp:"Cerrar", c1:"shut", c2:"shut", c3:"shut"},
  {g:1, d:5, esp:"Reventar", c1:"burst", c2:"burst", c3:"burst"},
  {g:1, d:5, esp:"Empujar", c1:"thrust", c2:"thrust", c3:"thrust"},
  {g:1, d:6, esp:"Costar", c1:"cost", c2:"cost", c3:"cost"},
  {g:1, d:6, esp:"Arrojar", c1:"cast", c2:"cast", c3:"cast"},
  {g:1, d:6, esp:"Transmitir", c1:"broadcast", c2:"broadcast", c3:"broadcast"},
  {g:1, d:6, esp:"Predecir", c1:"forecast", c2:"forecast", c3:"forecast"},
  {g:1, d:7, esp:"Caber", c1:"fit", c2:"fit", c3:"fit"},
  {g:1, d:7, esp:"Golpear", c1:"hit", c2:"hit", c3:"hit"},
  {g:1, d:7, esp:"Rajar", c1:"slit", c2:"slit", c3:"slit"},
  {g:1, d:7, esp:"Escupir", c1:"spit", c2:"spit", c3:"spit", alt2:["spat"], alt3:["spat"], ex:"Tambi√©n se acepta 'spat' en pasado y participio (spit‚Äìspat‚Äìspat)."},
  {g:1, d:7, esp:"Dividir", c1:"split", c2:"split", c3:"split"},
  {g:1, d:7, esp:"Abandonar", c1:"quit", c2:"quit", c3:"quit"},
  {g:1, d:7, esp:"Tejer", c1:"knit", c2:"knit", c3:"knit"},
  {g:1, d:8, esp:"Pujar", c1:"bid", c2:"bid", c3:"bid"},
  {g:1, d:8, esp:"Librar", c1:"rid", c2:"rid", c3:"rid"},
  {g:1, d:8, esp:"Leer", c1:"read", c2:"read", c3:"read", ex:"Pronunciaci√≥n: en presente suena /riÀêd/ (reed) y en pasado /r…õd/ (red)."},
  {g:1, d:8, esp:"Extender", c1:"spread", c2:"spread", c3:"spread"},
  {g:1, d:8, esp:"Guiar", c1:"lead", c2:"led", c3:"led", ex:"*Excepci√≥n: no cumple C1=C2=C3 (lead‚Äìled‚Äìled)."},

  {g:2, d:9, esp:"Pararse", c1:"stand", c2:"stood", c3:"stood"},
  {g:2, d:9, esp:"Entender", c1:"understand", c2:"understood", c3:"understood"},
  {g:2, d:9, esp:"Sobresalir", c1:"overstand", c2:"overstood", c3:"overstood"},
  {g:2, d:9, esp:"Resistir", c1:"withstand", c2:"withstood", c3:"withstood"},

  {g:2, d:10, esp:"Doblar", c1:"bend", c2:"bent", c3:"bent"},
  {g:2, d:10, esp:"Mezclar", c1:"blend", c2:"blent", c3:"blent", ex:"Tambi√©n se acepta 'blended' en pasado/participio (blend‚Äìblended‚Äìblended) en algunos contextos.", alt2:["blended"], alt3:["blended"]},
  {g:2, d:10, esp:"Prestar", c1:"lend", c2:"lent", c3:"lent"},
  {g:2, d:10, esp:"Enviar", c1:"send", c2:"sent", c3:"sent"},
  {g:2, d:10, esp:"Gastar", c1:"spend", c2:"spent", c3:"spent"},

  {g:2, d:11, esp:"Atar", c1:"bind", c2:"bound", c3:"bound"},
  {g:2, d:11, esp:"Desatar", c1:"unbind", c2:"unbound", c3:"unbound"},
  {g:2, d:11, esp:"Encontrar", c1:"find", c2:"found", c3:"found"},
  {g:2, d:11, esp:"Moler", c1:"grind", c2:"ground", c3:"ground"},
  {g:2, d:11, esp:"Enrollar", c1:"wind", c2:"wound", c3:"wound"},
  {g:2, d:11, esp:"Desenrollar", c1:"unwind", c2:"unwound", c3:"unwound"},

  {g:2, d:12, esp:"Aferrarse", c1:"cling", c2:"clung", c3:"clung"},
  {g:2, d:12, esp:"Picar", c1:"sting", c2:"stung", c3:"stung"},
  {g:2, d:12, esp:"Columpiarse", c1:"swing", c2:"swung", c3:"swung"},
  {g:2, d:12, esp:"Exprimir", c1:"wring", c2:"wrung", c3:"wrung"},
  {g:2, d:12, esp:"Colgar", c1:"hang", c2:"hung", c3:"hung"},

  {g:2, d:13, esp:"Sostener", c1:"hold", c2:"held", c3:"held"},
  {g:2, d:13, esp:"Contemplar", c1:"behold", c2:"beheld", c3:"beheld"},
  {g:2, d:13, esp:"Defender", c1:"uphold", c2:"upheld", c3:"upheld"},
  {g:2, d:13, esp:"Retener", c1:"withhold", c2:"withheld", c3:"withheld"},

  {g:2, d:14, esp:"Vender", c1:"sell", c2:"sold", c3:"sold"},
  {g:2, d:14, esp:"Decir", c1:"tell", c2:"told", c3:"told"},
  {g:2, d:14, esp:"Deletrear", c1:"spell", c2:"spelt", c3:"spelt", ex:"En ingl√©s americano es com√∫n 'spelled' como pasado/participio (spell‚Äìspelled‚Äìspelled).", alt2:["spelled"], alt3:["spelled"]},
  {g:2, d:14, esp:"Oler", c1:"smell", c2:"smelt", c3:"smelt", ex:"En ingl√©s americano es com√∫n 'smelled' como pasado/participio (smell‚Äìsmelled‚Äìsmelled).", alt2:["smelled"], alt3:["smelled"]},

  {g:2, d:15, esp:"O√≠r", c1:"hear", c2:"heard", c3:"heard"},
  {g:2, d:15, esp:"Guiar", c1:"lead", c2:"led", c3:"led"},

  {g:2, d:16, esp:"Decir", c1:"say", c2:"said", c3:"said"},
  {g:2, d:16, esp:"Pagar", c1:"pay", c2:"paid", c3:"paid"},
  {g:2, d:16, esp:"Apoyar", c1:"lay", c2:"laid", c3:"laid"},
  {g:2, d:16, esp:"Embutir", c1:"inlay", c2:"inlaid", c3:"inlaid"},
  {g:2, d:16, esp:"Quedarse", c1:"stay", c2:"stayed", c3:"stayed"},
  {g:2, d:16, esp:"Jugar", c1:"play", c2:"played", c3:"played"},

  {g:2, d:17, esp:"Apoyarse", c1:"lean", c2:"leant", c3:"leant", ex:"En ingl√©s americano es com√∫n 'leaned' como pasado/participio (lean‚Äìleaned‚Äìleaned).", alt2:["leaned"], alt3:["leaned"]},
  {g:2, d:17, esp:"Aprender", c1:"learn", c2:"learnt", c3:"learnt", ex:"En ingl√©s americano es com√∫n 'learned' como pasado/participio (learn‚Äìlearned‚Äìlearned).", alt2:["learned"], alt3:["learned"]},
  {g:2, d:17, esp:"Significar", c1:"mean", c2:"meant", c3:"meant"},
  {g:2, d:17, esp:"So√±ar", c1:"dream", c2:"dreamt", c3:"dreamt", ex:"En ingl√©s americano es com√∫n 'dreamed' como pasado/participio (dream‚Äìdreamed‚Äìdreamed).", alt2:["dreamed"], alt3:["dreamed"]},
  {g:2, d:17, esp:"Brincar", c1:"leap", c2:"leapt", c3:"leapt", ex:"En ingl√©s americano tambi√©n se usa 'leaped' (leap‚Äìleaped‚Äìleaped).", alt2:["leaped"], alt3:["leaped"]},
  {g:2, d:17, esp:"Negociar", c1:"deal", c2:"dealt", c3:"dealt"},

  {g:2, d:18, esp:"Sangrar", c1:"bleed", c2:"bled", c3:"bled"},
  {g:2, d:18, esp:"Criar", c1:"breed", c2:"bred", c3:"bred"},
  {g:2, d:18, esp:"Alimentar", c1:"feed", c2:"fed", c3:"fed"},
  {g:2, d:18, esp:"Acelerar", c1:"speed", c2:"sped", c3:"sped", ex:"En ingl√©s americano tambi√©n se usa 'speeded' (speed‚Äìspeeded‚Äìspeeded).", alt2:["speeded"], alt3:["speeded"]},
  {g:2, d:18, esp:"Huir", c1:"flee", c2:"fled", c3:"fled"},

  {g:2, d:19, esp:"Arrastrarse", c1:"creep", c2:"crept", c3:"crept"},
  {g:2, d:19, esp:"Guardar", c1:"keep", c2:"kept", c3:"kept"},
  {g:2, d:19, esp:"Dormir", c1:"sleep", c2:"slept", c3:"slept"},
  {g:2, d:19, esp:"Barrer", c1:"sweep", c2:"swept", c3:"swept"},
  {g:2, d:19, esp:"Llorar", c1:"weep", c2:"wept", c3:"wept"},

  {g:2, d:20, esp:"Sentir", c1:"feel", c2:"felt", c3:"felt"},
  {g:2, d:20, esp:"Arrodillarse", c1:"kneel", c2:"knelt", c3:"knelt", ex:"Tambi√©n se usa 'kneeled' (kneel‚Äìkneeled‚Äìkneeled).", alt2:["kneeled"], alt3:["kneeled"]},
  {g:2, d:20, esp:"Encontrar", c1:"meet", c2:"met", c3:"met"},

  {g:2, d:21, esp:"Cavar", c1:"dig", c2:"dug", c3:"dug"},
  {g:2, d:21, esp:"Escabullirse", c1:"slink", c2:"slunk", c3:"slunk"},
  {g:2, d:21, esp:"Pegar", c1:"stick", c2:"stuck", c3:"stuck"},
  {g:2, d:21, esp:"Atacar", c1:"strike", c2:"struck", c3:"struck"},
  {g:2, d:21, esp:"Girar", c1:"spin", c2:"spun", c3:"spun"},
  {g:2, d:21, esp:"Ganar", c1:"win", c2:"won", c3:"won"},
  {g:2, d:21, esp:"Brillar", c1:"shine", c2:"shone", c3:"shone", ex:"En ingl√©s americano tambi√©n se usa 'shined'.", alt2:["shined"], alt3:["shined"]},

  {g:2, d:22, esp:"Ense√±ar", c1:"teach", c2:"taught", c3:"taught"},
  {g:2, d:22, esp:"Coger", c1:"catch", c2:"caught", c3:"caught"},

  {g:2, d:23, esp:"Comprar", c1:"buy", c2:"bought", c3:"bought"},
  {g:2, d:23, esp:"Traer", c1:"bring", c2:"brought", c3:"brought"},
  {g:2, d:23, esp:"Pensar", c1:"think", c2:"thought", c3:"thought"},
  {g:2, d:23, esp:"Luchar", c1:"fight", c2:"fought", c3:"fought"},
  {g:2, d:23, esp:"Buscar", c1:"seek", c2:"sought", c3:"sought"},

  {g:2, d:24, esp:"Perder", c1:"lose", c2:"lost", c3:"lost"},
  {g:2, d:24, esp:"Disparar", c1:"shoot", c2:"shot", c3:"shot"},

  {g:2, d:25, esp:"Despertarse", c1:"awake", c2:"awoke", c3:"awoken"},
  {g:2, d:25, esp:"Construir", c1:"build", c2:"built", c3:"built"},
  {g:2, d:25, esp:"Quemar", c1:"burn", c2:"burnt", c3:"burnt", ex:"En ingl√©s americano es com√∫n 'burned'.", alt2:["burned"], alt3:["burned"]},
  {g:2, d:25, esp:"Salir", c1:"leave", c2:"left", c3:"left"},
  {g:2, d:25, esp:"Encender", c1:"light", c2:"lit", c3:"lit", ex:"Tambi√©n se usa 'lighted'.", alt2:["lighted"], alt3:["lighted"]},
  {g:2, d:25, esp:"Hacer", c1:"make", c2:"made", c3:"made"},
  {g:2, d:25, esp:"Resbalar", c1:"slide", c2:"slid", c3:"slid"},
  {g:2, d:25, esp:"Derramar", c1:"spill", c2:"spilt", c3:"spilt", ex:"En ingl√©s americano es com√∫n 'spilled'.", alt2:["spilled"], alt3:["spilled"]},
  {g:2, d:25, esp:"Estropear", c1:"spoil", c2:"spoilt", c3:"spoilt", ex:"En ingl√©s americano es com√∫n 'spoiled'.", alt2:["spoiled"], alt3:["spoiled"]},
  {g:2, d:25, esp:"Coser", c1:"sew", c2:"sewed", c3:"sewed", ex:"El participio tambi√©n puede ser 'sewn'.", alt3:["sewn"]},
  {g:2, d:25, esp:"Sembrar", c1:"sow", c2:"sowed", c3:"sowed", ex:"El participio tambi√©n puede ser 'sown'.", alt3:["sown"]},
  {g:2, d:25, esp:"Mostrar", c1:"show", c2:"showed", c3:"shown"},
  {g:2, d:25, esp:"Haber/Tener", c1:"have", c2:"had", c3:"had"},

  {g:3, d:26, esp:"Obtener", c1:"get", c2:"got", c3:"gotten", ex:"En ingl√©s brit√°nico es com√∫n 'got' como participio.", alt3:["got"]},
  {g:3, d:26, esp:"Olvidar", c1:"forget", c2:"forgot", c3:"forgotten"},
  {g:3, d:27, esp:"Dar", c1:"give", c2:"gave", c3:"given"},
  {g:3, d:27, esp:"Perdonar", c1:"forgive", c2:"forgave", c3:"forgiven"},
  {g:3, d:27, esp:"Prohibir", c1:"forbid", c2:"forbade", c3:"forbidden"},
  {g:3, d:28, esp:"Ver", c1:"see", c2:"saw", c3:"seen"},
  {g:3, d:28, esp:"Prever", c1:"foresee", c2:"foresaw", c3:"foreseen"},
  {g:3, d:28, esp:"Supervisar", c1:"oversee", c2:"oversaw", c3:"overseen"},
  {g:3, d:29, esp:"Venir", c1:"come", c2:"came", c3:"come"},
  {g:3, d:29, esp:"Llegar a ser", c1:"become", c2:"became", c3:"become"},
  {g:3, d:29, esp:"Superar", c1:"overcome", c2:"overcame", c3:"overcome"},
  {g:3, d:30, esp:"Tomar", c1:"take", c2:"took", c3:"taken"},
  {g:3, d:30, esp:"Equivocar", c1:"mistake", c2:"mistook", c3:"mistaken"},
  {g:3, d:30, esp:"Emprender", c1:"undertake", c2:"mistook", c3:"undergone"},
  {g:3, d:30, esp:"Participar", c1:"partake", c2:"partook", c3:"partaken"},
  {g:3, d:30, esp:"Sacudir", c1:"shake", c2:"shook", c3:"shaken"},
  {g:3, d:31, esp:"Sonar", c1:"ring", c2:"rang", c3:"rung"},
  {g:3, d:31, esp:"Cantar", c1:"sing", c2:"sang", c3:"sung"},
  {g:3, d:31, esp:"Saltar", c1:"spring", c2:"sprang", c3:"sprung"},
  {g:3, d:31, esp:"Empezar", c1:"begin", c2:"began", c3:"begun"},
  {g:3, d:32, esp:"Correr", c1:"run", c2:"ran", c3:"run"},
  {g:3, d:32, esp:"Nadar", c1:"swim", c2:"swam", c3:"swum"},
  {g:3, d:33, esp:"Beber", c1:"drink", c2:"drank", c3:"drunk"},
  {g:3, d:33, esp:"Hundir", c1:"sink", c2:"sank", c3:"sunk"},
  {g:3, d:33, esp:"Apestar", c1:"stink", c2:"stank", c3:"stunk", ex:"Tambi√©n existe 'stank/stunk' en algunos listados.", alt2:["stunk"]},
  {g:3, d:33, esp:"Encoger", c1:"shrink", c2:"shrank", c3:"shrunk"},
  {g:3, d:34, esp:"Usar/Llevar puesto", c1:"wear", c2:"wore", c3:"worn"},
  {g:3, d:34, esp:"Jurar", c1:"swear", c2:"swore", c3:"sworn"},
  {g:3, d:34, esp:"Soportar / Dar a luz", c1:"bear", c2:"bore", c3:"born", ex:"Para 'dar a luz' se usa 'born'. En otros sentidos puede ser 'borne'.", alt3:["borne"]},
  {g:3, d:34, esp:"Rasgar", c1:"tear", c2:"tore", c3:"torn"},
  {g:3, d:35, esp:"Romper", c1:"break", c2:"broke", c3:"broken"},
  {g:3, d:35, esp:"Hablar", c1:"speak", c2:"spoke", c3:"spoken"},
  {g:3, d:35, esp:"Robar", c1:"steal", c2:"stole", c3:"stolen"},
  {g:3, d:35, esp:"Despertarse", c1:"wake", c2:"woke", c3:"woken"},
  {g:3, d:35, esp:"Elegir", c1:"choose", c2:"chose", c3:"chosen"},
  {g:3, d:35, esp:"Congelar", c1:"freeze", c2:"froze", c3:"frozen"},
  {g:3, d:36, esp:"Saber/Conocer", c1:"know", c2:"knew", c3:"known"},
  {g:3, d:36, esp:"Soplar", c1:"blow", c2:"blew", c3:"blown"},
  {g:3, d:36, esp:"Crecer", c1:"grow", c2:"grew", c3:"grown"},
  {g:3, d:36, esp:"Arrojar", c1:"throw", c2:"threw", c3:"thrown"},
  {g:3, d:36, esp:"Volar", c1:"fly", c2:"flew", c3:"flown"},
  {g:3, d:37, esp:"Conducir", c1:"drive", c2:"drove", c3:"driven"},
  {g:3, d:37, esp:"Levantarse", c1:"rise", c2:"rose", c3:"risen"},
  {g:3, d:37, esp:"Surgir/Levantarse", c1:"arise", c2:"arose", c3:"arisen"},
  {g:3, d:37, esp:"Esforzarse", c1:"strive", c2:"strove", c3:"striven"},
  {g:3, d:38, esp:"Escribir", c1:"write", c2:"wrote", c3:"written"},
  {g:3, d:38, esp:"Golpear", c1:"smite", c2:"smote", c3:"smitten"},
  {g:3, d:38, esp:"Morder", c1:"bite", c2:"bit", c3:"bitten"},
  {g:3, d:38, esp:"Montar/Cabalgar", c1:"ride", c2:"rode", c3:"ridden"},
  {g:3, d:38, esp:"Zancadas", c1:"stride", c2:"strode", c3:"stridden"},
  {g:3, d:38, esp:"Deslizarse", c1:"slide", c2:"slid", c3:"slidden"},
  {g:3, d:38, esp:"Ocultar", c1:"hide", c2:"hid", c3:"hidden"},
  {g:3, d:39, esp:"Dibujar", c1:"draw", c2:"drew", c3:"drawn"},
  {g:3, d:39, esp:"Sobregirar", c1:"overdraw", c2:"overdrew", c3:"overdrawn"},
  {g:3, d:39, esp:"Retirar", c1:"withdraw", c2:"withdrew", c3:"withdrawn"},
  {g:3, d:40, esp:"Mentir", c1:"lie", c2:"lay", c3:"lain"},
  {g:3, d:40, esp:"Caer", c1:"fall", c2:"fell", c3:"fallen"},
  {g:3, d:40, esp:"Cortar/Trasquilar", c1:"shear", c2:"shore", c3:"shorn"},
  {g:3, d:40, esp:"Hincahr", c1:"swell", c2:"swelled", c3:"swollen"},
  {g:3, d:40, esp:"Pisar/Hollar", c1:"tread", c2:"trod", c3:"trodden"},
  {g:3, d:40, esp:"Tejer", c1:"weave", c2:"wove", c3:"woven"},
  {g:3, d:40, esp:"Ir", c1:"go", c2:"went", c3:"gone"},
  {g:3, d:40, esp:"Sufrir/Someterse", c1:"undergo", c2:"underwent", c3:"undergone"},
  {g:3, d:40, esp:"Hacer", c1:"do", c2:"did", c3:"done"},
  {g:3, d:40, esp:"Deshacer", c1:"undo", c2:"undid", c3:"undone"},
  {g:3, d:40, esp:"Exagerar", c1:"overdo", c2:"overdid", c3:"overdone"},
  {g:3, d:40, esp:"Ser/Estar", c1:"be", c2:"was", c3:"been"}
];

const verbosDB_R1 = verbosDB;
const verbosDB_R2 = verbosDB.map(v => ({...v, d: v.d + 40}));

/* ‚úÖ Complementos (Round 2). En pasiva se usan como SUJETO (objeto del activo). */
const COMPLEMENTS = {
  cut:   {en:"the paper", es:"el papel"},
  put:   {en:"the book on the table", es:"el libro en la mesa"},
  read:  {en:"the story", es:"la historia"},
  eat:   {en:"an apple", es:"una manzana"},
  drink: {en:"water", es:"agua"},
  write: {en:"a message", es:"un mensaje"},
  speak: {en:"English", es:"ingl√©s"},
  make:  {en:"a plan", es:"un plan"},
  take:  {en:"a photo", es:"una foto"},
  give:  {en:"a gift", es:"un regalo"},
  buy:   {en:"a notebook", es:"un cuaderno"},
  bring: {en:"the keys", es:"las llaves"},
  do:    {en:"the homework", es:"la tarea"},
  have:  {en:"a meeting", es:"una reuni√≥n"},
  be:    {en:"at home", es:"en casa"},
  run:   {en:"the race", es:"la carrera"},
  swim:  {en:"the channel", es:"el canal"},
  sleep: {en:"the night", es:"la noche"}
};
function getComplement(v){
  const key = String(v.c1||"").toLowerCase().trim();
  return COMPLEMENTS[key] || {en:"the task", es:"la tarea"};
}

/* Pronombres (agente en pasiva) */
const PRON = [
  {key:"I",    en:"I",    es:"Yo"},
  {key:"You",  en:"You",  es:"T√∫"},
  {key:"He",   en:"He",   es:"√âl"},
  {key:"She",  en:"She",  es:"Ella"},
  {key:"It",   en:"It",   es:"Eso"},
  {key:"We",   en:"We",   es:"Nosotros"},
  {key:"YouP", en:"You",  es:"Ustedes"},
  {key:"They", en:"They", es:"Ellos"}
];

const AGENT_OBJ = {
  I:"me", You:"you", He:"him", She:"her", It:"it", We:"us", YouP:"you", They:"them"
};

let streak=0, xp=0, att=0, corr=0;
let idx=0, current=[];
let pendingVerb = null;

let currentRound = 1;

let focusGroupAfterLoad = false; // ‚úÖ para que al cambiar Round el foco vaya a Grupo
let activeDB = verbosDB_R1;

/* ‚úÖ NUEVO: MODO DE VOZ */
let voiceMode = "active"; // "active" | "passive"

const PRACTICE_XP = 10;
let practiceAwarded = new Set();
let connectAwarded = new Set(); // evita farmear XP repitiendo VALIDAR (deletreo)
let spellAwarded = new Set(); // evita farmear XP repitiendo VALIDAR DELETREO (Spelling Bee)
let spellingState = null;
let lastSpellPickKey = null; // para evitar repetir el mismo verbo en Spelling Bee

let practiceState = null;

/* ===========================
   üéÆ GAMIFICACI√ìN PRO (sin servidor)
   - Persistencia con localStorage
   - Nivel + Meta diaria + Vidas + Streak Freeze
   - Logros + Dominio por verbo + Review de errores
   =========================== */
const GAME_KEY = "yoguis_neuro_gamification_v1";
const MAX_HEARTS = 5;
const HEART_REGEN_MIN = 10; // 1 coraz√≥n cada 10 min
const DAILY_GOAL_DEFAULT = 200;

let hearts = MAX_HEARTS;
let freezeTokens = 0;
let dailyGoal = DAILY_GOAL_DEFAULT;
let dailyXP = 0;
let lastDailyKey = "";
let mastery = {};          // { c1: 0..5 }
let unlocked = {};         // { achievementId: true }
let mistakes = [];         // [{c1,g,d,round,voice,t,misses}...]

function safeLSGet(key){
  try{ return localStorage.getItem(key); }catch(e){ return null; }
}
function safeLSSet(key, val){
  try{ localStorage.setItem(key, val); }catch(e){}
}
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function computeLevel(totalXP){
  // Nivel sencillo y estable: 250 XP por nivel
  const xpPerLevel = 250;
  const lvl = Math.floor((totalXP||0)/xpPerLevel) + 1;
  const into = (totalXP||0) % xpPerLevel;
  const pct = Math.round((into/xpPerLevel)*100);
  return {lvl, into, xpPerLevel, pct};
}
function heartsString(){
  const full = "‚ù§Ô∏è".repeat(Math.max(0, hearts));
  const empty = "ü§ç".repeat(Math.max(0, MAX_HEARTS - hearts));
  return (full + empty) || "ü§çü§çü§çü§çü§ç";
}
function regenHearts(){
  // Regeneraci√≥n por tiempo, sin servidor (mejor esfuerzo)
  const raw = safeLSGet(GAME_KEY);
  let last = 0;
  if(raw){
    try{
      const st = JSON.parse(raw);
      last = Number(st.lastHeartTs||0);
    }catch(e){}
  }
  const now = Date.now();
  if(!last) last = now;
  const diffMin = (now - last) / 60000;
  if(diffMin >= HEART_REGEN_MIN && hearts < MAX_HEARTS){
    const add = Math.min(MAX_HEARTS - hearts, Math.floor(diffMin/HEART_REGEN_MIN));
    hearts += add;
    const newLast = last + add * HEART_REGEN_MIN * 60000;
    persistState({lastHeartTs:newLast});
  }
}
function persistState(extra={}){
  const state = {
    streak, xp, att, corr,
    hearts, freezeTokens, dailyGoal, dailyXP,
    lastDailyKey,
    mastery, unlocked, mistakes,
    connectAwarded: Array.from(connectAwarded).slice(-2000),
    spellAwarded: Array.from(spellAwarded).slice(-2000),
    lastHeartTs: extra.lastHeartTs ?? undefined
  };

  // Mantener lastHeartTs previo si no viene
  const raw = safeLSGet(GAME_KEY);
  if(raw){
    try{
      const prev = JSON.parse(raw);
      if(state.lastHeartTs === undefined && prev.lastHeartTs) state.lastHeartTs = prev.lastHeartTs;
    }catch(e){}
  }
  if(state.lastHeartTs === undefined) state.lastHeartTs = Date.now();

  safeLSSet(GAME_KEY, JSON.stringify(state));
}
function loadState(){
  const raw = safeLSGet(GAME_KEY);
  lastDailyKey = todayKey();

  if(raw){
    try{
      const st = JSON.parse(raw);
      streak = Number(st.streak||0);
      xp = Number(st.xp||0);
      att = Number(st.att||0);
      corr = Number(st.corr||0);

      hearts = Number(st.hearts ?? MAX_HEARTS);
      freezeTokens = Number(st.freezeTokens||0);
      dailyGoal = Number(st.dailyGoal||DAILY_GOAL_DEFAULT);
      dailyXP = Number(st.dailyXP||0);

      mastery = st.mastery || {};
      unlocked = st.unlocked || {};
      mistakes = Array.isArray(st.mistakes) ? st.mistakes : [];
      connectAwarded = new Set(Array.isArray(st.connectAwarded) ? st.connectAwarded : []);
      spellAwarded = new Set(Array.isArray(st.spellAwarded) ? st.spellAwarded : []);

      // reset meta diaria si cambi√≥ el d√≠a
      const savedDay = st.lastDailyKey || todayKey();
      if(savedDay !== todayKey()){
        dailyXP = 0;
        lastDailyKey = todayKey();
      }else{
        lastDailyKey = savedDay;
      }
    }catch(e){
      // defaults
    }
  }

  regenHearts();
  actualizarStats();
  updateGamificationUI();
}
function updateMasteryUI(v){
  const el = document.getElementById("masteryStars");
  if(!el) return;
  const key = String(v?.c1||"").toLowerCase().trim();
  const m = Math.max(0, Math.min(5, Number(mastery[key]||0)));
  const stars = "‚òÖ".repeat(m) + "‚òÜ".repeat(5-m);
  el.textContent = stars;
}
function updateGamificationUI(){
  const lvl = computeLevel(xp);
  const lvlEl = document.getElementById("level");
  if(lvlEl) lvlEl.textContent = String(lvl.lvl);

  const hEl = document.getElementById("hearts");
  if(hEl) hEl.textContent = heartsString();

  const fEl = document.getElementById("freeze");
  if(fEl) fEl.textContent = String(freezeTokens);

  const tEl = document.getElementById("dailyGoalText");
  const fill = document.getElementById("dailyGoalFill");
  if(tEl) tEl.textContent = `${Math.min(dailyXP, dailyGoal)}/${dailyGoal}`;
  if(fill){
    const pct = Math.max(0, Math.min(100, Math.round((dailyXP/Math.max(1,dailyGoal))*100)));
    fill.style.width = pct + "%";
  }
}
function toastAchievement(icon, title, desc){
  const wrap = document.getElementById("achieveToast");
  if(!wrap) return;

  document.getElementById("achieveIcon").textContent = icon || "üèÜ";
  document.getElementById("achieveTitle").textContent = title || "¬°Logro desbloqueado!";
  document.getElementById("achieveDesc").textContent = desc || "Sigue as√≠.";

  wrap.style.display = "block";
  clearTimeout(window.__achieveTimer);
  window.__achieveTimer = setTimeout(()=>{ wrap.style.display="none"; }, 2400);
}
function unlock(id, icon, title, desc){
  if(unlocked[id]) return;
  unlocked[id] = true;
  toastAchievement(icon, title, desc);
  persistState();
}
function awardXP(base, reason="xp"){
  const lvlBefore = computeLevel(xp).lvl;

  // Multiplicadores suaves (no rompe la econom√≠a)
  let mult = 1;
  if(reason==="connect"){
    if(streak>=10) mult += 0.10;
    if(streak>=20) mult += 0.15;
    if(streak>=30) mult += 0.20;
  }
  if(reason==="practice"){
    if(streak>=10) mult += 0.05;
    if(streak>=20) mult += 0.10;
  }

  const gained = Math.max(1, Math.round(base * mult));
  xp += gained;
  dailyXP += gained;

  // Bonos por hitos de racha (cada 5 aciertos seguidos)
  if(reason==="connect" && streak>0 && streak % 5 === 0){
    xp += 10;
    dailyXP += 10;
    toastAchievement("üî•", "Bonus de racha", `+10 XP por racha ${streak}.`);
  }

  // Recompensa: un Streak Freeze cada 15 de racha
  if(reason==="connect" && streak>0 && streak % 15 === 0){
    freezeTokens += 1;
    toastAchievement("üßä", "Streak Freeze", "Ganaste 1 congelaci√≥n de racha.");
  }

  // Meta diaria
  if(dailyXP >= dailyGoal){
    unlock("daily_goal", "üéØ", "Meta diaria lograda", `Completaste ${dailyGoal} XP hoy. ¬°Excelente!`);
  }

  // Logros por racha
  if(streak === 1) unlock("first_win", "‚ú®", "Primera conexi√≥n", "¬°Empezaste fuerte!");
  if(streak === 5) unlock("streak_5", "üî•", "Racha 5", "Consistencia desbloqueada.");
  if(streak === 10) unlock("streak_10", "üî•", "Racha 10", "Tu cerebro ya se est√° cableando.");
  if(streak === 25) unlock("streak_25", "üî•", "Racha 25", "Modo Yoguis activado.");

  // Logros por nivel
  const lvlAfter = computeLevel(xp).lvl;
  if(lvlAfter > lvlBefore){
    toastAchievement("üÜô", `¬°Subiste a nivel ${lvlAfter}!`, "Sigue acumulando XP.");
    if(lvlAfter===5) unlock("lvl_5", "üèÖ", "Nivel 5", "Ya tienes base s√≥lida.");
    if(lvlAfter===10) unlock("lvl_10", "üèÜ", "Nivel 10", "Esto ya es disciplina real.");
  }

  actualizarStats();
  updateGamificationUI();
  persistState();
  return gained;
}
function spendHeart(){
  regenHearts();
  if(hearts <= 0) return false;
  hearts = Math.max(0, hearts - 1);
  persistState();
  updateGamificationUI();
  return true;
}
function canPlay(){
  regenHearts();
  if(hearts > 0) return true;
  const msg = document.getElementById("msg");
  if(msg){
    msg.innerHTML = `<span style="color:var(--error)">üíî Sin vidas por ahora. Vuelven 1 cada ${HEART_REGEN_MIN} min (sin servidor). Mientras tanto, usa üîä para escuchar y repasar.</span>`;
  }
  updateGamificationUI();
  return false;
}
function bumpMastery(c1, inc=1){
  const key = String(c1||"").toLowerCase().trim();
  const cur = Number(mastery[key]||0);
  const nxt = Math.max(0, Math.min(5, cur + inc));
  mastery[key] = nxt;

  if(nxt === 5){
    unlock(`mastery_${key}`, "‚≠ê", "Dominio 5/5", `Dominaste el verbo "${key.toUpperCase()}".`);
  }
  persistState();
}
function recordMistake(v){
  if(!v) return;
  const key = String(v.c1||"").toLowerCase().trim();
  const found = mistakes.find(m => m.c1===key && m.round===currentRound && m.voice===voiceMode);
  if(found){
    found.misses = (found.misses||0) + 1;
    found.t = Date.now();
    found.g = v.g; found.d = v.d;
  } else {
    mistakes.unshift({c1:key, g:v.g, d:v.d, round:currentRound, voice:voiceMode, t:Date.now(), misses:1});
  }
  mistakes = mistakes.slice(0, 30); // tope
  persistState();
}
function formatAgo(ts){
  const diff = Math.max(0, Date.now() - Number(ts||0));
  const min = Math.round(diff/60000);
  if(min < 1) return "ahora";
  if(min < 60) return `hace ${min} min`;
  const h = Math.round(min/60);
  if(h < 24) return `hace ${h} h`;
  const d = Math.round(h/24);
  return `hace ${d} d`;
}
function abrirReview(){
  const overlay = document.getElementById("reviewOverlay");
  const list = document.getElementById("reviewList");
  if(!overlay || !list) return;

  const items = mistakes.slice().sort((a,b)=>(b.t||0)-(a.t||0)).slice(0, 12);

  if(items.length===0){
    list.innerHTML = `<div class="warn" style="margin-top:10px;">‚úÖ No hay errores guardados. ¬°Vas muy bien!</div>`;
  } else {
    list.innerHTML = items.map(it=>{
      const labelVoice = (it.voice==="passive") ? "Pasiva" : "Activa";
      return `
        <div class="review-item">
          <div class="review-left">
            <div class="review-verb">${it.c1.toUpperCase()} <span style="color:#64748b;font-weight:900;">‚Ä¢ Round ${it.round} ‚Ä¢ ${labelVoice}</span></div>
            <div class="review-meta">Fallos: <b>${it.misses||1}</b> ‚Ä¢ ${formatAgo(it.t)}</div>
          </div>
          <button class="review-btn" type="button" onclick="irAMistake('${it.c1}', ${it.g||1}, ${it.d||1}, ${it.round||1}, '${it.voice||"active"}')">IR ‚úÖ</button>
        </div>
      `;
    }).join("");
  }

  overlay.style.display="flex";
}
function cerrarReview(){
  const overlay = document.getElementById("reviewOverlay");
  if(overlay) overlay.style.display="none";
}
function limpiarReview(){
  mistakes = [];
  persistState();
  abrirReview();
}
function irAMistake(c1, g, d, round, voice){
  // Ajusta Round/Voz y selecciona grupo/d√≠a
  const target = String(c1||"").toLowerCase().trim();

  try{ setRound(round); }catch(e){}
  try{ setVoice(voice); }catch(e){}

  const selG = document.getElementById("sel-grupo");
  const selD = document.getElementById("sel-dia");

  // 1) Cargar el d√≠a solicitado
  if(selG){
    selG.value = String(g);
    actualizarDias(); // esto ya llama cargarDia()
  }
  if(selD){
    selD.value = String(d);
    cargarDia();      // vuelve a cargar el d√≠a exacto
  }

  // 2) Ir exactamente al verbo que se debe repasar (dentro del d√≠a)
  function matchVerb(v){
    const vkey = String(v?.c1||"").toLowerCase().trim();
    if(vkey && vkey === target) return true;
    // por si target coincide con alguna alternativa de C1
    if(Array.isArray(v?.alt1)){
      return v.alt1.some(a => String(a||"").toLowerCase().trim() === target);
    }
    return false;
  }

  if(target && Array.isArray(current) && current.length){
    const i = current.findIndex(matchVerb);
    if(i >= 0){
      idx = i;
      mostrar();
    } else {
      // Fallback: buscar en toda la DB activa y reposicionar si el g/d no coincid√≠a
      const v2 = activeDB.find(matchVerb);
      if(v2){
        try{
          if(selG){ selG.value = String(v2.g); actualizarDias(); }
          if(selD){ selD.value = String(v2.d); cargarDia(); }
          const j = current.findIndex(matchVerb);
          if(j >= 0){ idx = j; mostrar(); }
        }catch(_){}
      }
    }
  }

  cerrarReview();

  // feedback
  const msg = document.getElementById("msg");
  if(msg){
    msg.innerHTML = `<span style="color:var(--success)">üß© Review listo: vuelve a intentar <b>${String(c1||"").toUpperCase()}</b>.</span>`;
  }
}
/* ===========================
   FIN GAMIFICACI√ìN PRO
   =========================== */


/* ===========================
   SPEECH
   =========================== */
function hablar(texto){
  window.speechSynthesis.cancel();
  let vozClara = String(texto)
    .replace(/\bcan't\b/gi,"can not")
    .replace(/\bwon't\b/gi,"will not")
    .replace(/\bdon't\b/gi,"do not")
    .replace(/\bdoesn't\b/gi,"does not")
    .replace(/\bdidn't\b/gi,"did not")
    .replace(/\bhaven't\b/gi,"have not")
    .replace(/\bhasn't\b/gi,"has not")
    .replace(/\bhadn't\b/gi,"had not")
    .replace(/n't\b/gi," not");

  const u = new SpeechSynthesisUtterance(vozClara);
  const voces = window.speechSynthesis.getVoices();
  const vozUS = voces.find(v=>v.lang==="en-US") || voces.find(v=>(v.lang||"").startsWith("en"));
  if(vozUS) u.voice = vozUS;
  u.lang="en-US";
  u.rate=0.85;
  u.pitch=1.0;
  window.speechSynthesis.speak(u);
}
window.speechSynthesis.onvoiceschanged = ()=>window.speechSynthesis.getVoices();

function bindListenButtons(){
  document.querySelectorAll('#tablas .btn-listen, #readingArea .btn-listen').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const say = btn.dataset.say ? decodeURIComponent(btn.dataset.say) : "";
      if(say) hablar(say);
    });
  });
}

/* ===========================
   Normalizers
   =========================== */
function normalizeAns(s){ return String(s||"").trim().toLowerCase(); }
function getOptions(primary, alts){
  const opts = [primary, ...(Array.isArray(alts)?alts:[])].map(normalizeAns).filter(Boolean);
  return [...new Set(opts)];
}
function isMatch(input, primary, alts){
  const r = normalizeAns(input);
  return getOptions(primary, alts).includes(r);
}
function normalizeSentence(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .replace(/‚Äô/g,"'")
    .replace(/\bcan't\b/g,"can not")
    .replace(/\bwon't\b/g,"will not")
    .replace(/\bdon't\b/g,"do not")
    .replace(/\bdoesn't\b/g,"does not")
    .replace(/\bdidn't\b/g,"did not")
    .replace(/\bhaven't\b/g,"have not")
    .replace(/\bhasn't\b/g,"has not")
    .replace(/\bhadn't\b/g,"had not")
    .replace(/[¬ø?¬°!.;,:"()]/g,"")
    .replace(/'/g,"")
    .replace(/\s+/g," ")
    .trim();
}

/* ===========================
   ACTIVE VOICE (igual)
   =========================== */
function isThirdSing(p){ return (p.key==="He" || p.key==="She" || p.key==="It"); }
function subjCap(p){ return p.en; }
function subjLow(p){ return p.en.toLowerCase(); }

function thirdPersonS(verb){
  const v = verb.toLowerCase();
  if (v === "have") return "has";
  if (/(s|sh|ch|x|z|o)$/.test(v)) return v + "es";
  if (/[^aeiou]y$/.test(v)) return v.slice(0,-1) + "ies";
  return v + "s";
}
function isBeVerb(v){ return String(v.c1||"").toLowerCase().trim()==="be"; }

/* ===========================
   ‚úÖ COLORES (C1/C2/C3) EN TABLAS
   =========================== */
function escapeRegExp(s){
  return String(s||"").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}
function highlightPhrase(line, phrase, cls){
  const ph = String(phrase||"").trim();
  if(!ph) return line;
  const re = new RegExp(`(^|\\s)(${escapeRegExp(ph)})(?=\\s|[?.!,]|$)`, "i");
  return String(line||"").replace(re, (m, g1, g2)=>`${g1}<span class="${cls}">${g2}</span>`);
}
function colorizeConjugation(enLine, tKind, moodKey, p, v, modeUsed){
  let s = String(enLine||"");

  // PASIVA: siempre V3 (C3)
  if(modeUsed==="passive"){
    return highlightPhrase(s, v.c3, "v-c3");
  }

  // ACTIVA (incluye el caso en que la pasiva no aplica y se fuerza activa)
  const isBe = isBeVerb(v);

  if(isBe){
    // BE: am/is/are ‚Äî was/were ‚Äî been
    if(tKind==="P"){
      const k = p.key || p;
      const form = (k==="I") ? "am" : (k==="He"||k==="She"||k==="It") ? "is" : "are";
      const target = (moodKey==="Q") ? capFirst(form) : form;
      return highlightPhrase(s, target, "v-c1");
    }
    if(tKind==="S"){
      const k = p.key || p;
      const basePast = (k==="YouP"||k==="You"||k==="We"||k==="They") ? "were" : "was";
      if(moodKey==="N"){
        const neg = (basePast==="was") ? "wasn't" : "weren't";
        return highlightPhrase(s, neg, "v-c2");
      }
      const target = (moodKey==="Q") ? capFirst(basePast) : basePast;
      return highlightPhrase(s, target, "v-c2");
    }
    // PP
    return highlightPhrase(s, "been", "v-c3");
  }

  // Verbos normales: C1 / C2 / C3 seg√∫n tiempo y modo
  if(tKind==="P"){
    if(moodKey==="A"){
      const base = String(v.c1||"").trim();
      const verbForm = isThirdSing(p) ? thirdPersonS(base) : base;
      return highlightPhrase(s, verbForm, "v-c1");
    }
    return highlightPhrase(s, v.c1, "v-c1"); // N y Q usan base
  }

  if(tKind==="S"){
    if(moodKey==="A"){
      return highlightPhrase(s, v.c2, "v-c2");
    }
    return highlightPhrase(s, v.c1, "v-c1"); // N y Q usan base
  }

  // PP
  return highlightPhrase(s, v.c3, "v-c3");
}

function makePresent(p, v){
  if(isBeVerb(v)){
    const k = p.key || p; // allow p object
    if(k==="I") return "I am";
    if(k==="He"||k==="She"||k==="It") return `${subjCap(p)} is`;
    return `${subjCap(p)} are`;
  }
  const base = v.c1;
  const verbForm = isThirdSing(p) ? thirdPersonS(base) : base;
  return `${subjCap(p)} ${verbForm}`;
}
function makePresentNeg(p, v){
  if(isBeVerb(v)){
    const k = p.key || p;
    if(k==="I") return "I am not";
    if(k==="He"||k==="She"||k==="It") return `${subjCap(p)} is not`;
    return `${subjCap(p)} are not`;
  }
  const aux = isThirdSing(p) ? "doesn't" : "don't";
  return `${subjCap(p)} ${aux} ${v.c1}`;
}
function makePresentQ(p, v){
  if(isBeVerb(v)){
    const k = p.key || p;
    if(k==="I") return "Am I?";
    if(k==="He"||k==="She"||k==="It") return `Is ${subjLow(p)}?`;
    return `Are ${subjLow(p)}?`;
  }
  const aux = isThirdSing(p) ? "Does" : "Do";
  return `${aux} ${subjLow(p)} ${v.c1}?`;
}
function makePast(p, v){
  if(isBeVerb(v)){
    const k = p.key || p;
    if(k==="YouP"||k==="You"||k==="We"||k==="They") return `${subjCap(p)} were`;
    return `${subjCap(p)} was`;
  }
  return `${subjCap(p)} ${v.c2}`;
}
function makePastNeg(p, v){
  if(isBeVerb(v)){
    const k = p.key || p;
    if(k==="YouP"||k==="You"||k==="We"||k==="They") return `${subjCap(p)} weren't`;
    return `${subjCap(p)} wasn't`;
  }
  return `${subjCap(p)} didn't ${v.c1}`;
}
function makePastQ(p, v){
  if(isBeVerb(v)){
    const k = p.key || p;
    if(k==="YouP"||k==="You"||k==="We"||k==="They") return `Were ${subjLow(p)}?`;
    return `Was ${subjLow(p)}?`;
  }
  return `Did ${subjLow(p)} ${v.c1}?`;
}

function makePP(p, v){
  if(isBeVerb(v)){
    const aux = isThirdSing(p) ? "has" : "have";
    return `${subjCap(p)} ${aux} been`;
  }
  const aux = isThirdSing(p) ? "has" : "have";
  return `${subjCap(p)} ${aux} ${v.c3}`;
}
function makePPNeg(p, v){
  if(isBeVerb(v)){
    const aux = isThirdSing(p) ? "hasn't" : "haven't";
    return `${subjCap(p)} ${aux} been`;
  }
  const aux = isThirdSing(p) ? "hasn't" : "haven't";
  return `${subjCap(p)} ${aux} ${v.c3}`;
}
function makePPQ(p, v){
  if(isBeVerb(v)){
    const aux = isThirdSing(p) ? "Has" : "Have";
    return `${aux} ${subjLow(p)} been?`;
  }
  const aux = isThirdSing(p) ? "Has" : "Have";
  return `${aux} ${subjLow(p)} ${v.c3}?`;
}

/* Complement in active (Round 2) */
function enWithComplement(enLine, compEN){
  if(currentRound !== 2) return enLine;
  let s = String(enLine||"").trim();
  const isQ = s.endsWith("?");
  if(isQ){
    s = s.slice(0,-1).trim();
    if(!s.toLowerCase().includes(compEN.toLowerCase())){
      s = `${s} ${compEN}`.replace(/\s+/g," ").trim();
    }
    return `${s}?`;
  }else{
    if(!s.toLowerCase().includes(compEN.toLowerCase())){
      s = `${s} ${compEN}`.replace(/\s+/g," ").trim();
    }
    return s;
  }
}
function esWithComplement(esLine, compES){
  if(currentRound !== 2) return esLine;
  let s = String(esLine||"").trim();
  const isQ = s.startsWith("¬ø") && s.endsWith("?");
  if(isQ){
    s = s.slice(0,-1).trim();
    if(!s.toLowerCase().includes(compES.toLowerCase())){
      s = `${s} ${compES}`.replace(/\s+/g," ").trim();
    }
    return `${s}?`;
  }else{
    s = s.replace(/[.?!]$/,"").trim();
    if(!s.toLowerCase().includes(compES.toLowerCase())){
      s = `${s} ${compES}`.replace(/\s+/g," ").trim();
    }
    return s;
  }
}

/* ===========================
   ‚úÖ PASSIVE VOICE (nuevo)
   =========================== */
function capFirst(s){
  const x = String(s||"").trim();
  if(!x) return x;
  return x.charAt(0).toUpperCase() + x.slice(1);
}
function isProbablyPluralEN(np){
  // heur√≠stica simple
  const s = String(np||"").trim().toLowerCase();
  const last = s.split(/\s+/).pop() || "";
  if(["you","we","they"].includes(s)) return true;
  if(last.endsWith("ss")) return false;
  if(last.endsWith("s") && !last.endsWith("us") && !last.endsWith("is")) return true;
  return false;
}
function passiveAllowed(v){
  // pasiva natural requiere verbo transitivo (objeto directo).
  // Lista corta de verbos t√≠picamente intransitivos en este set (se advierte al usuario).
  const no = new Set(["go","come","become","arise","rise","fall","be"]);
  return !no.has(String(v.c1||"").toLowerCase().trim());
}
function subjForPassive(v){
  // sujeto pasivo = objeto del activo (complemento)
  const comp = getComplement(v);
  return { en: capFirst(comp.en), es: comp.es };
}
function bePresentFor(objPlural){ return objPlural ? "are" : "is"; }
function bePastFor(objPlural){ return objPlural ? "were" : "was"; }
function haveFor(objPlural){ return objPlural ? "have" : "has"; }

function passivePresentA(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const be = bePresentFor(plural);
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${subj} ${be} ${v.c3} ${by}`;
}
function passivePresentN(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const be = bePresentFor(plural);
  const neg = (be==="is") ? "isn't" : "aren't";
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${subj} ${neg} ${v.c3} ${by}`;
}
function passivePresentQ(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const be = capFirst(bePresentFor(plural));
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${be} ${subj.toLowerCase()} ${v.c3} ${by}?`;
}

function passivePastA(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const be = bePastFor(plural);
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${subj} ${be} ${v.c3} ${by}`;
}
function passivePastN(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const be = bePastFor(plural);
  const neg = (be==="was") ? "wasn't" : "weren't";
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${subj} ${neg} ${v.c3} ${by}`;
}
function passivePastQ(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const be = capFirst(bePastFor(plural));
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${be} ${subj.toLowerCase()} ${v.c3} ${by}?`;
}

function passivePPA(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const aux = haveFor(plural);
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${subj} ${aux} been ${v.c3} ${by}`;
}
function passivePPN(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const aux = haveFor(plural);
  const neg = (aux==="has") ? "hasn't" : "haven't";
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${subj} ${neg} been ${v.c3} ${by}`;
}
function passivePPQ(v, agentP){
  const subj = subjForPassive(v).en;
  const plural = isProbablyPluralEN(subj);
  const aux = capFirst(haveFor(plural));
  const by = `by ${AGENT_OBJ[agentP.key] || "them"}`;
  return `${aux} ${subj.toLowerCase()} been ${v.c3} ${by}?`;
}

/* Espa√±ol: equivalencia elegante en pasiva con "SE" (evita concordancia de participio) */
function esSePassive(tenseKind, moodKey, objES){
  const obj = String(objES||"la tarea").trim();
  if(tenseKind==="P"){
    if(moodKey==="A") return `Se ${objVerbEs("present")} ${obj}.`;
    if(moodKey==="N") return `No se ${objVerbEs("present")} ${obj}.`;
    return `¬øSe ${objVerbEs("present")} ${obj}?`;
  }
  if(tenseKind==="S"){
    if(moodKey==="A") return `Se ${objVerbEs("past")} ${obj}.`;
    if(moodKey==="N") return `No se ${objVerbEs("past")} ${obj}.`;
    return `¬øSe ${objVerbEs("past")} ${obj}?`;
  }
  // PP
  if(moodKey==="A") return `Se ${objVerbEs("pp")} ${obj}.`;
  if(moodKey==="N") return `No se ${objVerbEs("pp")} ${obj}.`;
  return `¬øSe ${objVerbEs("pp")} ${obj}?`;
}
function objVerbEs(kind){
  // En espa√±ol con "se" el verbo var√≠a seg√∫n el verbo original; aqu√≠ usamos una estructura gen√©rica
  // (se hace / se hizo / se ha hecho) porque el objetivo del m√≥dulo es VOZ PASIVA EN INGL√âS.
  // Esto mantiene gram√°tica correcta y consistente.
  if(kind==="present") return "hace";
  if(kind==="past") return "hizo";
  return "ha hecho";
}

/* ===========================
   ‚úÖ MODO DE VOZ (UI)
   =========================== */
function setVoice(mode){
  voiceMode = (mode==="passive") ? "passive" : "active";
  document.getElementById("btnActive").classList.toggle("active", voiceMode==="active");
  document.getElementById("btnPassive").classList.toggle("active", voiceMode==="passive");

  const label = document.getElementById("voiceModeLabel");
  const hint = document.getElementById("voiceModeMiniHint");
  if(voiceMode==="active"){
    label.textContent = "Voz Activa";
    hint.textContent = "Sujeto ‚Üí Verbo ‚Üí Complemento";
  }else{
    label.textContent = "Voz Pasiva";
    hint.textContent = "Objeto ‚Üí BE ‚Üí V3 (+ by agente)";
  }

  // si ya estaba abierto el master, regenera para el verbo actual
  if(document.getElementById("master").style.display === "block"){
    const v=current[idx];
    if(v){
      generarTablas(v);
      renderPractice(v);
      renderReading(v);
    }
  }
}

/* ===========================
   ‚úÖ ROUND SELECTOR
   =========================== */
function setRound(n){
  // ‚úÖ Al cambiar Round, NO enfocar BASE; enfocar selector de Grupo
  focusGroupAfterLoad = true;
  currentRound = n===2 ? 2 : 1;
  activeDB = (currentRound===2) ? verbosDB_R2 : verbosDB_R1;

  document.getElementById("btnRound1").classList.toggle("active", currentRound===1);
  document.getElementById("btnRound2").classList.toggle("active", currentRound===2);

  document.getElementById("roundHint").textContent =
    (currentRound===2)
      ? "Round 2: Pronombre + Verbo + Complemento"
      : "Round 1: oraciones b√°sicas";

  actualizarDias();
}

/* ===========================
   ‚úÖ MODAL DE MOTIVACI√ìN
   =========================== */
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function isVisible(el){
  if(!el) return false;
  const d = (el.style && el.style.display) ? el.style.display : '';
  return d && d !== 'none';
}
function syncModalOpen(){
  const any = isVisible(document.getElementById('overlay'))
          || isVisible(document.getElementById('instOverlay'))
          || isVisible(document.getElementById('ebookOverlay'))
          || isVisible(document.getElementById('motivationToast'))
          || isVisible(document.getElementById('motivationBackdrop'));
  document.body.classList.toggle('modal-open', any);
}

function showMotivation(v){
  pendingVerb = v;

  const backdrop = document.getElementById("motivationBackdrop");
  const toast = document.getElementById("motivationToast");
  const enEl = document.getElementById("motivationEN");
  const esEl = document.getElementById("motivationES");

  const verbEN = String(v.c1 || "").trim();
  const verbES = String(v.esp || "").trim().toLowerCase();

  const tag = (voiceMode==="passive") ? "PASSIVE" : "ACTIVE";

  const templatesEN = [
    `Awesome! <span class="motivation-verb">‚Äú${verbEN}‚Äù</span> mastered (${tag}). Keep going! üöÄ`,
    `Neurons connected! <span class="motivation-verb">‚Äú${verbEN}‚Äù</span> unlocked (${tag}). üß†‚ú®`,
    `Great job! You leveled up with <span class="motivation-verb">‚Äú${verbEN}‚Äù</span> (${tag}). üî•`
  ];
  const templatesES = [
    `¬°Excelente! Dominaste <span class="motivation-verb">‚Äú${verbES}‚Äù</span> (${tag}). üöÄ`,
    `¬°Neuronas conectadas! <span class="motivation-verb">‚Äú${verbES}‚Äù</span> (${tag}). üß†‚ú®`,
    `¬°Muy bien! Subiste de nivel con <span class="motivation-verb">‚Äú${verbES}‚Äù</span> (${tag}). üî•`
  ];

  enEl.innerHTML = pick(templatesEN);
  esEl.innerHTML = pick(templatesES);

  backdrop.style.display = "block";
  toast.style.display = "flex";
  syncModalOpen();
}

function hideMotivation(){
  document.getElementById("motivationBackdrop").style.display = "none";
  document.getElementById("motivationToast").style.display = "none";
  syncModalOpen();
}

function conjugarDesdeModal(){
  if(!pendingVerb) return;

  generarTablas(pendingVerb);
  document.getElementById('master').style.display="block";

  renderSpelling(pendingVerb);
  renderPractice(pendingVerb);
  renderReading(pendingVerb);

  hideMotivation();
  pendingVerb = null;
}

/* ===========================
   ‚úÖ MODAL: INSTRUCCIONES
   =========================== */
function abrirInstrucciones(){
  const o = document.getElementById("instOverlay");
  if(o) o.style.display = "flex";
  // asegura que el modal quede visible arriba
  try{
    const modal = o?.querySelector?.(".modal");
    if(modal) modal.scrollTop = 0;
  }catch(_){}
  syncModalOpen();
}
function cerrarInstrucciones(){
  const o = document.getElementById("instOverlay");
  if(o) o.style.display = "none";
  syncModalOpen();
}

/* ===========================
   ‚úÖ MODAL: E-BOOK
   =========================== */
function abrirEbook(){
  const o = document.getElementById("ebookOverlay");
  if(o) o.style.display = "flex";
  syncModalOpen();
}
function cerrarEbook(){
  const o = document.getElementById("ebookOverlay");
  if(o) o.style.display = "none";
  syncModalOpen();
}

/* ===========================
   ‚úÖ BOT√ìN WEB
   =========================== */
function abrirWeb(){
  window.open('https://sites.google.com/iemanueljbetancur.edu.co/smartebook/inicio','_blank');
}


/* ===========================
   INIT / UI
   =========================== */
function init(){
  pinStatsBar();
  loadState();

  const gNames=[
    "GRUPO 1: (Day 1-8) - Patr√≥n t/d",
    "GRUPO 2: C2=C3",
    "GRUPO 3: Todas diferentes"
  ];
  document.getElementById('sel-grupo').innerHTML =
    gNames.map((n,i)=>`<option value="${i+1}">${n}</option>`).join('');

  renderGroupHint(1);
  actualizarDias();

  const inst = document.getElementById("instOverlay");
  if(inst){
    inst.addEventListener("click", (e)=>{
      if(e.target && e.target.id === "instOverlay") cerrarInstrucciones();
    });
  }

  const eb = document.getElementById("ebookOverlay");
  if(eb){
    eb.addEventListener("click", (e)=>{
      if(e.target && e.target.id === "ebookOverlay") cerrarEbook();
    });
  }
}

/* ESC para cerrar modales */
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    try{ cerrarAyuda(); }catch(_){}
    try{ cerrarInstrucciones(); }catch(_){}
    try{ cerrarEbook(); }catch(_){}
    try{ hideMotivation(); }catch(_){}
    try{ syncModalOpen(); }catch(_){}
  }
});

function actualizarDias(){

  // ‚úÖ Mantener visible la secci√≥n "Selecciona Grupo"
  try{
    const sg = document.getElementById('sel-grupo');
    if(sg){
      sg.focus();
      sg.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }catch(_){}

  const g = parseInt(document.getElementById('sel-grupo').value,10);
  renderGroupHint(g);

  const dias = [...new Set(activeDB.filter(v=>v.g===g).map(v=>v.d))].sort((a,b)=>a-b);
  document.getElementById('sel-dia').innerHTML =
    dias.map(d=>`<option value="${d}">D√≠a ${d}</option>`).join('');
  cargarDia();
}

function cargarDia(){
  const d = parseInt(document.getElementById('sel-dia').value,10);
  current = activeDB.filter(v=>v.d===d);
  idx=0;
  mostrar();
}

function mostrar(){
  const v = current[idx];
  if(!v) return;

  document.getElementById('verbo-esp').innerText = v.esp;
  updateMasteryUI(v);
  renderVerbIllustration(v);

  const exBox = document.getElementById("exNote");
  const exText = document.getElementById("exText");
  if(v.ex){
    exText.textContent = v.ex;
    exBox.style.display = "block";
  }else{
    exText.textContent = "";
    exBox.style.display = "none";
  }

  ["c1","c2","c3"].forEach(id=>{
    const el=document.getElementById(id);
    el.value="";
    el.style.borderColor="#e2e8f0";
  });

  const p1 = document.getElementById('progreso');
  if(p1) p1.innerText = `${idx+1} de ${current.length}`;
  const p2 = document.getElementById('progreso2');
  if(p2) p2.innerText = `${idx+1} de ${current.length}`;
  const p2f = document.getElementById('progreso2Footer');
  if(p2f) p2f.innerText = `${idx+1} de ${current.length}`;

  document.getElementById('msg').innerText="";
  document.getElementById('master').style.display="none";
  document.getElementById('spellingArea').innerHTML = "";
  document.getElementById('practiceArea').innerHTML = "";
  document.getElementById('readingArea').innerHTML = "";
  const rn = document.getElementById('readingNav');
  if(rn) rn.style.display = "none";
  const rnf = document.getElementById('readingNavFooter');
  if(rnf) rnf.style.display = "none";
  spellingState = null;
  practiceState = null;

  // ‚úÖ Foco inteligente: si vienes de cambiar Round, ubica el cursor en Grupo
  if(focusGroupAfterLoad){
    focusGroupAfterLoad = false;
    try{
      const sg = document.getElementById('sel-grupo');
      if(sg){ sg.focus(); sg.scrollIntoView({behavior:'smooth', block:'center'}); }
    }catch(_){ }
  }else{
    document.getElementById('c1').focus();
  }
}

function cambiar(step){
  if(!current.length) return;
  idx = Math.max(0, Math.min(current.length-1, idx+step));
  mostrar();
}

function hablarC1(){
  const v=current[idx];
  if(!v) return;
  hablar(v.c1);
}
function hablarC2(){
  const v=current[idx];
  if(!v) return;
  hablar(v.c2);
}
function hablarC3(){
  const v=current[idx];
  if(!v) return;
  hablar(v.c3);
}

function deletrear(){
  const v=current[idx];
  hablar(v.c1.split("").join("... "));
}

/* ===========================
   VALIDACI√ìN (igual)
   =========================== */
function validar(){
  const v=current[idx];
  if(!v) return;
  if(!canPlay()) return;

  const r1 = document.getElementById('c1').value.trim();
  const r2 = document.getElementById('c2').value.trim();
  const r3 = document.getElementById('c3').value.trim();

  ["c1","c2","c3"].forEach(id=>{
    document.getElementById(id).style.borderColor="#e2e8f0";
  });

  if(!r1 || !r2 || !r3){
    if(!r1) document.getElementById('c1').style.borderColor="var(--error)";
    if(!r2) document.getElementById('c2').style.borderColor="var(--error)";
    if(!r3) document.getElementById('c3').style.borderColor="var(--error)";
    document.getElementById('msg').innerHTML =
      `<span style="color:var(--error)">‚úçÔ∏è Escribe algo en C1, C2 y C3 para validar.</span>`;
    return;
  }

  att++;

  const ok1 = isMatch(r1, v.c1, v.alt1);
  const ok2 = isMatch(r2, v.c2, v.alt2);
  const ok3 = isMatch(r3, v.c3, v.alt3);

  if(ok1 && ok2 && ok3){
    playCorrectSound();
    streak++; corr++;
    const gained = addConnectXP(v);
    if(gained>0) bumpMastery(v.c1, 1);
    document.getElementById('msg').innerHTML = gained
      ? `<span style="color:var(--success)">üî• ¬°CONEXI√ìN EXITOSA! +${gained} XP</span>`
      : `<span style="color:var(--success)">‚úÖ Correcto. (XP ya sumado)</span>`;
    document.getElementById('master').style.display="none";

    ["c1","c2","c3"].forEach(id=>{
      const el = document.getElementById(id);
      el.value = "";
      el.style.borderColor = "#e2e8f0";
    });

    showMotivation(v);
  }else{
    playWrongSound();
    recordMistake(v);

    // Vidas + Freeze (Duolingo-style)
    const spent = spendHeart();
    if(!spent){
      actualizarStats();
      return;
    }

    if(freezeTokens > 0 && streak > 0){
      freezeTokens -= 1;
      toastAchievement("üßä", "Streak protegida", "Usaste 1 Freeze para no perder la racha.");
    }else{
      streak=0;
    }

    document.getElementById('msg').innerHTML =
      `<span style="color:var(--error)">‚ö° Revisa las columnas</span>
       <span style="display:inline-block;margin-left:10px;background:rgba(0,0,0,.06);padding:4px 8px;border-radius:999px;font-weight:950;">Vidas: ${hearts}/${MAX_HEARTS}</span>`;
    if(!ok1) document.getElementById('c1').style.borderColor="var(--error)";
    if(!ok2) document.getElementById('c2').style.borderColor="var(--error)";
    if(!ok3) document.getElementById('c3').style.borderColor="var(--error)";
  }
  actualizarStats();
}

function actualizarStats(){
  document.getElementById('streak').innerText = streak;
  document.getElementById('xp').innerText = xp;
  document.getElementById('acc').innerText = (att===0 ? 100 : Math.round((corr/att)*100)) + "%";
  updateGamificationUI();
  persistState();
}


/* ===========================
   üá™üá∏ CONJUGADOR ESPA√ëOL (para traducciones en tablas)
   - Conjugaci√≥n b√°sica + irregularidades frecuentes
   - Soporta verbos reflexivos (terminan en -se)
   - Soporta glosas con "/" o frases ("llegar a ser", "usar/llevar puesto")
   =========================== */
const PRON_IDX = {I:0, You:1, He:2, She:3, It:4, We:5, YouP:6, They:7};
const ES_REFLEX = {I:"me", You:"te", He:"se", She:"se", It:"se", We:"nos", YouP:"se", They:"se"};
const ES_HABER  = {I:"he", You:"has", He:"ha", She:"ha", It:"ha", We:"hemos", YouP:"han", They:"han"};

function _deaccent(s){
  return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function parseSpanishGloss(gloss){
  let raw = (gloss||"").trim();
  // si hay varias opciones, usamos la primera para conjugar
  raw = raw.split("/")[0].trim();
  raw = raw.replace(/\s+/g," ").toLowerCase();

  // reflexivo
  let reflexive = false;
  if(raw.endsWith("se")){
    reflexive = true;
    raw = raw.slice(0,-2).trim();
  }

  // frases (ej: "llegar a ser", "dar a luz"): conjugamos el 1er verbo y anexamos el resto
  let base = raw, tail = "";
  if(raw.includes(" ")){
    const parts = raw.split(" ");
    base = parts.shift();
    tail = parts.join(" ");
  }
  return { base, tail, reflexive, key:_deaccent(base) };
}

// ‚úÖ Irregularidades (solo las necesarias para el set de 180 verbos)
const IRR_PRESENT_FULL = {
  ser:     ["soy","eres","es","es","es","somos","son","son"],
  estar:   ["estoy","est√°s","est√°","est√°","est√°","estamos","est√°n","est√°n"],
  ir:      ["voy","vas","va","va","va","vamos","van","van"],
  dar:     ["doy","das","da","da","da","damos","dan","dan"],
  ver:     ["veo","ves","ve","ve","ve","vemos","ven","ven"],
  haber:   ["he","has","ha","ha","ha","hemos","han","han"],
  saber:   ["s√©","sabes","sabe","sabe","sabe","sabemos","saben","saben"],
  caber:   ["quepo","cabes","cabe","cabe","cabe","cabemos","caben","caben"],
  caer:    ["caigo","caes","cae","cae","cae","caemos","caen","caen"],
  hacer:   ["hago","haces","hace","hace","hace","hacemos","hacen","hacen"],
  decir:   ["digo","dices","dice","dice","dice","decimos","dicen","dicen"],
  poner:   ["pongo","pones","pone","pone","pone","ponemos","ponen","ponen"],
  traer:   ["traigo","traes","trae","trae","trae","traemos","traen","traen"],
  venir:   ["vengo","vienes","viene","viene","viene","venimos","vienen","vienen"],
  conducir:["conduzco","conduces","conduce","conduce","conduce","conducimos","conducen","conducen"],
  oir:     ["oigo","oyes","oye","oye","oye","o√≠mos","oyen","oyen"], // o√≠r
};

const IRR_PRET = {
  ser:     ["fui","fuiste","fue","fue","fue","fuimos","fueron","fueron"],
  ir:      ["fui","fuiste","fue","fue","fue","fuimos","fueron","fueron"],
  dar:     ["di","diste","dio","dio","dio","dimos","dieron","dieron"],
  ver:     ["vi","viste","vio","vio","vio","vimos","vieron","vieron"],
  caer:    ["ca√≠","ca√≠ste","cay√≥","cay√≥","cay√≥","ca√≠mos","cayeron","cayeron"],
  oir:     ["o√≠","o√≠ste","oy√≥","oy√≥","oy√≥","o√≠mos","oyeron","oyeron"],
  caber:   ["cupe","cupiste","cupo","cupo","cupo","cupimos","cupieron","cupieron"],
  hacer:   ["hice","hiciste","hizo","hizo","hizo","hicimos","hicieron","hicieron"],
  poner:   ["puse","pusiste","puso","puso","puso","pusimos","pusieron","pusieron"],
  venir:   ["vine","viniste","vino","vino","vino","vinimos","vinieron","vinieron"],
  traer:   ["traje","trajiste","trajo","trajo","trajo","trajimos","trajeron","trajeron"],
  decir:   ["dije","dijiste","dijo","dijo","dijo","dijimos","dijeron","dijeron"],
  conducir:["conduje","condujiste","condujo","condujo","condujo","condujimos","condujeron","condujeron"],
};

const IRR_PART = {
  abrir:"abierto",
  cubrir:"cubierto",
  decir:"dicho",
  escribir:"escrito",
  hacer:"hecho",
  morir:"muerto",
  poner:"puesto",
  romper:"roto",
  ver:"visto",
  volver:"vuelto",
  resolver:"resuelto",
  oir:"o√≠do",
};

const STEM_E_IE = new Set(["cerrar","empezar","pensar","sentir","perder","entender","mentir","herir","sentar","despertar"]);
const STEM_O_UE = new Set(["dormir","encontrar","mostrar","sonar","costar","morder","volar","esforzar"]);
const STEM_E_I  = new Set(["sentir","mentir","herir"]);
const PRET_IR_STEM_E_I = new Set(["sentir","mentir","herir"]);
const PRET_IR_STEM_O_U = new Set(["dormir"]);
const UIR_Y = new Set(["construir","huir"]);

function presentStemChanged(key, stem){
  // aplica el cambio al √öLTIMO n√∫cleo voc√°lico t√≠pico
  const vowels = stem.split("");
  for(let i=vowels.length-1;i>=0;i--){
    const ch=vowels[i];
    if(ch==="e" && STEM_E_IE.has(key)){
      vowels[i] = "ie";
      return vowels.join("").replace(/ie(?=ie)/g,"ie"); // seguro
    }
    if(ch==="o" && STEM_O_UE.has(key)){
      vowels[i] = "ue";
      return vowels.join("");
    }
    if(ch==="e" && STEM_E_I.has(key)){
      vowels[i] = "i";
      return vowels.join("");
    }
  }
  return stem;
}

function esPresent(espGloss, pronKey){
  const {base, tail, reflexive, key} = parseSpanishGloss(espGloss);
  const idx = PRON_IDX[pronKey];
  if(IRR_PRESENT_FULL[key]) return { form: IRR_PRESENT_FULL[key][idx], tail, reflexive, key };

  const baseNorm = _deaccent(base);
  const end = baseNorm.slice(-2);
  const stem = base.slice(0,-2);

  let stemUse = stem;
  // stem-change (no aplica en "nosotros")
  if(idx !== PRON_IDX.We){
    stemUse = presentStemChanged(key, stemUse);
  }

  // -uir (no -guir): construyo, huyes, etc.
  if(baseNorm.endsWith("uir") && !baseNorm.endsWith("guir") && idx !== PRON_IDX.We){
    stemUse = stem + "y";
  }

  const endings = (end==="ar")
    ? ["o","as","a","a","a","amos","an","an"]
    : (end==="er")
      ? ["o","es","e","e","e","emos","en","en"]
      : ["o","es","e","e","e","imos","en","en"];

  return { form: stemUse + endings[idx], tail, reflexive, key };
}

function preteriteStemChanged(key, stem, idx){
  if(idx===PRON_IDX.He || idx===PRON_IDX.She || idx===PRON_IDX.It || idx===PRON_IDX.YouP || idx===PRON_IDX.They){
    if(PRET_IR_STEM_O_U.has(key)){
      return stem.replace(/o(?!.*o)/,"u"); // √∫ltimo "o" -> "u"
    }
    if(PRET_IR_STEM_E_I.has(key)){
      return stem.replace(/e(?!.*e)/,"i"); // √∫ltimo "e" -> "i"
    }
  }
  return stem;
}

function esPreterite(espGloss, pronKey){
  const {base, tail, reflexive, key} = parseSpanishGloss(espGloss);
  const idx = PRON_IDX[pronKey];
  if(IRR_PRET[key]) return { form: IRR_PRET[key][idx], tail, reflexive, key };

  const baseNorm = _deaccent(base);
  const end = baseNorm.slice(-2);
  let stem = base.slice(0,-2);

  // cambios ortogr√°ficos en "yo": -car/-gar/-zar
  if(idx===PRON_IDX.I){
    if(baseNorm.endsWith("car")) stem = stem.slice(0,-1) + "qu";
    if(baseNorm.endsWith("gar")) stem = stem.slice(0,-1) + "gu";
    if(baseNorm.endsWith("zar")) stem = stem.slice(0,-1) + "c";
  }

  // -uir (3a persona) -> y√≥/yeron
  if(UIR_Y.has(key) && (idx===PRON_IDX.He || idx===PRON_IDX.She || idx===PRON_IDX.It || idx===PRON_IDX.YouP || idx===PRON_IDX.They)){
    const endings = ["√≠","iste","y√≥","y√≥","y√≥","imos","yeron","yeron"];
    return { form: stem + endings[idx], tail, reflexive, key };
  }

  // stem-change pret√©rito solo en 3as personas (-ir)
  stem = preteriteStemChanged(key, stem, idx);

  const endings = (end==="ar")
    ? ["√©","aste","√≥","√≥","√≥","amos","aron","aron"]
    : ["√≠","iste","i√≥","i√≥","i√≥","imos","ieron","ieron"];

  return { form: stem + endings[idx], tail, reflexive, key };
}

function esParticiple(espGloss){
  const {base, tail, reflexive, key} = parseSpanishGloss(espGloss);
  if(IRR_PART[key]) return { part: IRR_PART[key], tail, reflexive, key };

  const baseNorm = _deaccent(base);
  const end = baseNorm.slice(-2);
  const stem = base.slice(0,-2);
  const part = (end==="ar") ? (stem + "ado") : (stem + "ido");
  return { part, tail, reflexive, key };
}

function buildSpanishActiveLine(tKind, modeKey, p, v, comp){
  // ‚úÖ Round 1: SOLO pronombre + verbo (sin complemento)
  // ‚úÖ Round 2: pronombre + verbo + complemento
  const useComp = (currentRound===2); // Round 2: con complemento en todas las conjugaciones/tiempos (incluye "be")
  const compEs = (useComp && comp && comp.es) ? (" " + comp.es) : "";
  const pronEs = p.es;

  // ‚úÖ Caso especial: TO BE (Ser/Estar) - Grupo 3 D√≠a 40
  if(isBeVerb(v)){
    const k = p.key;

    // ‚úÖ Round 2: agregar complemento tambi√©n a "to be" (incluye preguntas)
    const beAddComp = (s)=>{
      if(!compEs) return s;
      return String(s).split(" / ").map(part=>{
        part = String(part||"").trim();
        if(!part) return part;
        if(part.endsWith("?")){
          return (part.slice(0,-1).trim() + compEs + "?").replace(/\s+/g," ").trim();
        }
        return (part + compEs).replace(/\s+/g," ").trim();
      }).join(" / ");
    };

    // helpers por pronombre
    const es_pres_A = {
      I:"Yo soy / Yo estoy",
      You:"T√∫ eres / T√∫ est√°s",
      He:"√âl es / √âl est√°",
      She:"Ella es / Ella est√°",
      It:"Eso es / Eso est√°",
      We:"Nosotros somos / estamos",
      YouP:"Ustedes son / est√°n",
      They:"Ellos son / est√°n"
    };
    const es_pres_N = {
      I:"Yo no soy / estoy",
      You:"T√∫ no eres / est√°s",
      He:"√âl no es / est√°",
      She:"Ella no es / est√°",
      It:"Eso no es / est√°",
      We:"Nosotros no somos / estamos",
      YouP:"Ustedes no son / est√°n",
      They:"Ellos no son / est√°n"
    };
    const es_pres_Q = {
      I:"¬øSoy yo? / ¬øEstoy yo?",
      You:"¬øEres t√∫? / ¬øEst√°s t√∫?",
      He:"¬øEs √©l? / ¬øEst√° √©l?",
      She:"¬øEs ella? / ¬øEst√° ella?",
      It:"¬øEs eso? / ¬øEst√° eso?",
      We:"¬øSomos nosotros? / ¬øEstamos?",
      YouP:"¬øSon ustedes? / ¬øEst√°n ustedes?",
      They:"¬øSon ellos? / ¬øEst√°n ellos?"
    };

    const es_past_A = {
      I:"Yo fui / estuve",
      You:"T√∫ fuiste / estuviste",
      He:"√âl fue / estuvo",
      She:"Ella fue / estuvo",
      It:"Eso fue / estuvo",
      We:"Nosotros fuimos / estuvimos",
      YouP:"Ustedes fueron / estuvieron",
      They:"Ellos fueron / estuvieron"
    };
    const es_past_N = {
      I:"Yo no fui / estuve",
      You:"T√∫ no fuiste / estuviste",
      He:"√âl no fue / estuvo",
      She:"Ella no fue / estuvo",
      It:"Eso no fue / estuvo",
      We:"Nosotros no fuimos / estuvimos",
      YouP:"Ustedes no fueron / estuvieron",
      They:"Ellos no fueron / estuvieron"
    };
    const es_past_Q = {
      I:"¬øFui yo? / ¬øEstuve yo?",
      You:"¬øFuiste t√∫? / ¬øEstuviste?",
      He:"¬øFue √©l? / ¬øEstuvo √©l?",
      She:"¬øFue ella? / ¬øEstuvo ella?",
      It:"¬øFue eso? / ¬øEstuvo eso?",
      We:"¬øFuimos nosotros? / ¬øEstuvimos?",
      YouP:"¬øFueron ustedes? / ¬øEstuvieron?",
      They:"¬øFueron ellos? / ¬øEstuvieron?"
    };

    const es_pp_A = {
      I:"Yo he sido / estado",
      You:"T√∫ has sido / estado",
      He:"√âl ha sido / estado",
      She:"Ella ha sido / estado",
      It:"Eso ha sido / estado",
      We:"Nosotros hemos sido / estado",
      YouP:"Ustedes han sido / estado",
      They:"Ellos han sido / estado"
    };
    const es_pp_N = {
      I:"Yo no he sido / estado",
      You:"T√∫ no has sido / estado",
      He:"√âl no ha sido / estado",
      She:"Ella no ha sido / estado",
      It:"Eso no ha sido / estado",
      We:"Nosotros no hemos sido / estado",
      YouP:"Ustedes no han sido / estado",
      They:"Ellos no han sido / estado"
    };
    const es_pp_Q = {
      I:"¬øHe sido / estado yo?",
      You:"¬øHas sido / estado t√∫?",
      He:"¬øHa sido / estado √©l?",
      She:"¬øHa sido / estado ella?",
      It:"¬øHa sido / estado eso?",
      We:"¬øHemos sido / estado nosotros?",
      YouP:"¬øHan sido / estado ustedes?",
      They:"¬øHan sido / estado ellos?"
    };

    if(tKind==="P"){
      if(modeKey==="A") return beAddComp(es_pres_A[k] || `${pronEs} soy / estoy`);
      if(modeKey==="N") return beAddComp(es_pres_N[k] || `${pronEs} no soy / estoy`);
      return beAddComp(es_pres_Q[k] || `¬ø${pronEs} soy / estoy?`);
    }
    if(tKind==="S"){
      if(modeKey==="A") return beAddComp(es_past_A[k] || `${pronEs} fui / estuve`);
      if(modeKey==="N") return beAddComp(es_past_N[k] || `${pronEs} no fui / estuve`);
      return beAddComp(es_past_Q[k] || `¬ø${pronEs} fui / estuve?`);
    }
    // PP
    if(modeKey==="A") return beAddComp(es_pp_A[k] || `${pronEs} he sido / estado`);
    if(modeKey==="N") return beAddComp(es_pp_N[k] || `${pronEs} no he sido / estado`);
    return beAddComp(es_pp_Q[k] || `¬øHe sido / estado ${pronEs.toLowerCase()}?`);
  }

  if(tKind==="P"){ // presente simple
    const {form, tail, reflexive} = esPresent(v.esp, p.key);
    const tailTxt = tail ? (" " + tail) : "";
    const ref = reflexive ? (ES_REFLEX[p.key] + " ") : "";
    if(modeKey==="A") return `${pronEs} ${ref}${form}${tailTxt}${compEs}`.replace(/\s+/g," ").trim();
    if(modeKey==="N") return `${pronEs} no ${ref}${form}${tailTxt}${compEs}`.replace(/\s+/g," ").trim();
    return `¬ø${pronEs} ${ref}${form}${tailTxt}${compEs}?`.replace(/\s+/g," ").trim();
  }

  if(tKind==="S"){ // pasado simple (pret√©rito)
    const {form, tail, reflexive} = esPreterite(v.esp, p.key);
    const tailTxt = tail ? (" " + tail) : "";
    const ref = reflexive ? (ES_REFLEX[p.key] + " ") : "";
    if(modeKey==="A") return `${pronEs} ${ref}${form}${tailTxt}${compEs}`.replace(/\s+/g," ").trim();
    if(modeKey==="N") return `${pronEs} no ${ref}${form}${tailTxt}${compEs}`.replace(/\s+/g," ").trim();
    return `¬ø${pronEs} ${ref}${form}${tailTxt}${compEs}?`.replace(/\s+/g," ").trim();
  }

  // Presente perfecto: haber + participio
  const aux = ES_HABER[p.key];
  const {part, tail, reflexive} = esParticiple(v.esp);
  const tailTxt = tail ? (" " + tail) : "";
  const ref = reflexive ? (ES_REFLEX[p.key] + " ") : "";

  if(modeKey==="A") return `${pronEs} ${ref}${aux} ${part}${tailTxt}${compEs}`.replace(/\s+/g," ").trim();
  if(modeKey==="N") return `${pronEs} no ${ref}${aux} ${part}${tailTxt}${compEs}`.replace(/\s+/g," ").trim();

  // En preguntas de perfecto (para verbos normales) se mantiene el estilo sin sujeto:
  return `¬ø${aux} ${ref}${part}${tailTxt}${compEs}?`.replace(/\s+/g," ").trim();
}

/* ===========================
   ‚úÖ TABLAS (ACTIVA / PASIVA)
   =========================== */
function generarTablas(v){
  const tiempos = [
    {titulo:"üìò Tiempo 1: Presente Simple", kind:"P"},
    {titulo:"üìò Tiempo 2: Pasado Simple",   kind:"S"},
    {titulo:"üìò Tiempo 3: Presente Perfecto", kind:"PP"}
  ];
  const modos = [
    {titulo:"‚úÖ Afirmativa",  key:"A"},
    {titulo:"‚ùå Negativa",    key:"N"},
    {titulo:"‚ùì Interrogativa", key:"Q"}
  ];

  const comp = getComplement(v);
  const subjPas = subjForPassive(v);

  // ‚úÖ advertencia si pasiva no aplica
  const passiveOk = passiveAllowed(v);

  let html = "";

  if(voiceMode==="passive" && !passiveOk){
    html += `
      <div class="warn">
        ‚ö†Ô∏è <b>Voz pasiva:</b> este verbo suele ser <b>intransitivo</b> (no tiene objeto directo), por eso la pasiva no se usa de forma natural.
        <br/>‚úÖ Recomendaci√≥n: cambia a <b>VOZ ACTIVA</b> para este verbo, o usa un verbo transitivo equivalente (p.ej. ‚Äúbe taken / be brought‚Äù).
      </div>
    `;
  }

  tiempos.forEach(t=>{
    const head = (voiceMode==="passive")
      ? `${t.titulo} (VOZ PASIVA ‚Äî BE + V3)`
      : `${t.titulo} (VOZ ACTIVA)`;

    html += `<div class="time-head">${head}</div><div class="grid">`;

    modos.forEach(m=>{
      html += `<div class="card"><strong>${m.titulo}</strong><table class="conj-table"><thead><tr><th>Oraci√≥n</th></tr></thead><tbody>`;

      PRON.forEach(p=>{
        let en="";

        if(voiceMode==="active" || (voiceMode==="passive" && !passiveOk)){
          // ACTIVA
          if(t.kind==="P" && m.key==="A") en = makePresent(p,v);
          if(t.kind==="P" && m.key==="N") en = makePresentNeg(p,v);
          if(t.kind==="P" && m.key==="Q") en = makePresentQ(p,v);

          if(t.kind==="S" && m.key==="A") en = makePast(p,v);
          if(t.kind==="S" && m.key==="N") en = makePastNeg(p,v);
          if(t.kind==="S" && m.key==="Q") en = makePastQ(p,v);

          if(t.kind==="PP" && m.key==="A") en = makePP(p,v);
          if(t.kind==="PP" && m.key==="N") en = makePPNeg(p,v);
          if(t.kind==="PP" && m.key==="Q") en = makePPQ(p,v);

          en = enWithComplement(en, comp.en);

          // üá™üá∏ Traducci√≥n (activa) con conjugaci√≥n real
          const esLine = buildSpanishActiveLine(t.kind, m.key, p, v, comp);
          const enHTML = colorizeConjugation(en, t.kind, m.key, p, v, "active");

          html += `
            <tr>
              <td class="en-col">
                <button class="btn-listen" type="button" data-say="${encodeURIComponent(en)}">üîä</button>
                <span class="en">${enHTML}</span>
                <div class="es">${esLine}</div>
              </td>
            </tr>`;
          return;
        }

        // PASIVA
        if(t.kind==="P" && m.key==="A") en = passivePresentA(v,p);
        if(t.kind==="P" && m.key==="N") en = passivePresentN(v,p);
        if(t.kind==="P" && m.key==="Q") en = passivePresentQ(v,p);

        if(t.kind==="S" && m.key==="A") en = passivePastA(v,p);
        if(t.kind==="S" && m.key==="N") en = passivePastN(v,p);
        if(t.kind==="S" && m.key==="Q") en = passivePastQ(v,p);

        if(t.kind==="PP" && m.key==="A") en = passivePPA(v,p);
        if(t.kind==="PP" && m.key==="N") en = passivePPN(v,p);
        if(t.kind==="PP" && m.key==="Q") en = passivePPQ(v,p);

        // Espa√±ol: estructura correcta tipo "Se ha hecho la tarea."
        const esLine = esSePassive(t.kind, m.key, subjPas.es);
        const enHTML = colorizeConjugation(en, t.kind, m.key, p, v, "passive");

        html += `
          <tr>
            <td class="en-col">
              <button class="btn-listen" type="button" data-say="${encodeURIComponent(en)}">üîä</button>
              <span class="en">${enHTML}</span>
              <div class="es">${esLine}</div>
            </td>
          </tr>`;
      });

      html += `</tbody></table>
        <div class="legend">${
          voiceMode==="passive"
            ? `Voz pasiva: <b>${subjPas.en}</b> + BE + V3 (C3) + (by + agente).`
            : `Voz activa: sujeto + verbo (C1/C2/C3) + complemento (Round 2).`
        }</div>
      </div>`;
    });

    html += `</div>`;
  });

  // ‚úÖ Tips de pasiva
  if(voiceMode==="passive" && passiveOk){
    html += `
      <div class="warn" style="margin-top:12px;">
        ‚úÖ Tip pasiva: si el sujeto pasivo es plural, usa <b>are / were / have been</b>. Si es singular, usa <b>is / was / has been</b>.
        <br/>Objeto usado como sujeto: <b>${subjPas.en}</b>.
      </div>
    `;
  }

  document.getElementById('tablas').innerHTML = html;
  bindListenButtons();
}

/* ===========================
   PRACTICE + READING (ACTIVE / PASSIVE)
   =========================== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function pickDistractors(field, avoidSet, n=3){
  const pool = activeDB
    .map(v=>String(v[field]||"").trim())
    .filter(x=>x && !avoidSet.has(normalizeAns(x)));
  const uniq = [...new Set(pool.map(normalizeAns))];
  const sample = shuffle(uniq).slice(0,n);
  return sample;
}
function practiceKeyFor(v, qid){
  return `${voiceMode}|${currentRound}|${v.g}|${v.d}|${v.c1}|${qid}`;
}

function connectKeyFor(v){
  // Clave √∫nica por verbo/round/voz/grupo/d√≠a para evitar sumar XP repetidamente en el mismo reto
  const c1 = String(v?.c1||"").toLowerCase().trim();
  return `${voiceMode}|${currentRound}|${v.g}|${v.d}|${c1}`;
}
function addConnectXP(v){
  const k = connectKeyFor(v);
  if(connectAwarded.has(k)) return 0;
  connectAwarded.add(k);
  return awardXP(25, "connect");
}

function addSpellingXP(v){
  const k = spellKeyFor(v);
  if(spellAwarded.has(k)) return 0;
  spellAwarded.add(k);
  persistState();
  return awardXP(15, "spelling");
}


function spellKeyFor(v){
  const c1 = String(v?.c1||"").toLowerCase().trim();
  return `${voiceMode}|${currentRound}|${v.g}|${v.d}|${c1}|SPELL`;
}
function addPracticeXP(v, qid){
  const k = practiceKeyFor(v,qid);
  if(practiceAwarded.has(k)) return false;
  practiceAwarded.add(k);
  const gained = awardXP(PRACTICE_XP, "practice");
  bumpMastery(v.c1, 1); // pr√°ctica tambi√©n sube dominio
  return true;
}
function setPracticeMsg(qid, html, ok){
  const el = document.getElementById(`pmsg-${qid}`);
  if(!el) return;
  el.innerHTML = html;
  if(ok===true) el.style.color = "var(--success)";
  else if(ok===false) el.style.color = "var(--error)";
  else el.style.color = "#0f172a";
}
function replaceWordOnce(sentence, from, to){
  const re = new RegExp(`\\b${from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`);
  return sentence.replace(re, to);
}
function variantsByReplacingWord(sentence, primary, alts){
  const all = [primary, ...(Array.isArray(alts)?alts:[])].map(x=>String(x||"").trim()).filter(Boolean);
  const uniq = [...new Set(all)];
  return uniq.map(form => replaceWordOnce(sentence, primary, form));
}
function makeExpectedSet(sentences){
  const set = new Set();
  sentences.forEach(s=>set.add(normalizeSentence(s)));
  return set;
}

function renderPractice(v){
  const passiveOk = passiveAllowed(v);
  const subjPas = subjForPassive(v);

  // opciones C2/C3
  const correctPast = getOptions(v.c2, v.alt2);
  const correctPart = getOptions(v.c3, v.alt3);

  const avoidPast = new Set(correctPast);
  const distractPast = pickDistractors("c2", avoidPast, 3);
  const q1Options = shuffle([...correctPast.slice(0,1), ...distractPast]);

  const agentP = PRON[0]; // I
  const agentKey = agentP.key;

  // MODELOS (EN)
  let modelEN = {};
  if(voiceMode==="active" || (voiceMode==="passive" && !passiveOk)){
    const comp = getComplement(v);
    const pI = PRON[0];
    const pShe = PRON[3];
    const pThey = PRON[7];
    const pWe = PRON[5];
    const pHe = PRON[2];
    const pYou = PRON[1];

    const en4Base = (currentRound===2)
      ? `${enWithComplement(makePast(pI,v), comp.en)} yesterday.`
      : `${makePast(pI,v)} yesterday.`;

    const en5Base = (currentRound===2)
      ? `${enWithComplement(makePresentNeg(pShe,v), comp.en)} every day.`
      : `${makePresentNeg(pShe,v)} every day.`;

    const en6Base = (currentRound===2)
      ? enWithComplement(makePresentQ(pThey,v), comp.en)
      : makePresentQ(pThey,v);

    const en7Base = (currentRound===2)
      ? `${enWithComplement(makePP(pWe,v), comp.en)} already.`
      : `${makePP(pWe,v)} already.`;

    const en8Base = (currentRound===2)
      ? `${enWithComplement(makePPNeg(pHe,v), comp.en)}.`
      : `${makePPNeg(pHe,v)}.`;

    const en9Base = (currentRound===2)
      ? enWithComplement(makePastQ(pYou,v).replace("?", " last night?"), comp.en)
      : makePastQ(pYou,v).replace("?", " last night?");

    const en4Variants = variantsByReplacingWord(en4Base, v.c2, v.alt2);
    const en7Variants = variantsByReplacingWord(en7Base, v.c3, v.alt3);
    const en8Variants = variantsByReplacingWord(en8Base, v.c3, v.alt3);

    modelEN = {
      q4Expected: makeExpectedSet([en4Base, ...en4Variants]),
      q5Expected: makeExpectedSet([en5Base]),
      q6Expected: makeExpectedSet([en6Base]),
      q7Expected: makeExpectedSet([en7Base, ...en7Variants]),
      q8Expected: makeExpectedSet([en8Base, ...en8Variants]),
      q9Expected: makeExpectedSet([en9Base]),
      es: (function(){
        const comp = getComplement(v);
        const pI = PRON[0];
        const pShe = PRON[3];
        const pThey = PRON[7];
        const pWe = PRON[5];
        const pHe = PRON[2];
        const pYou = PRON[1];

        const addTailEs = (line, tail)=>{
          line = String(line||"").replace(/\s+/g," ").trim();
          tail = String(tail||"").trim();
          if(!tail) return line;
          // insertar antes de '?'
          if(line.endsWith("?")){
            const base = line.slice(0,-1).trim();
            tail = tail.replace(/[?]+$/,"").trim();
            return (base + " " + tail + "?").replace(/\s+/g," ").trim();
          }
          return (line + " " + tail).replace(/\s+/g," ").trim();
        };
        const ensurePeriodEs = (line)=>{
          line = String(line||"").trim();
          if(!line) return line;
          if(/[\.!?]$/.test(line)) return line;
          return line + ".";
        };

        return {
          4: ensurePeriodEs(addTailEs(buildSpanishActiveLine("S","A", pI,   v, comp), "ayer")),
          5: ensurePeriodEs(addTailEs(buildSpanishActiveLine("P","N", pShe, v, comp), "todos los d√≠as")),
          6: addTailEs(buildSpanishActiveLine("P","Q", pThey, v, comp), ""), // sin cola
          7: ensurePeriodEs(addTailEs(buildSpanishActiveLine("PP","A", pWe, v, comp), "ya")),
          8: ensurePeriodEs(addTailEs(buildSpanishActiveLine("PP","N", pHe, v, comp), "")),
          9: addTailEs(buildSpanishActiveLine("S","Q", pYou, v, comp), "anoche")
        };
      })()
    };
  } else {
    // PASIVA
    const sEN = subjPas.en;
    const plural = isProbablyPluralEN(sEN);
    const beP = bePresentFor(plural);
    const beS = bePastFor(plural);
    const have = haveFor(plural);

    const byMe = "by me";

    const en4Base = `${sEN} ${beS} ${v.c3} ${byMe} yesterday.`;
    const en5Base = `${sEN} ${(beP==="is"?"isn't":"aren't")} ${v.c3} ${byMe} every day.`;
    const en6Base = `${capFirst(beP)} ${sEN.toLowerCase()} ${v.c3} ${byMe}?`;
    const en7Base = `${sEN} ${have} been ${v.c3} ${byMe} already.`;
    const en8Base = `${sEN} ${(have==="has"?"hasn't":"haven't")} been ${v.c3} ${byMe}.`;
    const en9Base = `${capFirst(beS)} ${sEN.toLowerCase()} ${v.c3} ${byMe} last night?`;

    const en4Variants = variantsByReplacingWord(en4Base, v.c3, v.alt3);
    const en7Variants = variantsByReplacingWord(en7Base, v.c3, v.alt3);
    const en8Variants = variantsByReplacingWord(en8Base, v.c3, v.alt3);

    modelEN = {
      q4Expected: makeExpectedSet([en4Base, ...en4Variants]),
      q5Expected: makeExpectedSet([en5Base]),
      q6Expected: makeExpectedSet([en6Base]),
      q7Expected: makeExpectedSet([en7Base, ...en7Variants]),
      q8Expected: makeExpectedSet([en8Base, ...en8Variants]),
      q9Expected: makeExpectedSet([en9Base]),
      es: {
        4: `Se ${objVerbEs("past")} ${subjPas.es} ayer.`,
        5: `No se ${objVerbEs("present")} ${subjPas.es} todos los d√≠as.`,
        6: `¬øSe ${objVerbEs("present")} ${subjPas.es}?`,
        7: `Se ${objVerbEs("pp")} ${subjPas.es} ya.`,
        8: `No se ${objVerbEs("pp")} ${subjPas.es}.`,
        9: `¬øSe ${objVerbEs("past")} ${subjPas.es} anoche?`
      }
    };
  }

  practiceState = {
    v,
    passiveOk,
    q1: { correct: new Set(correctPast), options: q1Options },
    q2: { correct: new Set(correctPart) }, // C3
    q3: { correct: (voiceMode==="passive" && passiveOk) ? new Set(correctPart) : new Set(correctPast) }, // en pasiva: C3; en activa: C2
    q4: { expected: modelEN.q4Expected },
    q5: { expected: modelEN.q5Expected },
    q6: { expected: modelEN.q6Expected },
    q7: { expected: modelEN.q7Expected },
    q8: { expected: modelEN.q8Expected },
    q9: { expected: modelEN.q9Expected },
    es: modelEN.es,
    subjPas
  };

  const verbName = `${v.c1.toUpperCase()} (${v.esp})`;
  const badgeText = (voiceMode==="passive" && passiveOk) ? "PASIVA" : "ACTIVA";

  // Enunciados de fill blanks (2 y 3)
  let q2Line = "";
  let q3Line = "";

  if(voiceMode==="passive" && passiveOk){
    const sEN = subjPas.en;
    const plural = isProbablyPluralEN(sEN);
    const have = haveFor(plural);
    const beS = bePastFor(plural);
    q2Line = `${sEN} ${have} been <span style="color:var(--primary);font-weight:950;">____</span> by me.`;
    q3Line = `${sEN} ${beS} <span style="color:var(--primary);font-weight:950;">____</span> by me yesterday.`;
  } else {
    const comp = getComplement(v);
    q2Line = `I have <span style="color:var(--primary);font-weight:950;">____</span> ${currentRound===2 ? comp.en : "this verb"}.`;
    q3Line = `I <span style="color:var(--primary);font-weight:950;">____</span> ${currentRound===2 ? comp.en : ""} yesterday.`;
  }

  const notePassive = (voiceMode==="passive" && !passiveOk)
    ? `<div class="warn" style="margin:0 0 10px;">‚ö†Ô∏è Este verbo no se usa naturalmente en pasiva. En PRACTICE se trabajar√° en VOZ ACTIVA para no romper la gram√°tica.</div>`
    : "";

  const html = `
    ${notePassive}
    <div class="practice-head">
      <div class="practice-title">üéØ PRACTICE (${badgeText}) ‚Äî verbo <b>${verbName}</b></div>
      <div class="practice-badge">+${PRACTICE_XP} XP por acierto</div>
    </div>

    <div class="practice-grid">
      <div class="p-card">
        <div class="p-q">1) Selecciona la forma correcta (C2) de: <b>${v.c1}</b></div>
        <select class="p-select" id="p1">
          <option value="">‚Äî Elige una opci√≥n ‚Äî</option>
          ${q1Options.map(o=>`<option value="${o}">${o}</option>`).join("")}
        </select>
        <div class="p-actions">
          <button class="p-btn" type="button" onclick="checkPractice(1)">REVISAR ‚úÖ</button>
          <div class="p-msg" id="pmsg-1"></div>
        </div>
        <div class="p-sub">Si hay alternativa aceptada, tambi√©n cuenta.</div>
      </div>

      <div class="p-card">
        <div class="p-q">2) Completa la oraci√≥n:</div>
        <div class="p-q" style="background:#fff;border:2px dashed #e2e8f0;border-radius:14px;padding:12px;">
          ${q2Line}
        </div>
        <input class="p-input" id="p2" placeholder="Escribe la palabra que falta" autocomplete="off" />
        <div class="p-actions">
          <button class="p-btn" type="button" onclick="checkPractice(2)">REVISAR ‚úÖ</button>
          <div class="p-msg" id="pmsg-2"></div>
        </div>
        <div class="p-sub">${(voiceMode==="passive" && passiveOk) ? "En pasiva se usa V3 (C3)." : "Acepta alternativas cuando existan."}</div>
      </div>

      <div class="p-card">
        <div class="p-q">3) Completa la oraci√≥n:</div>
        <div class="p-q" style="background:#fff;border:2px dashed #e2e8f0;border-radius:14px;padding:12px;">
          ${q3Line}
        </div>
        <input class="p-input" id="p3" placeholder="Escribe la palabra que falta" autocomplete="off" />
        <div class="p-actions">
          <button class="p-btn" type="button" onclick="checkPractice(3)">REVISAR ‚úÖ</button>
          <div class="p-msg" id="pmsg-3"></div>
        </div>
        <div class="p-sub">Objetivo: automatizar en contexto.</div>
      </div>
    </div>

    <div class="p-divider">üü£ 6 ejercicios extra: Espa√±ol ‚ûú Escr√≠belas en Ingl√©s (${badgeText})</div>

    <div class="practice-grid">
      ${[4,5,6,7,8,9].map(n=>`
        <div class="p-card">
          <div class="p-q">${n}) Traduce al ingl√©s:</div>
          <div class="p-q" style="background:#fff;border:2px dashed #e2e8f0;border-radius:14px;padding:12px;">
            ${practiceState.es[n]}
          </div>
          <input class="p-input" id="p${n}" placeholder="Escribe la oraci√≥n en ingl√©s" autocomplete="off" />
          <div class="p-actions">
            <button class="p-btn" type="button" onclick="checkPractice(${n})">REVISAR ‚úÖ</button>
            <div class="p-msg" id="pmsg-${n}"></div>
          </div>
          <div class="p-sub">Tip: no importa si pones punto o no (se normaliza).</div>
        </div>
      `).join("")}
    </div>
  `;

  document.getElementById("practiceArea").innerHTML = html;
  [1,2,3,4,5,6,7,8,9].forEach(q=>setPracticeMsg(q,"",null));
}

function checkPractice(qid){
  if(!practiceState || !practiceState.v) return;
  const v = practiceState.v;

  if(qid===1){
    const val = normalizeAns(document.getElementById("p1").value);
    if(!val){
      setPracticeMsg(1, "‚ö†Ô∏è Elige una opci√≥n.", false);
      playWrongSound();
      return;
    }
    const ok = practiceState.q1.correct.has(val);
    if(ok){
      const gained = addPracticeXP(v, 1);
      playCorrectSound();
      setPracticeMsg(1, gained ? `‚úÖ Correcto. +${PRACTICE_XP} XP` : `‚úÖ Correcto. (XP ya sumado)`, true);
    }else{
      playWrongSound();
      setPracticeMsg(1, `‚ùå Incorrecto. Respuesta: <b>${[...practiceState.q1.correct][0]}</b>`, false);
    }
    return;
  }

  if(qid===2){
    const val = normalizeAns(document.getElementById("p2").value);
    if(!val){
      setPracticeMsg(2, "‚ö†Ô∏è Escribe la palabra que falta.", false);
      playWrongSound();
      return;
    }
    const ok = practiceState.q2.correct.has(val);
    if(ok){
      const gained = addPracticeXP(v, 2);
      playCorrectSound();
      setPracticeMsg(2, gained ? `‚úÖ Perfect! +${PRACTICE_XP} XP` : `‚úÖ Perfect! (XP ya sumado)`, true);
    }else{
      playWrongSound();
      setPracticeMsg(2, `‚ùå No. Aceptado: <b>${[...practiceState.q2.correct].join(" / ")}</b>`, false);
    }
    return;
  }

  if(qid===3){
    const val = normalizeAns(document.getElementById("p3").value);
    if(!val){
      setPracticeMsg(3, "‚ö†Ô∏è Escribe la palabra que falta.", false);
      playWrongSound();
      return;
    }
    const ok = practiceState.q3.correct.has(val);
    if(ok){
      const gained = addPracticeXP(v, 3);
      playCorrectSound();
      setPracticeMsg(3, gained ? `‚úÖ Bien. +${PRACTICE_XP} XP` : `‚úÖ Bien. (XP ya sumado)`, true);
    }else{
      playWrongSound();
      setPracticeMsg(3, `‚ùå Incorrecto. Aceptado: <b>${[...practiceState.q3.correct].join(" / ")}</b>`, false);
    }
    return;
  }

  if(qid>=4 && qid<=9){
    const raw = document.getElementById(`p${qid}`).value;
    const val = normalizeSentence(raw);
    if(!val){
      setPracticeMsg(qid, "‚ö†Ô∏è Escribe la oraci√≥n en ingl√©s.", false);
      playWrongSound();
      return;
    }
    const expected = practiceState[`q${qid}`].expected;
    const ok = expected.has(val);

    if(ok){
      const gained = addPracticeXP(v, qid);
      playCorrectSound();
      setPracticeMsg(qid, gained ? `‚úÖ Correcto. +${PRACTICE_XP} XP` : `‚úÖ Correcto. (XP ya sumado)`, true);
    }else{
      playWrongSound();
      setPracticeMsg(qid, `‚ùå No coincide. Revisa estructura (modelo).`, false);
    }
    return;
  }
}

function renderReading(v){
  const passiveOk = passiveAllowed(v);
  const verbName = `${v.c1.toUpperCase()} (${v.esp})`;
  const comp = getComplement(v);
  const subjPas = subjForPassive(v);

  const addTailEs = (line, tail)=>{
    line = String(line||"").replace(/\s+/g," ").trim();
    tail = String(tail||"").trim();
    if(!tail) return line;
    if(line.endsWith("?")){
      const base = line.slice(0,-1).trim();
      tail = tail.replace(/[?]+$/,"").trim();
      return (base + " " + tail + "?").replace(/\s+/g," ").trim();
    }
    return (line + " " + tail).replace(/\s+/g," ").trim();
  };
  const ensurePeriodEs = (line)=>{
    line = String(line||"").trim();
    if(!line) return line;
    if(/[\.!?]$/.test(line)) return line;
    return line + ".";
  };

  let en = [];
  let es = [];
  let meta = [];

  if(voiceMode==="passive" && passiveOk){
    const sEN = subjPas.en;
    const plural = isProbablyPluralEN(sEN);
    const beP = bePresentFor(plural);
    const beS = bePastFor(plural);
    const have = haveFor(plural);

    const byMe = "by me";

    en = [
      `${sEN} ${beP} ${v.c3} ${byMe} today.`,
      `${sEN} ${(beP==="is"?"isn't":"aren't")} ${v.c3} ${byMe} today.`,
      `${capFirst(beP)} ${sEN.toLowerCase()} ${v.c3} ${byMe} today?`,

      `${sEN} ${beS} ${v.c3} ${byMe} yesterday.`,
      `${sEN} ${(beS==="was"?"wasn't":"weren't")} ${v.c3} ${byMe} yesterday.`,
      `${capFirst(beS)} ${sEN.toLowerCase()} ${v.c3} ${byMe} yesterday?`,

      `${sEN} ${have} been ${v.c3} ${byMe} this week.`,
      `${sEN} ${have} not been ${v.c3} ${byMe} this week.`,
      `${capFirst(have)} ${sEN.toLowerCase()} been ${v.c3} ${byMe} this week?`
    ];

    es = [
      `Se ${objVerbEs("present")} ${subjPas.es} hoy.`,
      `No se ${objVerbEs("present")} ${subjPas.es} hoy.`,
      `¬øSe ${objVerbEs("present")} ${subjPas.es} hoy?`,

      `Se ${objVerbEs("past")} ${subjPas.es} ayer.`,
      `No se ${objVerbEs("past")} ${subjPas.es} ayer.`,
      `¬øSe ${objVerbEs("past")} ${subjPas.es} ayer?`,

      `Se ${objVerbEs("pp")} ${subjPas.es} esta semana.`,
      `No se ${objVerbEs("pp")} ${subjPas.es} esta semana.`,
      `¬øSe ${objVerbEs("pp")} ${subjPas.es} esta semana?`
    ].map(x=>x.replace(/\s+/g," ").trim());

    // meta (tKind/mood) para colorear C3 en pasiva
    meta = [
      {t:"P", m:"A", p:PRON[0]},
      {t:"P", m:"N", p:PRON[0]},
      {t:"P", m:"Q", p:PRON[0]},
      {t:"S", m:"A", p:PRON[0]},
      {t:"S", m:"N", p:PRON[0]},
      {t:"S", m:"Q", p:PRON[0]},
      {t:"PP", m:"A", p:PRON[0]},
      {t:"PP", m:"N", p:PRON[0]},
      {t:"PP", m:"Q", p:PRON[0]}
    ];

  } else {
    // Activa (o pasiva no aplicable)
    const pI = PRON[0];
    const pYou = PRON[1];

    const enRaw = [
      `${makePresent(pI,v)} today.`,
      `${makePresentNeg(pI,v)} today.`,
      makePresentQ(pYou,v).replace(/\?$/," today?"),

      `${makePast(pI,v)} yesterday.`,
      `${makePastNeg(pI,v)} yesterday.`,
      makePastQ(pYou,v).replace(/\?$/," yesterday?"),

      `${makePP(pI,v)} this week.`,
      `${makePPNeg(pI,v)} this week.`,
      makePPQ(pYou,v).replace(/\?$/," this week?")
    ];

    // ‚úÖ Round 2: insertar complemento manteniendo el tiempo (today/yesterday/this week)
    en = (currentRound===2)
      ? enRaw.map(line => {
          const m = line.match(/\s(today|yesterday|this week)\.?$/i);
          if(m){
            const time = m[1];
            let core = line.replace(/\s(today|yesterday|this week)\.?$/i,"").trim();
            const isQ = core.endsWith("?");
            core = enWithComplement(core, comp.en);
            core = core.replace(/\?$/,"").trim();
            const tail = (time.toLowerCase()==="this week") ? " this week" : ` ${time.toLowerCase()}`;
            return isQ ? `${core}${tail}?` : `${core}${tail}.`.replace(/\.\./g,".");
          }
          return enWithComplement(line, comp.en);
        })
      : enRaw;

    // ‚úÖ Espa√±ol con conjugaci√≥n real (misma l√≥gica que Tablas)
    es = [
      ensurePeriodEs(addTailEs(buildSpanishActiveLine("P","A", pI, v, comp), "hoy")),
      ensurePeriodEs(addTailEs(buildSpanishActiveLine("P","N", pI, v, comp), "hoy")),
      addTailEs(buildSpanishActiveLine("P","Q", pYou, v, comp), "hoy"),

      ensurePeriodEs(addTailEs(buildSpanishActiveLine("S","A", pI, v, comp), "ayer")),
      ensurePeriodEs(addTailEs(buildSpanishActiveLine("S","N", pI, v, comp), "ayer")),
      addTailEs(buildSpanishActiveLine("S","Q", pYou, v, comp), "ayer"),

      ensurePeriodEs(addTailEs(buildSpanishActiveLine("PP","A", pI, v, comp), "esta semana")),
      ensurePeriodEs(addTailEs(buildSpanishActiveLine("PP","N", pI, v, comp), "esta semana")),
      addTailEs(buildSpanishActiveLine("PP","Q", pYou, v, comp), "esta semana")
    ].map(x=>x.replace(/\s+/g," ").trim());

    meta = [
      {t:"P", m:"A", p:pI},
      {t:"P", m:"N", p:pI},
      {t:"P", m:"Q", p:pYou},
      {t:"S", m:"A", p:pI},
      {t:"S", m:"N", p:pI},
      {t:"S", m:"Q", p:pYou},
      {t:"PP", m:"A", p:pI},
      {t:"PP", m:"N", p:pI},
      {t:"PP", m:"Q", p:pYou}
    ];
  }

  const modeUsed = (voiceMode==="passive" && passiveOk) ? "passive" : "active";
  const enHTML = en.map((line,i)=> colorizeConjugation(line, meta[i].t, meta[i].m, meta[i].p, v, modeUsed));

  const badgeText = (voiceMode==="passive" && passiveOk) ? "PASIVA" : "ACTIVA";

  const warnPassive = (voiceMode==="passive" && !passiveOk)
    ? `<div class="warn" style="margin-top:12px;">‚ö†Ô∏è Este verbo no se usa naturalmente en pasiva; READING se muestra en activa para mantener la gram√°tica correcta.</div>`
    : "";

  const html = `
    <div class="practice-head" style="margin-top:18px;">
      <div class="practice-title">üìñ READING (${badgeText}) ‚Äî pr√°ctica completa con <b>${verbName}</b></div>
      <div class="practice-badge">EN ‚ûú ES</div>
    </div>

    ${warnPassive}

    <div class="grid" style="grid-template-columns: 1fr;">
      <div class="card">
        <strong>üá∫üá∏ English (Primero)</strong>
        <table>
          ${en.map((line,i)=>`
            <tr>
              <td>
                <button class="btn-listen" type="button" data-say="${encodeURIComponent(line)}">üîä</button>
                <span class="en">${enHTML[i]}</span>
                <span class="es">${es[i]}</span>
              </td>
            </tr>
          `).join("")}
        </tbody></table>
        <div class="legend">${
          (voiceMode==="passive" && passiveOk)
            ? `Voz pasiva con sujeto-objeto: <b>${subjForPassive(v).en}</b>.<br/>Equivalencia recomendada en espa√±ol: construcci√≥n con <b>‚Äúse‚Äù</b> (correcta y natural).`
            : `Incluye Presente, Pasado y Presente Perfecto (A/N/Q).<br/>Traducci√≥n debajo de cada oraci√≥n (EN ‚Üí ES).`
        }</div>
      </div>
    </div>
  `;

  document.getElementById("readingArea").innerHTML = html;
  bindListenButtons();
  const rn = document.getElementById("readingNav");
  if(rn) rn.style.display = "flex";
  const rnf = document.getElementById("readingNavFooter");
  if(rnf) rnf.style.display = "flex";
  const p2 = document.getElementById("progreso2");
  if(p2) p2.innerText = `${idx+1} de ${current.length}`;
  const p2f = document.getElementById("progreso2Footer");
  if(p2f) p2f.innerText = `${idx+1} de ${current.length}`;
}

/* ===========================
   RED NEURONAL (igual)
   =========================== */
function abrirAyuda(){
  const lista = current.map((v,i)=>`
    <div style="padding:8px 0; border-bottom:1px solid #e2e8f0;">
      <b>${String(i+1).padStart(2,"0")}.</b>
      <b>${v.c1.toUpperCase()}</b> ‚Äî ${v.c1} / ${v.c2} / ${v.c3}
      <span style="color:#64748b">(${v.esp})</span>
      ${v.ex ? `<div style="margin-top:6px; color:#b91c1c; font-weight:900;">‚ö† EXCEPCI√ìN: ${v.ex}</div>` : ``}
      ${(v.alt2||v.alt3) ? `<div style="margin-top:6px; color:#0f172a; font-weight:900;">‚úÖ Alternativas aceptadas: ${[
        ...(v.alt2?getOptions("",v.alt2).filter(Boolean):[]),
        ...(v.alt3?getOptions("",v.alt3).filter(Boolean):[])
      ].filter(Boolean).join(", ")}</div>` : ``}
      ${(currentRound===2) ? `<div style="margin-top:6px; color:#0b1220; font-weight:950;">üü£ Complemento: <span style="color:#0b1220; background:#fde68a; padding:2px 8px; border-radius:999px;">${getComplement(v).en}</span></div>` : ``}
      ${(voiceMode==="passive") ? `<div style="margin-top:6px; color:#0b1220; font-weight:950;">üü† Pasiva: ${passiveAllowed(v) ? "BE + V3 (+ by agente)" : "No aplica natural (intransitivo)"}</div>` : ``}
    </div>
  `).join("");

  document.getElementById('ayuda').innerHTML = lista || "No hay verbos en este d√≠a.";
  document.getElementById('overlay').style.display="flex";
  syncModalOpen();
}
function cerrarAyuda(){
  document.getElementById('overlay').style.display="none";
  syncModalOpen();
}

window.addEventListener("load", ()=>{ init(); updateHudSafe(); });
window.addEventListener("resize", pinStatsBar);
window.addEventListener("scroll", pinStatsBar);

/* ===========================
   üêù SPELLING BEE (DELETREO C1/C2/C3)
   =========================== */
function uniqueList(arr){
  const seen = new Set();
  const out = [];
  (arr||[]).forEach(x=>{
    const s = String(x||"").trim();
    if(!s) return;
    const k = s.toLowerCase();
    if(seen.has(k)) return;
    seen.add(k);
    out.push(s);
  });
  return out;
}
function getSpellingPool(){
  // Pool preferido: verbos del d√≠a (current). Fallback: base activa.
  if(Array.isArray(current) && current.length) return current;
  return activeDB || [];
}

function pickRandomVerbForSpelling(){
  const pool = getSpellingPool();
  if(!Array.isArray(pool) || !pool.length) return null;
  if(pool.length === 1) {
    lastSpellPickKey = spellKeyFor(pool[0]);
    return pool[0];
  }
  // intenta evitar repetir el mismo verbo consecutivo
  for(let t=0; t<12; t++){
    const v = pool[Math.floor(Math.random()*pool.length)];
    const k = spellKeyFor(v);
    if(k && k !== lastSpellPickKey){
      lastSpellPickKey = k;
      return v;
    }
  }
  const v = pool[Math.floor(Math.random()*pool.length)];
  lastSpellPickKey = spellKeyFor(v);
  return v;
}

function initSpellingState(v){
  const pool = getSpellingPool();
  const c1Opts = shuffle(uniqueList(pool.map(x=>x.c1)));
  const c2Opts = shuffle(uniqueList(pool.map(x=>x.c2)));
  const c3Opts = shuffle(uniqueList(pool.map(x=>x.c3)));

  // Garantiza que el correcto est√© dentro
  const must1 = String(v?.c1||"").trim();
  const must2 = String(v?.c2||"").trim();
  const must3 = String(v?.c3||"").trim();

  if(must1 && !c1Opts.some(x=>String(x).toLowerCase()===must1.toLowerCase())) c1Opts.unshift(must1);
  if(must2 && !c2Opts.some(x=>String(x).toLowerCase()===must2.toLowerCase())) c2Opts.unshift(must2);
  if(must3 && !c3Opts.some(x=>String(x).toLowerCase()===must3.toLowerCase())) c3Opts.unshift(must3);

  const randIndex = (n)=> Math.max(0, Math.min(n-1, Math.floor(Math.random()*n)));

  spellingState = {
    key: spellKeyFor(v),
    c1Opts, c2Opts, c3Opts,
    i1: randIndex(c1Opts.length),
    i2: randIndex(c2Opts.length),
    i3: randIndex(c3Opts.length)
  };
}
function renderSpelling(v){
  const area = document.getElementById("spellingArea");
  if(!area) return;

  // ‚úÖ Aleatorio: al llegar a esta secci√≥n, el verbo se elige al azar (del pool del d√≠a)
  const target = pickRandomVerbForSpelling() || v || (Array.isArray(current) ? current[idx] : null);
  if(!target) return;

  initSpellingState(target);
  // guardamos el verbo objetivo dentro del estado para validaci√≥n correcta
  spellingState.target = target;

  const esp = String(target.esp||"").trim().toUpperCase();
  const work = String(target.c1||"").trim().toUpperCase();

  area.innerHTML = `
    <div class="spellWrap">
      <div class="spellHead">
        <div>
          <h3 class="spellTitle">üêù Spelling Bee</h3>
          <div class="spellSub">Deletrea las 3 formas (C1/C2/C3) del verbo actual. Verbo aleatorio del d√≠a (para repasar m√°s).</div>
        </div>
      </div>

      <div class="spellTopRow">
        <div class="spellESPBlock">
          <div class="spellESP">${esp || "VERBO"}</div>
          
        </div>
        <div class="spellWork">Trabajando: <b>${work}</b> ‚Ä¢ Selecciona C1, C2 y C3 con las flechas y valida.</div>
      </div>

      <div class="spellGrid">
        <div class="spellCard">
          <div class="spellLabel">PRESENT (C1)</div>
          <div class="spellPicker">
            <button class="spellArrow" type="button" onclick="spellMove(1,-1)">‚Äπ</button>
            <div class="spellVal" id="spellC1Val">‚Äî</div>
            <button class="spellArrow" type="button" onclick="spellMove(1,1)">‚Ä∫</button>
          </div>
          <button class="spellSpeak" type="button" onclick="spellSpeak(1)">üéôÔ∏è Deletrear</button>
        </div>

        <div class="spellCard">
          <div class="spellLabel">PAST (C2)</div>
          <div class="spellPicker">
            <button class="spellArrow" type="button" onclick="spellMove(2,-1)">‚Äπ</button>
            <div class="spellVal" id="spellC2Val">‚Äî</div>
            <button class="spellArrow" type="button" onclick="spellMove(2,1)">‚Ä∫</button>
          </div>
          <button class="spellSpeak" type="button" onclick="spellSpeak(2)">üéôÔ∏è Deletrear</button>
        </div>

        <div class="spellCard">
          <div class="spellLabel">PARTICIPLE (C3)</div>
          <div class="spellPicker">
            <button class="spellArrow" type="button" onclick="spellMove(3,-1)">‚Äπ</button>
            <div class="spellVal" id="spellC3Val">‚Äî</div>
            <button class="spellArrow" type="button" onclick="spellMove(3,1)">‚Ä∫</button>
          </div>
          <button class="spellSpeak" type="button" onclick="spellSpeak(3)">üéôÔ∏è Deletrear</button>
        </div>
      </div>

      <div class="spellActions">
        <div class="spellFeedback" id="spellFeedback"></div>
        <button class="spellValidate" type="button" onclick="validateSpelling()">VALIDAR DELETREO ‚úÖ</button>
      </div>
    </div>
  `;

  spellSyncUI();
}


function getSpellIllustrationSVG(v){
  const c1 = String(v?.c1||"").trim().toLowerCase();
  const esp = String(v?.esp||"").trim().toLowerCase();

  const pick = (emoji, label)=> {
    const safeLabel = String(label||"").replace(/[<>]/g,"").slice(0,40);
    return `
      <svg viewBox="0 0 240 130" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${safeLabel}">
        <defs>
          <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="rgba(242,139,22,.35)"/>
            <stop offset="1" stop-color="rgba(101,17,107,.35)"/>
          </linearGradient>
        </defs>
        <rect x="8" y="8" width="224" height="114" rx="18" fill="url(#bg)" stroke="rgba(242,139,22,.35)"/>
        <text x="120" y="70" text-anchor="middle" dominant-baseline="middle" font-size="66"> ${emoji} </text>
        <text x="120" y="112" text-anchor="middle" font-size="14" fill="rgba(255,255,255,.9)" font-weight="900" letter-spacing=".08em">${safeLabel.toUpperCase()}</text>
      </svg>
    `;
  };

  // üî• Mapeo r√°pido (puedes ampliar esta lista si quieres)
  if(c1==="cut" || esp.includes("cortar") || esp.includes("recortar")) return pick("‚úÇÔ∏è","cut");
  if(c1==="put" || esp.includes("poner") || esp.includes("colocar") || esp.includes("meter")) return pick("üì¶","put");
  if(c1==="go" || esp.includes("ir")) return pick("‚û°Ô∏è","go");
  if(c1==="come" || esp.includes("venir")) return pick("üö∂‚Äç‚ôÇÔ∏è","come");
  if(c1==="eat" || esp.includes("comer")) return pick("üçΩÔ∏è","eat");
  if(c1==="drink" || esp.includes("beber") || esp.includes("tomar")) return pick("ü•§","drink");
  if(c1==="read" || esp.includes("leer")) return pick("üìñ","read");
  if(c1==="write" || esp.includes("escribir")) return pick("‚úçÔ∏è","write");
  if(c1==="see" || esp.includes("ver")) return pick("üëÄ","see");
  if(c1==="say" || esp.includes("decir")) return pick("üí¨","say");
  if(c1==="tell" || esp.includes("contar") || esp.includes("decir")) return pick("üó£Ô∏è","tell");
  if(c1==="take" || esp.includes("tomar") || esp.includes("llevar")) return pick("ü§≤","take");
  if(c1==="give" || esp.includes("dar")) return pick("üéÅ","give");
  if(c1==="make" || esp.includes("hacer") || esp.includes("fabricar")) return pick("üõ†Ô∏è","make");
  if(c1==="think" || esp.includes("pensar")) return pick("üß†","think");
  if(c1==="run" || esp.includes("correr")) return pick("üèÉ","run");
  if(c1==="buy" || esp.includes("comprar")) return pick("üõí","buy");
  if(c1==="sell" || esp.includes("vender")) return pick("üí∞","sell");
  if(c1==="sleep" || esp.includes("dormir")) return pick("üò¥","sleep");
  if(c1==="sing" || esp.includes("cantar")) return pick("üé§","sing");
  if(c1==="swim" || esp.includes("nadar")) return pick("üèä","swim");
  if(c1==="drive" || esp.includes("conduc")) return pick("üöó","drive");
  if(c1==="fly" || esp.includes("volar")) return pick("‚úàÔ∏è","fly");
  if(c1==="teach" || esp.includes("ense√±ar")) return pick("üë®‚Äçüè´","teach");
  if(c1==="learn" || esp.includes("aprender")) return pick("üìö","learn");

  // Default (si no hay mapeo): icono gen√©rico "brain"
  return pick("üß©","verb");
}

/* ===========================
   ‚úÖ Imagen impactante por verbo (bajo el t√≠tulo principal)
   - Sin servidor
   - Funciona embebido en Google Sites
   - Usa fotos din√°micas (Unsplash Source) + fallback SVG
   =========================== */

// Mapeo curado (mejores resultados visuales). Para verbos no listados,
// se genera un query autom√°tico con el espa√±ol + ingl√©s.
const VERB_PHOTO_QUERIES = {
  cut: "scissors cutting paper",
  put: "placing box on table",
  beat: "drumsticks playing drums",
  sweat: "sweating athlete workout",
  sit: "person sitting chair",
  eat: "healthy meal eating",
  bet: "casino bet chips",
  let: "open door letting in light",
  set: "setting table dinner",
  wet: "rain drops wet street",
  hurt: "injured hand bandage",
  shut: "closing door shut",
  burst: "balloon burst pop",
  thrust: "pushing forward thrust",
  cost: "price tag cost",
  cast: "casting fishing rod",
  broadcast: "tv studio broadcast",
  forecast: "weather forecast map",
  fit: "fitting clothes measuring tape",
  hit: "boxing punch hit",
  slit: "paper slit cutter",
  spit: "spitting water splash",
  split: "splitting wood axe",
  quit: "quit smoking broken cigarette",
  knit: "knitting yarn needles",
  bid: "auction bid paddle",
  rid: "cleaning rid of dirt",
  read: "reading book library",
  spread: "spreading butter bread",
  lead: "leader leading team",

  stand: "standing person silhouette",
  understand: "understanding idea lightbulb",
  withstand: "storm withstand strong wind",
  bend: "bending metal bar",
  blend: "blending smoothie blender",
  lend: "lending money hand",
  send: "sending mail envelope",
  spend: "spending money wallet",

  bind: "binding rope knots",
  unbind: "untying rope unbind",
  find: "finding keys search",
  grind: "coffee grinding beans",
  wind: "winding clock mechanism",
  unwind: "relax unwind hammock",

  cling: "cling to cliff rock climbing",
  sting: "bee sting macro",
  swing: "swing playground",
  wring: "wringing towel water",
  hang: "hanging clothesline",

  hold: "holding hands closeup"
};

function _normalizeQuery(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9\s]/g, " ")
    .trim()
    .replace(/\s+/g, " ");
}

function _hash32(str){
  // hash simple y estable (para "sig" y cache)
  let h = 2166136261;
  const s = String(str||"");
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0);
}

function getVerbPhotoQuery(v){
  const c1 = String(v?.c1||"").toLowerCase();
  const esp = String(v?.esp||"").toLowerCase();
  const curated = VERB_PHOTO_QUERIES[c1];
  if(curated) return curated;

  // Fallback autom√°tico (cada verbo tiene su propio query)
  const auto = `${_normalizeQuery(esp)} action ${_normalizeQuery(c1)}`.trim();
  return auto || "english verb action";
}

function getVerbPhotoUrl(v){
  const q = getVerbPhotoQuery(v);
  const sig = _hash32(String(v?.c1||"verb") + "|" + String(v?.esp||"")) % 99;
  // Unsplash Source: fotos grandes y llamativas sin API key.
  // Nota: puede variar entre cargas (es normal), pero se estabiliza por verbo con "sig".
  // Usamos "featured" para priorizar fotos m√°s impactantes.
  return `https://source.unsplash.com/featured/900x520?${encodeURIComponent(q)}&sig=${sig}`;
}

function renderVerbIllustration(v){
  const el = document.getElementById("verbIllustration");
  if(!el) return;

  const c1 = String(v?.c1||"").toUpperCase();
  const esp = String(v?.esp||"").toUpperCase();
  const src = getVerbPhotoUrl(v);

  // Contenedor con caption (estilo Duolingo + identidad)
  el.innerHTML = `
    <div class="verbIllustrationInner">
      <img id="verbPhoto" alt="Imagen del verbo ${esp}" loading="lazy" referrerpolicy="no-referrer" src="${src}" />
      <div class="verbCaption" aria-hidden="true">
        <span class="verbTag">üé¨ <small>Acci√≥n:</small> ${esp}</span>
        <span class="verbTag">üá¨üáß <small>Verb:</small> ${c1}</span>
      </div>
    </div>
  `;

  // Fallback: si la foto no carga (conexi√≥n, bloqueo, etc.), mostramos el SVG con emoji
  const img = document.getElementById("verbPhoto");
  if(img){
    img.onerror = () => {
      el.innerHTML = getSpellIllustrationSVG(v);
    };
  }
}



function spellGet(col){
  if(!spellingState) return "";
  if(col===1) return spellingState.c1Opts[spellingState.i1] || "";
  if(col===2) return spellingState.c2Opts[spellingState.i2] || "";
  return spellingState.c3Opts[spellingState.i3] || "";
}
function spellSyncUI(){
  const a = document.getElementById("spellC1Val");
  const b = document.getElementById("spellC2Val");
  const c = document.getElementById("spellC3Val");
  if(a) a.textContent = spellGet(1) || "‚Äî";
  if(b) b.textContent = spellGet(2) || "‚Äî";
  if(c) c.textContent = spellGet(3) || "‚Äî";

  const fb = document.getElementById("spellFeedback");
  if(fb) fb.innerHTML = "";
}
function spellMove(col, delta){
  if(!spellingState) return;
  const wrap = (i, n) => (n ? (i+n)%n : 0);

  if(col===1){
    spellingState.i1 = wrap(spellingState.i1 + delta, spellingState.c1Opts.length);
  }else if(col===2){
    spellingState.i2 = wrap(spellingState.i2 + delta, spellingState.c2Opts.length);
  }else{
    spellingState.i3 = wrap(spellingState.i3 + delta, spellingState.c3Opts.length);
  }
  spellSyncUI();
}
function spellSpeak(col){
  const w = spellGet(col);
  if(!w) return;
  // Deletreo (letras)
  hablar(String(w).split("").join("... "));
}
function validateSpelling(){
  const v = (spellingState && spellingState.target) ? spellingState.target : (pendingVerb || current[idx]);
  if(!v) return;
  if(!canPlay()) return;

  if(!spellingState || spellingState.key !== spellKeyFor(v)){
    initSpellingState(v);
    spellingState.target = v;
    spellSyncUI();
  }

  const pick1 = String(spellGet(1)||"").trim().toLowerCase();
  const pick2 = String(spellGet(2)||"").trim().toLowerCase();
  const pick3 = String(spellGet(3)||"").trim().toLowerCase();

  const t1 = String(v.c1||"").trim().toLowerCase();
  const t2 = String(v.c2||"").trim().toLowerCase();
  const t3 = String(v.c3||"").trim().toLowerCase();

  att++;

  const ok = (pick1===t1) && (pick2===t2) && (pick3===t3);

  const fb = document.getElementById("spellFeedback");
  if(ok){
    playCorrectSound();
    streak++; corr++;

    const gained = addSpellingXP(v);
    if(gained>0) bumpMastery(v.c1, 1);

    if(fb){
      fb.innerHTML = gained
        ? `<span style="color:var(--success)">‚úÖ ¬°Perfecto! +${gained} XP</span>`
        : `<span style="color:var(--success)">‚úÖ Correcto. (XP ya sumado)</span>`;
    }
  } else {
    playWrongSound();
    recordMistake(v);

    // vidas + freeze (misma l√≥gica que validar)
    const spent = spendHeart();
    if(!spent){
      if(fb){
        fb.innerHTML = `<span style="color:var(--error)">üíî Sin vidas por ahora. Espera regeneraci√≥n.</span>`;
      }
      actualizarStats();
      return;
    }
    if(freezeTokens>0 && streak>0){
      freezeTokens -= 1;
      toastAchievement("üßä", "Streak protegida", "Usaste 1 Freeze para no perder la racha.");
    }else{
      streak = 0;
    }

    if(fb){
      fb.innerHTML = `<span style="color:var(--error)">‚ö° No coincide. Revisa C1, C2 y C3. (Vidas: ${hearts}/${MAX_HEARTS})</span>`;
    }
  }

  actualizarStats();
}

</script>

</body>
</html>
