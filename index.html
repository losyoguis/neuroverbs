<!-- âœ…âœ…âœ… GOOGLE AUTH + SHEETS BACKEND -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<div class="authBar" id="authBar">
  <div id="googleBtn" data-help="ðŸ”’ Inicia sesiÃ³n con Google para guardar tus XP y aparecer en el ranking."></div>
  <div class="userChip" id="userChip" style="display:none;">
    <img id="userPic" alt="Foto" />
    <div class="userMeta">
      <div class="userName" id="userName">Usuario</div>
      <div class="userEmail" id="userEmail">â€”</div>
    </div>
  </div>
</div>

<script>
// =========================
// Google Auth (GSI) + Sheets (Apps Script WebApp)
// =========================

// âš ï¸ IMPORTANTE: Reemplaza esta URL con la de tu Web App despuÃ©s de implementar
const DEFAULT_WEB_APP_URL = "https://script.google.com/macros/s/TU_WEB_APP_ID/exec";

const WEB_APP_URL = (new URLSearchParams(location.search).get("webapp")
  || localStorage.getItem("WEB_APP_URL")
  || DEFAULT_WEB_APP_URL);

try{ localStorage.setItem("WEB_APP_URL", WEB_APP_URL); }catch(_){}

const ALLOWED_DOMAIN = "iemanueljbetancur.edu.co";
const ALLOWED_EMAIL_SUFFIX = "@"+ALLOWED_DOMAIN;
const OAUTH_CLIENT_ID = "637468265896-5olh8rhf76setm52743tashi3vq1la67.apps.googleusercontent.com";

// Leaderboard paging
const LB_PAGE_SIZE = 10;
let __lbOffset = 0;
let __lbTotal = 0;

// XP sync guard
window.__lastXpSynced = null;
window.__suppressXpSyncUntil = 0;

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
  ).join(''));
  return JSON.parse(jsonPayload);
}

function showUserChip(profile) {
  const chip = document.getElementById("userChip");
  const pic = document.getElementById("userPic");
  const name = document.getElementById("userName");
  const email = document.getElementById("userEmail");
  if (!chip) return;

  chip.style.display = "flex";
  if (pic) {
    pic.src = profile.picture || "";
    pic.style.display = profile.picture ? "block" : "none";
  }
  if (name) name.textContent = profile.name || "Usuario";
  if (email) email.textContent = profile.email || "";
}

function hideUserChip() {
  const chip = document.getElementById("userChip");
  if (chip) chip.style.display = "none";
}

function clearSession() {
  localStorage.removeItem("google_id_token");
  localStorage.removeItem("user_profile");
  hideUserChip();
  const sec = document.getElementById("leaderboardSection");
  if (sec) sec.style.display = "none";
}

function jsonpRequest(url) {
  return new Promise((resolve, reject) => {
    const cb = "__cb_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    const timeout = setTimeout(() => {
      try { delete window[cb]; } catch(_){}
      reject(new Error("JSONP timeout"));
    }, 12000);

    window[cb] = (data) => {
      clearTimeout(timeout);
      try { delete window[cb]; } catch(_){}
      try { script.remove(); } catch(_){}
      resolve(data);
    };

    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb) + "&_=" + Date.now();
    script.onerror = () => {
      clearTimeout(timeout);
      try { delete window[cb]; } catch(_){}
      reject(new Error("JSONP load error"));
    };
    document.body.appendChild(script);
  });
}

function postToSheets(payload) {
  const body = JSON.stringify(payload);
  
  try {
    fetch(WEB_APP_URL, {
      method: "POST",
      mode: "no-cors",
      keepalive: true,
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body
    }).catch(()=>{});
  } catch(e) {}

  try {
    if (navigator.sendBeacon) {
      navigator.sendBeacon(WEB_APP_URL, new Blob([body], { type: "text/plain;charset=utf-8" }));
    }
  } catch(e) {}
}

function registrarEnSheets(idToken) {
  postToSheets({ action: "upsert", idToken, xpDelta: 0 });
}

function queueXpDelta(idToken, xpDelta) {
  if (!idToken) return;
  const delta = Number(xpDelta || 0);
  if (!Number.isFinite(delta) || delta <= 0) return;

  if (Date.now() < window.__suppressXpSyncUntil) return;

  postToSheets({ action: "upsert", idToken, xpDelta: delta });
}

async function fetchAndApplyUserFromSheets() {
  const profRaw = localStorage.getItem("user_profile");
  if (!profRaw) return;
  
  let prof;
  try { prof = JSON.parse(profRaw); } catch(_) { return; }
  if (!prof || !prof.sub) return;

  try {
    const url = WEB_APP_URL + "?action=user&sub=" + encodeURIComponent(prof.sub);
    const data = await jsonpRequest(url);
    if (!data || !data.ok || !data.user) return;

    const serverXp = Number(data.user.xp || 0);
    if (!Number.isFinite(serverXp)) return;
    applyServerXpSafely(serverXp, "user_endpoint");
  } catch (e) {
    console.warn("No pude leer XP desde Sheets:", e);
  }
}

function applyServerXpSafely(serverXp, source) {
  const sXp = Number(serverXp || 0);
  if (!Number.isFinite(sXp)) return;

  const localXp = Number(typeof xp !== "undefined" ? (xp || 0) : 0);
  if (sXp <= localXp) return;

  window.__suppressXpSyncUntil = Date.now() + 2500;
  window.__lastXpSynced = sXp;

  if (typeof xp !== "undefined") xp = sXp;

  try { persistState(); } catch (_) {}
  try { actualizarStats(); } catch (_) {}
  if (source) console.log("[XP] HUD actualizado desde servidor:", sXp, "source=", source);
}

// =========================
// Leaderboard
// =========================
function resetLeaderboardPaging() {
  __lbOffset = 0;
}

function lbPrev() {
  if (__lbOffset <= 0) return;
  __lbOffset = Math.max(0, __lbOffset - LB_PAGE_SIZE);
  cargarLeaderboardPage();
}

function lbNext() {
  const total = Number(__lbTotal || 0);
  if (total && (__lbOffset + LB_PAGE_SIZE) >= total) return;
  __lbOffset = __lbOffset + LB_PAGE_SIZE;
  cargarLeaderboardPage();
}

function cargarLeaderboard() {
  cargarLeaderboardPage();
}

function cargarLeaderboardPage() {
  const sec = document.getElementById("leaderboardSection");
  const st = document.getElementById("lbStatus");
  const list = document.getElementById("leaderboardList");
  const pageInfo = document.getElementById("lbPageInfo");

  if (sec) sec.style.display = "block";
  if (st) st.textContent = "Cargando ranking...";
  if (list) list.innerHTML = "";
  if (pageInfo) pageInfo.textContent = String(Math.floor(__lbOffset / LB_PAGE_SIZE) + 1);

  const url = WEB_APP_URL + "?action=leaderboard&limit=" + encodeURIComponent(LB_PAGE_SIZE) + "&offset=" + encodeURIComponent(__lbOffset);
  
  jsonpRequest(url).then((data) => {
    renderLeaderboard(data);
  }).catch((err) => {
    if (st) st.textContent = "No se pudo cargar el ranking. Revisa la URL / permisos del WebApp.";
    console.error(err);
  });
}

function renderLeaderboard(data) {
  const sec = document.getElementById("leaderboardSection");
  const list = document.getElementById("leaderboardList");
  const st = document.getElementById("lbStatus");
  const pageInfo = document.getElementById("lbPageInfo");
  if (!sec || !list || !st) return;

  if (!data || !data.ok) {
    sec.style.display = "block";
    st.textContent = "No se pudo cargar el ranking.";
    list.innerHTML = "";
    return;
  }

  const rows = Array.isArray(data.leaderboard) ? data.leaderboard : [];
  const total = Number(data.total || 0);
  __lbTotal = total;

  const maxOffset = total ? Math.max(0, (Math.ceil(total / LB_PAGE_SIZE) - 1) * LB_PAGE_SIZE) : 0;
  if (total && __lbOffset > maxOffset) {
    __lbOffset = maxOffset;
    cargarLeaderboardPage();
    return;
  }

  const start = rows.length ? Math.min(__lbOffset + 1, total || (__lbOffset + 1)) : 0;
  const end = rows.length ? Math.min(__lbOffset + rows.length, total || (__lbOffset + rows.length)) : 0;

  sec.style.display = "block";
  if (rows.length) {
    st.textContent = (total ? ("Participantes: " + total + " â€” mostrando " + start + "-" + end) : ("Mostrando " + start + "-" + end));
  } else {
    st.textContent = "AÃºn no hay participantes con XP. Inicia sesiÃ³n y gana XP para aparecer.";
  }

  if (pageInfo) pageInfo.textContent = String(Math.floor(__lbOffset / LB_PAGE_SIZE) + 1);

  const prevBtn = document.getElementById("lbPrevBtn");
  const nextBtn = document.getElementById("lbNextBtn");
  if (prevBtn) prevBtn.disabled = (__lbOffset <= 0);
  if (nextBtn) nextBtn.disabled = (total ? (__lbOffset + LB_PAGE_SIZE >= total) : true);

  list.innerHTML = rows.map((r, i) => {
    const rank = __lbOffset + i + 1;
    const pic = r.picture ? `<img class="lbAvatar" src="${r.picture}" alt="foto">` : `<div class="lbAvatar lbAvatarFallback">ðŸ‘¤</div>`;
    const name = (r.name || r.email || "Usuario").toString();
    const xpVal = Number(r.xp || 0);
    return `
      <div class="lbRow">
        <div class="lbRank">#${rank}</div>
        ${pic}
        <div class="lbInfo">
          <div class="lbName">${escapeHtml(name)}</div>
          <div class="lbXp">${xpVal} XP</div>
        </div>
      </div>
    `;
  }).join("");

  try {
    const prof = JSON.parse(localStorage.getItem("user_profile") || "null");
    if (prof && prof.sub && Array.isArray(rows)) {
      const me = rows.find(r => String(r.sub) === String(prof.sub));
      if (me) applyServerXpSafely(me.xp, "leaderboard_page");
    }
  } catch (_) {}
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
}

// =========================
// Google Auth init + restore session
// =========================
function onGoogleCredential(response) {
  const idToken = response.credential;
  const user = parseJwt(idToken);

  const email = String((user && user.email) || "").toLowerCase();
  if(!email.endsWith(ALLOWED_EMAIL_SUFFIX.toLowerCase())) {
    try{ toastAchievement("âš ï¸","Cuenta no permitida","Solo se permite iniciar sesiÃ³n con cuentas @"+ALLOWED_DOMAIN); }catch(e){ alert("Solo se permite iniciar sesiÃ³n con cuentas @"+ALLOWED_DOMAIN); }
    try{ 
      if(window.google && google.accounts && google.accounts.id) {
        google.accounts.id.disableAutoSelect && google.accounts.id.disableAutoSelect();
        google.accounts.id.revoke && google.accounts.id.revoke(email, ()=>{});
      } 
    }catch(e){}
    clearSession();
    return;
  }

  localStorage.setItem("google_id_token", idToken);
  localStorage.setItem("user_profile", JSON.stringify({
    sub: user.sub,
    name: user.name,
    email: user.email,
    picture: user.picture
  }));

  showUserChip({
    sub: user.sub,
    name: user.name,
    email: user.email,
    picture: user.picture
  });

  registrarEnSheets(idToken);

  const sec = document.getElementById("leaderboardSection");
  if (sec) sec.style.display = "block";
  resetLeaderboardPaging();
  cargarLeaderboardPage();
  fetchAndApplyUserFromSheets();
  
  console.log("âœ… Login exitoso:", user.email);
}

function initGoogleAuthAndSync() {
  const btn = document.getElementById("googleBtn");
  if (!btn) return;

  const token = localStorage.getItem("google_id_token");
  const profRaw = localStorage.getItem("user_profile");
  
  if (token && profRaw) {
    try {
      const prof = JSON.parse(profRaw);
      showUserChip(prof);
      const sec = document.getElementById("leaderboardSection");
      if (sec) sec.style.display = "block";
      resetLeaderboardPaging();
      cargarLeaderboardPage();
      fetchAndApplyUserFromSheets();
    } catch(_){}
  }

  try {
    if (!btn.__rendered) {
      google.accounts.id.initialize({
        client_id: OAUTH_CLIENT_ID,
        callback: onGoogleCredential,
        ux_mode: "popup",
        hosted_domain: ALLOWED_DOMAIN
      });
      
      google.accounts.id.renderButton(btn, {
        theme: "outline",
        size: "large",
        shape: "pill",
        text: "signin_with"
      });
      
      btn.__rendered = true;
    }
  } catch (err) {
    console.error("Error init Google Auth:", err);
    btn.innerHTML = '<button class="lbBtn" type="button" onclick="location.reload()">Reintentar Login</button>';
  }
}

window.addEventListener("load", () => {
  let tries = 0;
  const t = setInterval(() => {
    tries++;
    if (window.google && google.accounts && google.accounts.id) {
      clearInterval(t);
      initGoogleAuthAndSync();
    }
    if (tries > 40) clearInterval(t);
  }, 150);
});
</script>