<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Acceso • Ranking I.E Manuel J. Betancur</title>
  <style>
    :root {
      --bg1:#2b1d5e;
      --bg2:#0b1b45;
      --card:#0e1838cc;
      --border: rgba(255,255,255,.14);
      --glow: rgba(255,178,74,.35);
      --gold:#ffb24a;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background: radial-gradient(1200px 600px at 50% 20%, var(--bg1) 0%, var(--bg2) 60%, #071028 100%);
      color:var(--white);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      padding:24px 14px;
    }
    .wrap{
      width:min(980px, 100%);
      border-radius:24px;
      padding:28px 18px 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
    }
    .topline{
      width:100%;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
      margin-bottom:16px;
      opacity:.9;
    }
    .hero{
      text-align:center;
      padding:8px 10px 18px;
    }
    .trophy{
      width:116px; height:116px;
      margin:0 auto 10px;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.5));
    }
    h1{
      margin:6px 0 4px;
      font-size: clamp(28px, 5vw, 54px);
      letter-spacing: .3px;
      color: var(--gold);
      text-shadow: 0 8px 30px var(--glow);
    }
    h2{
      margin:0 0 10px;
      font-size: clamp(20px, 3.4vw, 40px);
      letter-spacing: .3px;
      color: var(--gold);
      text-shadow: 0 8px 30px var(--glow);
    }
    .sub{
      margin:0;
      font-weight:800;
      font-size: clamp(14px, 2.2vw, 20px);
      opacity:.98;
    }

    .card{
      margin-top:18px;
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      min-height:92px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    #status {
      margin-top:14px;
      text-align:center;
      font-weight:700;
      opacity:.92;
    }
    .hint {
      margin-top:6px;
      text-align:center;
      font-size:13px;
      opacity:.75;
      line-height:1.35;
    }

    .pill {
      display:none;
      margin-top:12px;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      width: fit-content;
      margin-left:auto;
      margin-right:auto;
    }
    .pill img{ width:30px; height:30px; border-radius:50%; }
    .pill .meta{ display:flex; flex-direction:column; line-height:1.1; }
    .pill .name{ font-weight:900; font-size:14px; }
    .pill .email{ font-weight:800; font-size:12px; opacity:.9; }
    .spin {
      display:inline-block;
      width:14px; height:14px;
      border:2px solid rgba(255,255,255,.35);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation: s 0.9s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes s { to { transform: rotate(360deg); } }
    .err { color: #ffd4d4; }
    .ok  { color: #d8ffea; }
  </style>
</head>
<body>
  <main class="wrap" role="main" aria-label="Acceso al Ranking">
    <div class="topline"></div>

    <section class="hero">
      <!-- Icono trofeo en SVG (sin dependencias) -->
      <svg class="trophy" viewBox="0 0 128 128" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#ffd27a"/>
            <stop offset="0.45" stop-color="#ffb24a"/>
            <stop offset="1" stop-color="#d8921f"/>
          </linearGradient>
        </defs>
        <path fill="url(#g)" d="M64 12c10 0 18 8 18 18v8h18c4 0 8 3 8 8v6c0 16-10 30-25 35-3 9-10 16-19 18v9h14c5 0 9 4 9 9v3H41v-3c0-5 4-9 9-9h14v-9c-9-2-16-9-19-18C30 82 20 68 20 52v-6c0-5 4-8 8-8h18v-8c0-10 8-18 18-18zm-28 34H28v6c0 10 6 19 15 23 0-2 1-4 1-6-4-2-8-7-8-12v-11zm64 0h-8v11c0 5-4 10-8 12 0 2 1 4 1 6 9-4 15-13 15-23v-6z"/>
        <path fill="rgba(0,0,0,.18)" d="M64 12c10 0 18 8 18 18v8h18c4 0 8 3 8 8v6c0 16-10 30-25 35-3 9-10 16-19 18v9h14c5 0 9 4 9 9v3H41v-3c0-5 4-9 9-9h14v-9c-9-2-16-9-19-18C30 82 20 68 20 52v-6c0-5 4-8 8-8h18v-8c0-10 8-18 18-18z" opacity=".08"/>
      </svg>

      <h1>Ranking</h1>
      <h2>I.E Manuel J. Betancur</h2>
      <p class="sub">Acceder con <strong>@iemanueljbetancur.edu.co</strong></p>
    </section>

    <section class="card" aria-label="Inicio de sesión">
      <div id="googleBtn"></div>
    </section>

    <div class="pill" id="userPill">
      <img id="userPic" alt="Foto de perfil" />
      <div class="meta">
        <div class="name" id="userName">Usuario</div>
        <div class="email" id="userEmail">—</div>
      </div>
    </div>

    <div id="status">Listo para iniciar sesión.</div>
    <div class="hint">
      Si tu cuenta no es institucional, el acceso será rechazado.<br/>
      Al iniciar sesión correctamente, te redirecciona a: <strong> La app web NEUROVERBS</strong>
    </div>
  </main>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    const CLIENT_ID = '637468265896-5olh8rhf76setm52743tashi3vq1la67.apps.googleusercontent.com';
    const TARGET = 'https://losyoguis.github.io/neuroverbs/';
    const ALLOWED_DOMAIN = "iemanueljbetancur.edu.co";

    const statusEl = document.getElementById("status");
    const userPill = document.getElementById("userPill");
    const userPic  = document.getElementById("userPic");
    const userName = document.getElementById("userName");
    const userEmail= document.getElementById("userEmail");

    function setStatus(text, cls) {
      statusEl.className = cls || "";
      statusEl.innerHTML = text;
    }

    function decodeJwtPayload(jwt) {
      const part = jwt.split(".")[1];
      const b64 = part.replace(/-/g, "+").replace(/_/g, "/");
      const json = decodeURIComponent(atob(b64).split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join(""));
      return JSON.parse(json);
    }

    function handleCredentialResponse(response) {
      try {
        const idToken = response.credential;
        const payload = decodeJwtPayload(idToken);
        const email = (payload.email || "").toLowerCase();

        if (!email.endsWith("@" + ALLOWED_DOMAIN)) {
          userPill.style.display = "none";
          setStatus("❌ Esta cuenta no es institucional. Usa tu correo <b>@"+ALLOWED_DOMAIN+"</b>.", "err");
          if (window.google && google.accounts && google.accounts.id) {
            google.accounts.id.disableAutoSelect();
          }
          return;
        }

        userEmail.textContent = email;
        userName.textContent = payload.name || "Estudiante";
        if (payload.picture) userPic.src = payload.picture;
        userPill.style.display = "flex";

        setStatus('<span class="spin"></span>Acceso correcto. Redireccionando…', "ok");

        // ✅ Enviar token en el HASH (no se envía al servidor)
        const next = TARGET + "#id_token=" + encodeURIComponent(idToken) + "&src=mjb";
        setTimeout(() => window.location.replace(next), 800);
      } catch (e) {
        console.error(e);
        setStatus("❌ No se pudo procesar el inicio de sesión. Revisa la consola.", "err");
      }
    }

    window.addEventListener("load", () => {
      const wait = () => {
        if (!(window.google && google.accounts && google.accounts.id)) {
          return setTimeout(wait, 50);
        }

        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: handleCredentialResponse,
          ux_mode: "popup",
          auto_select: false,
          itp_support: true,
        });

        google.accounts.id.renderButton(
          document.getElementById("googleBtn"),
          {
            theme: "outline",
            size: "large",
            text: "signin_with",
            shape: "pill",
            width: 260
          }
        );
      };
      wait();
    });
  </script>
</body>
</html>
